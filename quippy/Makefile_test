# HQ XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
# HQ X
# HQ X   quippy: Python interface to QUIP atomistic simulation library
# HQ X
# HQ X   Copyright James Kermode 2017
# HQ X
# HQ X   These portions of the source code are released under the GNU General
# HQ X   Public License, version 2, http://www.gnu.org/copyleft/gpl.html
# HQ X
# HQ X   If you would like to license the source code under different terms,
# HQ X   please contact James Kermode, james.kermode@gmail.com
# HQ X
# HQ X   When using this software, please cite the following reference:
# HQ X
# HQ X   http://www.jrkermode.co.uk/quippy
# HQ X
# HQ XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX

####### NOTES
# original Makefile taken from branch hackathon-f90wrap




# default to be overridden by site-specific config
QUIPPY_INSTALL_DIR = ${HOME}/anaconda2/lib/python2.7/site-packages

# include other makefiles and export env variables
export QUIP_ARCH

ifeq (${QUIP_ROOT},)
QUIP_ROOT=${PWD}/..
endif
include Makefile.${QUIP_ARCH}
include ${BUILDDIR}/Makefile.inc
include Makefile.rules

# working on python3
PYTHON := python

QUIPPY_SRC_DIR := ../../quippy

FPP = gfortran -E -cpp
CFLAGS = -fPIC


LIBATOMS_SOURCES =  Atoms_types.f95 Atoms.f95
#POT_SOURCES =  Potential.f95

LIBATOMS_FILES = $(addprefix ../../src/libAtoms/,${LIBATOMS_SOURCES})
#POT_FILES = $(addprefix ../../src/Potentials/,${POT_SOURCES})

WRAP_SOURCES = ${LIBATOMS_SOURCES} ${POT_SOURCES}
WRAP_FILES = ${LIBATOMS_FILES} ${POT_FILES}

WRAP_FPP_FILES = $(addsuffix .fpp,$(basename ${WRAP_SOURCES}))

F90WRAP_FILES = $(addsuffix .f90,$(addprefix f90wrap_,$(basename ${WRAP_SOURCES}))) #f90wrap_toplevel.f90

F2PY_LINK_ARGS = $(shell python -c 'import sys; print " ".join([arg for arg in sys.argv if arg.startswith("-l") or arg.startswith("-L")])' ${SYSLIBS} ${QUIPPY_LDFLAGS})

###

.PHONY: build clean install

build: _quippy.so

clean:
	-rm _castep.so ${F90WRAP_FILES} ${WRAP_FPP_FILES}
	-rm -r castep
	-rm -r f90wrap_*.o
	-rm -rf src.*

${WRAP_FPP_FILES}: ${WRAP_FILES}
	for f in ${WRAP_FILES}; do \
	  ${FPP} $$f > $$(basename $${f%.*}).fpp ; \
	done

_quippy.so: ${WRAP_FPP_FILES}
	-rm -r quippy
	mkdir quippy
	cp -r ${QUIPPY_SRC_DIR}/quippy/* quippy
	f90wrap -v -m quippy ${WRAP_FPP_FILES} -P \
	   -a c_error_abort --init-file ${QUIPPY_SRC_DIR}/init.py  --move-methods \
		 --shorten-routine-names -k ${QUIPPY_SRC_DIR}/KIND_MAP -s ${QUIPPY_SRC_DIR}/STRING_LENGTHS -S 10240 \
		 --skip atoms_finalise atoms_shallowcopy atoms_initialise_ptr \
#atoms_shallowcopy \
################# atoms_finalise \
###atoms_finalise_ptr \
#atoms_finalise_multi \
#atoms_assignment \
###atoms_copy_without_connect \
#atoms_select \
#atoms_remove_property \
###atoms_set_param_value_int \
#atoms_set_param_value_int_a \
#atoms_set_param_value_real \
#atoms_set_param_value_real_a \
###atoms_set_param_value_real_a2 \
#atoms_set_param_value_logical \
#atoms_set_param_value_str \
#atoms_get_param_value_int \
##atoms_get_param_value_int_a \
#atoms_get_param_value_real \
#atoms_get_param_value_real_a \
#atoms_get_param_value_real_a2 \
#atoms_get_param_value_str \
#atoms_get_param_value_es \
#atoms_get_param_value_logical \
#atoms_set_cutoff_minimum \
#atoms_set_cutoff \
#atoms_zero \
#atoms_set_lattice \
#atoms_set_atoms_singlez \
#atoms_set_atoms \
#add_atom_single \
#add_atom_multiple \
#atoms_join \
#remove_atom_single \
#atoms_shuffle \
#remove_atom_multiple \
#remove_atom_multiple_mask \
#atoms_map_into_cell \
#atoms_unskew_cell \
#set_map_shift \
#get_lattice_params \
#directionality \
#atoms_print \
#parse_atom_mask \
#property_to_list \
#list_to_property \
#list_matching_prop \
#complement \
#difference \
#coalesce_in_one_periodic_image \
#atoms_bcast \
#atoms_filter_cone \
#atoms_copy_properties \
#atoms_sort_by_rindex \
#atoms_transform_basis \
#atoms_rotate \
#atoms_calc_connect_hysteretic \
#atoms_calc_connect \
#atoms_calc_dists \
#atoms_set_comm_property \
#atoms_set_Zs \
#undo_pbc_jumps \
#undo_CoM_motion \
#calc_msd \
#fake_smooth_pos \

	f2py-f90wrap --build-dir . -c -m _quippy ${F90WRAP_FILES} ${F2PY_LINK_ARGS} \
		 -L. -lquip --link-lapack

install: build
	QUIPPY_INSTALL_DIR=/home/tks32/.local/lib/python3.6/site-packages
	cp -r quippy ${QUIPPY_INSTALL_DIR}
	cp _quippy.so ${QUIPPY_INSTALL_DIR}
