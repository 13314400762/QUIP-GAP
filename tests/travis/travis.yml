language: python
dist: trusty
sudo: required
env:
  global:
    secure: "Y5dAhnGQrytV8tJX1oCQMVqAQ2LJIXilFJCgvBMxfaJrs3tORf0gRCKiG7RmUnfWrJtweKkHlXUf4oBWdfg8cCL2rqw3iwun+AV8GY70jd2zUpegv39I5AoLda+BoFaFWYkpdq5jgrFs/DmBgGGZ14dGiIljsAS02MRcGMwxBMg="

python:
  - 2.7

install:
  # Always linux
  - export QUIP_ARCH=linux_x86_64_gfortran_openmp
  - echo ${QUIP_ARCH}
  # VANILLA on each push only no CRON any more
  # - use latest gfrtran
  # - runs everything with openmp only
  # - builds DOCS
  #
  #
      
  # Installing deps takes 10+ mins on a slow day. Only install for running
  # builds.
  # Requires 'sudo' on Travis; i.e. not compatible with container builds.
  # pandoc is required for nbconvert in docs; gsl and xpm are for atomeye.
  - sudo add-apt-repository -y "ppa:ubuntu-toolchain-r/test";
  - sudo apt-get -yq update;
  - sudo apt-get install -y gfortran
                            liblapack-dev
                            libblas-dev
                            python-numpy
                            openmpi-bin
                            libopenmpi-dev
                            netcdf-bin
                            libnetcdf-dev
                            libhdf5-serial-dev
                            pandoc
                            libgsl0-dev
                            libxpm-dev;

  # Deal with deps (GAP...); should only run with cron, so no failures
  - echo "Pulling deps";
  - openssl aes-256-cbc -K $encrypted_73ca9e4f056f_key -iv $encrypted_73ca9e4f056f_iv -in tests/travis/get_deps.sh.enc -out get_deps.sh -d;
  - bash get_deps.sh > /dev/null 2>&1;

  # Make the build directory manually for rules
  - mkdir -p build/${QUIP_ARCH}
  # Copy the rules file (rather than make config)
  - cp tests/rules/${BUILD}_Makefile.${QUIP_ARCH}.inc build/${QUIP_ARCH}/Makefile.inc
  # Compile QUIP, libquip and quippy, if a non-skipped build.
  # stdout is redirected as it generates too much output.
  - gfortran --version;
  - gcc --version;
  - g++ --version;
  - make > /dev/null;
  - make libquip > /dev/null;
  - make quippy > /dev/null;

script:
  # Sometimes file limit is 64000 and read_loop reads and writes this many
  # files causing the build to time out
  - ulimit -n 256
  # Install ASE from PyPI as GitLab is unreliable for pulling git master.
  # Quippy should have built successfully -> start tests
  - python --version
  - pip install ase
  - pip freeze --all
  - make test

# Public and private docker images with GAP, pushed from here
# Strip ThirdParty from the public image
jobs:
  include:      
    - stage: docs
      script:
        - tests/travis/build_docs.sh

    - stage: docker
      install: skip
      script:
        - if [ "${TRAVIS_REPO_SLUG}" == "libAtoms/QUIP" ] && [ "${TRAVIS_BRANCH}" == "public" ] && [ "${TRAVIS_PULL_REQUEST}" == "false" ]; then
            openssl aes-256-cbc -K $encrypted_73ca9e4f056f_key -iv $encrypted_73ca9e4f056f_iv -in tests/travis/get_deps.sh.enc -out get_deps.sh -d;
            bash get_deps.sh > /dev/null 2>&1;
            bin/gitversion > GIT_VERSION;
            bin/gapversion.sh > src/GAP/GAP_VERSION;
            rm -rf src/ThirdParty;
            docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD";
            ln -s docker/Dockerfile.gap Dockerfile;
            docker build -t $DOCKER_USERNAME/quip .;
            docker push $DOCKER_USERNAME/quip;
          fi


notifications:
  email:
    - quip-developers@eng.cam.ac.uk

