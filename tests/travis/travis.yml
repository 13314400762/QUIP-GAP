language: python
dist: trusty
sudo: required
git:
  depth: false
env:
  matrix:
    - BUILD=VANILLA
  global:
    secure: "Y5dAhnGQrytV8tJX1oCQMVqAQ2LJIXilFJCgvBMxfaJrs3tORf0gRCKiG7RmUnfWrJtweKkHlXUf4oBWdfg8cCL2rqw3iwun+AV8GY70jd2zUpegv39I5AoLda+BoFaFWYkpdq5jgrFs/DmBgGGZ14dGiIljsAS02MRcGMwxBMg="
python:
  - 3.6
install:
  - export QUIP_ARCH=linux_x86_64_gfortran${PAR+_${PAR}}
  - echo ${QUIP_ARCH}
  - sudo add-apt-repository -y "ppa:ubuntu-toolchain-r/test";
  - sudo apt-get -yq update;
  - sudo apt-get install -y gfortran liblapack-dev libblas-dev python-numpy libhdf5-serial-dev
  - pip install ase
  # install f90wrap
  - sudo apt-get install -y python-scipy
  - cd src/f90wrap
  - python setup.py install
  - cd ../../
  # Make the build directory manually for rules
  - mkdir -p build/${QUIP_ARCH}
  # Copy the rules file (rather than make config)
  #- cp tests/rules/${BUILD}_Makefile.${QUIP_ARCH}.inc build/${QUIP_ARCH}/Makefile.inc
  - cp tests/rules/py3_test.inc build/${QUIP_ARCH}/Makefile.inc
    
  # only install quippy as on the computer
  
  # Deal with deps (GAP...) --- copied from old verison without if statement
  - echo "Pulling deps";
  - openssl aes-256-cbc -K $encrypted_73ca9e4f056f_key -iv $encrypted_73ca9e4f056f_iv -in tests/travis/get_deps.sh.enc -out get_deps.sh -d;
  - bash get_deps.sh > /dev/null 2>&1

  # The actual work
  - make quippy 2>&1
  
  # test if the test run with the result
  - cd tests
  - python --version
  - python run_all.py
  - cd ../


    #  # Deal with deps (GAP...); should only run with cron, so no failures
    #- if [ "${BUILD}" == "ALL" ] && [ "${RUN}" == "true" ]; then
    #  echo "Pulling deps";
    #  openssl aes-256-cbc -K $encrypted_73ca9e4f056f_key -iv $encrypted_73ca9e4f056f_iv -in tests/travis/get_deps.sh.enc -out get_deps.sh -d;
    #  bash get_deps.sh > /dev/null 2>&1;

