# HQ XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
# HQ X
# HQ X   quippy: Python interface to QUIP atomistic simulation library
# HQ X
# HQ X   Copyright James Kermode 2019
# HQ X
# HQ X   These portions of the source code are released under the GNU General
# HQ X   Public License, version 2, http://www.gnu.org/copyleft/gpl.html
# HQ X
# HQ X   If you would like to license the source code under different terms,
# HQ X   please contact James Kermode, james.kermode@gmail.com
# HQ X
# HQ X   When using this software, please cite the following reference:
# HQ X
# HQ X   http://www.jrkermode.co.uk/quippy
# HQ X
# HQ XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX

import unittest
import os

import xml.etree.ElementTree as ET

import numpy as np
import quippytest

from quippy.potential import Potential
from ase.constraints import voigt_6_to_full_3x3_stress
from ase.io import read

# fixed set of sparse points for training
sparse_points = [
    1, 2, 3, 4, 5, 8, 13, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 29, 30, 
    33, 34, 35, 36, 37, 38, 43, 44, 46, 47, 48, 49, 50, 51, 53, 54, 57, 61, 62,
    63, 64, 65, 66, 68, 70, 71, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 84, 85, 
    86, 89, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 107, 108, 109, 110,
    111, 113, 114, 116, 117, 120, 123, 124, 125, 126, 127, 128, 129, 132, 133, 134, 
    137, 142, 143, 144, 145, 146, 147, 148, 149, 150, 151, 152, 154, 155, 156, 157, 
    158, 159, 161, 163, 164, 167, 168, 169, 181, 182, 183, 185, 187, 190, 192, 194, 
    195, 196, 197, 205, 207, 210, 217, 218, 225, 233, 238, 249, 254, 256, 262, 274, 
    286, 288, 294, 297, 303, 311, 312, 316, 317, 321, 333, 336, 338, 345, 346, 352, 
    369, 371, 373, 377, 378, 381, 383, 384, 396, 397, 406, 409, 411, 416, 420, 424, 
    427, 437, 438, 442, 447, 449, 462, 466, 474, 476, 481, 482, 485, 487, 490, 492, 
    502, 503, 504, 506, 509, 511, 515, 525, 527, 532, 541, 550, 553, 554, 556, 557, 
    559, 566, 567, 570, 571, 573, 574, 576, 577, 581, 593, 594, 595, 596, 597, 598, 
    599, 600, 601, 603, 606, 608, 611, 612, 615, 617, 648, 652, 656, 659, 663, 665, 
    672, 673, 675, 676, 682, 683, 684, 685, 693, 701, 705, 721, 725, 726, 728, 738, 
    742, 743, 744, 757, 765, 766, 767, 774, 775, 785, 794, 797, 805, 810, 812, 817, 
    818, 819, 820, 821, 822, 823, 824, 825, 826, 827, 828, 829, 830, 831, 832, 833, 
    834, 835, 836, 837, 838, 839, 840, 841, 842, 843, 844, 845, 846, 847, 848, 849, 
    851, 852, 853, 854, 855, 856, 857, 858, 859, 860, 861, 862, 863, 864, 865, 866, 
    867, 868, 869, 870, 871, 872, 873, 874, 875, 876, 877, 878, 879, 880, 881, 882, 
    883, 884, 885, 887, 888, 889, 890, 891, 892, 893, 894, 895, 896, 897, 899, 901, 
    902, 903, 904, 905, 907, 908, 909, 910, 911, 912, 913, 917, 918, 923, 929, 931, 
    933, 934, 938, 945, 947, 949, 952, 955, 956, 958, 962, 963, 969, 974, 975, 976, 
    977, 980, 982, 983, 984, 991, 993, 1005, 1007, 1009, 1012, 1013, 1016, 1018, 1020, 
    1021, 1023, 1024, 1025, 1026, 1028, 1035, 1036, 1039, 1041, 1044, 1046, 1048, 1051, 
    1054, 1055, 1060, 1074, 1076, 1081, 1083, 1085, 1088, 1091, 1094, 1096, 1097, 1100,
    1101, 1105, 1106, 1109, 1113, 1114, 1119, 1122, 1124, 1126, 1127, 1128, 1129, 1130,
    1132, 1139, 1147, 1152, 1154, 1162, 1176, 1177, 1182, 1183, 1194, 1195, 1196, 1197, 
    1198, 1199, 1200, 1201, 1202, 1203, 1204, 1205, 1206, 1207, 1208, 1210, 1211, 1212, 
    1213, 1214, 1215, 1216, 1217, 1219, 1221, 1222, 1223, 1224, 1225, 1227, 1228, 1229,
    1230, 1231, 1232, 1234, 1235, 1236, 1237, 1238, 1239, 1240, 1241, 1242, 1243, 1245, 
    1246, 1247, 1248, 1249, 1250, 1251, 1252, 1253, 1254, 1255, 1256, 1257, 1259, 1260, 
    1261, 1262, 1263, 1264, 1266, 1267, 1271, 1273, 1274, 1275, 1277, 1278, 1279, 1280, 
    1281, 1282, 1283, 1284, 1285, 1286, 1287, 1288, 1289, 1290, 1294, 1295, 1296, 1297, 
    1298, 1299, 1300, 1301, 1305, 1306, 1307, 1308, 1309, 1310, 1313, 1314, 1316, 1317, 
    1318, 1320, 1321, 1322, 1323, 1324, 1329, 1330, 1331, 1333, 1334, 1339, 1340, 1341, 
    1342, 1343, 1348, 1349, 1354, 1361, 1363, 1365, 1368, 1369, 1373, 1381, 1386, 1391, 
    1392, 1398, 1399, 1402, 1403, 1407, 1411, 1413, 1414, 1421, 1423, 1424, 1427, 1429,
    1430, 1434, 1437, 1451, 1452, 1453, 1456, 1459, 1460, 1462, 1465, 1466, 1470, 1471,
    1475, 1477, 1479, 1484, 1488, 1490, 1499, 1501, 1502, 1506, 1507, 1508, 1513, 1516,
    1517, 1520, 1521, 1526, 1528, 1542, 1544, 1546, 1548, 1551, 1553, 1563, 1570, 1571,
    1575, 1579, 1582, 1584, 1597, 1598, 1601, 1603, 1607, 1622, 1631, 1633, 1647, 1653,
    1655, 1659, 1660, 1677, 1692, 1694, 1703, 1704, 1705, 1722, 1743, 1744, 1747, 1748,
    1750, 1755, 1756, 1758, 1759, 1760, 1762, 1763, 1764, 1766, 1767, 1768, 1769, 1770,
    1771, 1772, 1773, 1774, 1775, 1776, 1777, 1778, 1779, 1781, 1782, 1783, 1784, 1785,
    1786, 1787, 1788, 1789, 1790, 1791, 1792, 1793, 1794, 1795, 1796, 1797, 1799, 1800,
    1801, 1802, 1803, 1804, 1805, 1807, 1808, 1809, 1810, 1812, 1813, 1814, 1815, 1816,    
    1818, 1819, 1820, 1821, 1824, 1825, 1827, 1828, 1829, 1830, 1831, 1832, 1833, 1835, 
    1836, 1837, 1838, 1839, 1840, 1841, 1843, 1845, 1846, 1847, 1848, 1849, 1850, 1851, 
    1853, 1854, 1855, 1873, 1879, 1886, 1892, 1895, 1896, 1901, 1903, 1913, 1921, 1922, 
    1923, 1925, 1932, 1943, 1951, 1965, 1975, 1978, 1980, 2004, 2015, 2017, 2019, 2020, 
    2021, 2025, 2028, 2031, 2034, 2043, 2046, 2047, 2049, 2050, 2054, 2061, 2067, 2068, 
    2069, 2072, 2073, 2075, 2076, 2077, 2079, 2081, 2084, 2086, 2088, 2090, 2092, 2093, 
    2094, 2095, 2097, 2099, 2106, 2108, 2109, 2110, 2111, 2113, 2114, 2116, 2117, 2118, 
    2122, 2123, 2124, 2125, 2126, 2127, 2128, 2129, 2130, 2131, 2132, 2133, 2135, 2144, 
    2145, 2146, 2147, 2148, 2149, 2151, 2152, 2158, 2161, 2163, 2164, 2165, 2166, 2168, 
    2169, 2170, 2171, 2176, 2177, 2179, 2181, 2185, 2186, 2189, 2191, 2192, 2195, 2196, 
    2197, 2202, 2205, 2206, 2209, 2210, 2211, 2213, 2217, 2218, 2219, 2220, 2221, 2224, 
    2231, 2233, 2234, 2235, 2236, 2237, 2238, 2239, 2240, 2246, 2248, 2249, 2251, 2253, 
    2255, 2256, 2257, 2259, 2267, 2273, 2274, 2289, 2292, 2296, 2303, 2305, 2306, 2307, 
    2308, 2319, 2326, 2329, 2330, 2332, 2333, 2334, 2335, 2346, 2349, 2354, 2357, 2362, 
    2365, 2374, 2379, 2388, 2397, 2398, 2401, 2403, 2404, 2405, 2406, 2407, 2408, 2409, 
    2410, 2411, 2413, 2416, 2422, 2424, 2426, 2429, 2434, 2437, 2448, 2454, 2455, 2456, 
    2459, 2460, 2461, 2463, 2464, 2469, 2474, 2476, 2478, 2481, 2482, 2484, 2489, 2491, 
    2494, 2495, 2499, 2503, 2504, 2508, 2513, 2517, 2520, 2522, 2524, 2525, 2531, 2534, 
    2535, 2536, 2538, 2549, 2552, 2553, 2555, 2556, 2563, 2565, 2566, 2567, 2568, 2569, 
    2570, 2578, 2585, 2587, 2589, 2591, 2593, 2596, 2598, 2600, 2605, 2609, 2610, 2612, 
    2613, 2617, 2619
]


# expected fit coefficients
alpha_ref = np.array(
      [-1.62354771e-02, -9.29376918e+01, -9.86470668e+02, -2.01124802e+02,
       -2.87890548e+01,  2.08473717e+03,  4.74389020e+02, -2.00184188e+02,
       -5.32847208e+02,  2.13520692e+02, -2.68482107e+02, -6.41435611e+02,
       -4.07662274e+02,  1.85487609e+02, -1.53403798e+03,  7.39583027e+03,
        2.60437575e+02,  5.64402921e+03, -5.58372550e+03, -8.83235387e+01,
       -8.76610371e+01, -7.52979654e+01,  3.75805641e+01, -7.61783277e+01,
       -5.56867924e+02,  2.61168743e+02, -5.89860126e+02, -2.00250466e+03,
       -3.16280226e+02,  8.79993067e+02,  6.03447906e+02,  3.11727183e+01,
       -1.83239654e+02,  5.31393349e+02, -1.82406060e+02,  5.87219566e+01,
        5.65004962e+02,  1.32223815e+04, -1.20741689e+02, -3.15202406e+02,
       -4.37145297e+02,  2.22670485e+02,  1.67755705e+02, -1.23177146e+02,
        6.43174451e+02, -1.24298876e+04,  3.61553461e+03,  1.47281301e+03,
       -4.48458775e+01,  5.57116811e+01,  4.20378515e+02,  1.15973448e+02,
        3.72503404e+01,  1.11092365e+02,  8.97769883e+01,  7.69143589e+01,
       -5.18977392e+02,  2.34895128e+03, -4.07946039e+02, -7.95121378e+03,
        5.82782830e+01,  9.26109146e+02, -2.68087228e+02,  3.96879869e+02,
        6.54115453e+01, -2.35186528e+02, -9.93309893e-01, -3.09587352e+02,
       -3.61282542e+02, -1.73003861e+01,  3.94287766e+01, -9.01504355e+02,
       -3.25919309e+02, -5.34214838e+02, -1.41720815e+02, -5.37943016e+02,
        4.06701058e+02, -2.58294194e+02, -1.59465626e+02, -3.44609220e+01,
       -3.46353421e+02, -2.53672270e+02,  5.03023808e+02,  4.07913637e+02,
        3.91442364e+02,  1.79079241e+02, -3.04849117e+02,  5.18437065e+02,
        3.24544369e+02,  4.16995666e+02,  1.69870862e+03,  2.59073809e+02,
        1.05271008e+03,  1.68742449e+02,  4.24897405e+02,  2.30375813e+02,
        1.83476147e+02, -3.46181127e+02,  3.99004765e+02,  4.04622940e+02,
       -1.24262424e+02,  2.36245531e+02, -2.38129934e+02, -9.22573827e+02,
       -6.91424148e+02, -3.52646179e+02,  1.34271067e+03,  4.83667740e+02,
        8.68790079e+02, -8.31532495e+02, -6.46016423e+02,  6.65292909e+02,
       -2.11149800e+03,  4.06563499e+03,  1.38152802e+03,  5.15583455e+03,
       -1.89689895e+03, -1.19897293e+04,  3.22807421e+03,  4.22095361e+03,
       -9.39346949e+03,  3.90683083e+03, -1.81063175e+04,  1.26734284e+04,
       -6.27738929e+03,  3.93017407e+03,  1.55269916e+03,  1.92296449e+03,
        1.03754387e+04, -6.62994939e+03,  9.19088131e+03, -4.25419207e+02,
       -1.52879502e+03,  1.02548653e+02, -6.35947997e+02,  2.79001254e+02,
        9.77154340e+02, -1.17764337e+04, -5.08993359e+03, -2.39433342e+03,
       -1.04392356e+03, -2.33169915e+03,  4.10436097e+03, -3.45666013e+03,
        1.49027767e+02,  2.62033158e+03, -1.82156983e+04, -1.14452465e+03,
        4.31935831e+03,  6.24271047e+03, -1.14431296e+03,  8.74636467e+03,
       -9.14387267e+03,  1.33829235e+03,  4.55080170e+03, -3.45048691e+03,
        6.13580834e+03,  3.35208988e+03,  1.14229220e+03,  5.27501142e+03,
       -5.55016430e+02, -1.26638333e+04, -9.95187211e+03,  4.87416947e+03,
       -1.33561967e+03,  7.46985925e+00,  5.11651961e+03,  1.97206556e+04,
        5.88459977e+03, -6.01540360e+03,  1.01265089e+04,  2.31377753e+03,
       -2.45452460e+03,  1.68857029e+04,  1.02541463e+04, -8.52930858e+03,
       -2.53329515e+01,  2.37663022e+02, -1.50716025e+03,  5.33337322e+02,
       -1.45127299e+03,  3.99472862e+02,  5.01005179e+02, -1.91743396e+02,
       -1.47566667e+03, -2.83230587e+03,  6.54276287e+02,  2.03709316e+03,
       -1.59096174e+03,  9.39024171e+02,  2.83681487e+02,  8.00636157e+02,
       -1.28055440e+02,  3.24328546e+03,  2.33692143e+03, -1.56407053e+02,
       -6.56430523e+02, -2.23521329e+03, -1.01911553e+03,  1.07451458e+03,
        2.09557333e+03, -3.52334359e+02, -2.45870468e+03,  7.82645371e+02,
        1.39392204e+03,  3.82499493e+01,  7.39394584e+02,  2.71378209e+03,
       -4.64280137e+02,  1.76452324e+03, -7.47581749e+02, -3.80660972e+03,
       -1.29036937e+02,  1.04969400e+03, -2.14630244e+03, -2.09938589e+02,
       -1.09285372e+02, -3.23810363e+01, -1.54053735e+02,  1.10917351e+02,
        3.36808706e+02,  3.34228893e+02,  4.64776495e+01, -1.93996574e+02,
       -7.22038417e+02,  3.28419109e+03, -1.38550770e+04, -3.86863924e+03,
       -1.46010795e+04, -7.51582495e+03, -2.92004763e+03,  3.00519717e+02,
        2.70352352e+03, -9.83540314e+03, -1.28726968e+04, -1.00197662e+04,
        1.23349714e+03,  1.53597669e+02, -2.28379961e+02,  2.02078064e+03,
        7.69730859e+03,  2.64519418e+03, -6.10038815e+01, -2.16893485e+03,
        4.51992300e+03, -2.11770189e+03, -7.91904960e+02, -5.65195545e+03,
        1.73530810e+03, -9.07754744e+02,  7.71767795e+02,  2.68592346e+03,
        1.77973804e+04, -1.09773865e+04,  1.22576194e+04,  1.77438557e+04,
        1.04175572e+04,  6.22128255e+01,  5.61856754e+02, -5.22825369e+03,
        6.01892337e+03,  6.54968500e+03, -3.80780438e+03,  1.21406145e+02,
        3.69215240e+03, -2.03855203e+03,  1.11101421e+04, -1.46902609e+01,
        9.27736928e+01, -7.27518525e+00, -8.75363027e+01,  2.35847389e+02,
        5.65216440e+01,  5.75191499e+01, -2.40761855e+01,  1.08643537e+02,
       -2.76278506e+02, -8.71448848e+01, -2.47634046e+02,  9.60296770e+00,
        1.13193599e+02,  7.62188503e+01, -1.92107739e+02, -1.33922103e+01,
        2.93963183e+01,  9.34411265e+02,  7.53172636e+00,  3.15974300e+02,
        1.70976365e+02,  5.55027313e+02,  5.60302999e+01, -1.88326272e+02,
       -2.38702093e+02,  1.12978028e+01, -2.10467320e+02, -2.24501665e+02,
       -1.14633268e+02, -3.51273234e+02,  5.10541624e+02,  1.48608055e+02,
       -2.93495786e+01,  5.64747703e+02, -4.60474896e+01,  4.10354459e+02,
        8.56809016e+01, -7.51969208e+01,  8.12144579e+01, -1.84439690e+01,
        3.28511221e+02,  1.36568737e+02,  1.59205703e+02,  5.24269979e+02,
        1.95076032e+02, -8.09902037e+00, -1.85386248e+02, -2.03619513e+02,
        8.00666012e+01,  3.13846349e+02,  8.49014547e+01,  8.13786490e+01,
        1.24764811e+02, -3.70617216e+02, -1.29396257e+02,  2.53837975e+01,
       -1.16013162e+02,  1.34232800e+00,  4.03932621e+02,  1.12999233e+02,
        1.44429966e+01,  1.88162381e+02, -4.47351683e+02,  2.38717867e+01,
       -2.28289665e+01, -1.53797691e+02,  6.31495765e+01,  1.90673118e+02,
       -3.30191885e+01, -1.28280504e+02,  5.42745443e+02, -7.76903935e+01,
       -1.14410366e+03,  8.69583538e+00,  1.35063242e+02,  1.33689455e+03,
        1.93668110e+02,  2.13382932e+03,  3.66464609e+01,  4.05479620e+01,
        1.42619394e+02,  4.42642319e+01,  7.55651281e+01, -1.31812253e+00,
       -2.50800416e+03, -2.03140634e+01, -4.24276066e+01, -1.17541672e+02,
       -6.06476951e+01,  2.04383664e+01, -2.52007033e+01, -2.75161536e+03,
        7.64221869e+03, -3.45274191e+03, -8.28424213e+03, -2.58377226e+03,
        8.81228667e+03, -7.80463152e+03,  3.74537365e+03, -2.57596531e+02,
        2.00546073e+03,  2.19894362e+03, -7.01649120e+03, -5.36749890e+02,
       -2.30695348e+03, -1.39143878e+03,  6.48623127e+02, -5.62206157e+03,
       -8.54924223e+03, -8.21945413e+03, -4.65870043e+03, -4.16482132e+03,
        6.62001402e+03, -1.12938720e+03,  1.82672529e+03, -2.09162775e+02,
        3.64184356e+03,  6.53826809e+03,  9.59168523e+02,  3.52389831e+03,
       -1.59193693e+03, -8.86283648e+03,  4.64561551e+03, -9.26040730e+03,
       -1.28074447e+03,  3.92488459e+03, -3.80033955e+02,  2.43245956e+02,
       -1.78656500e+02, -1.32182012e+04,  2.99733235e+01, -5.15444794e+01,
        1.63325070e+03,  1.15390530e+04,  1.43145040e+04,  4.32507008e+03,
       -3.55189025e+03, -2.79817791e+03, -1.79180088e+03,  2.74252450e+03,
        5.50881109e+02, -1.90576286e+03,  2.84502933e+03, -1.32957972e+03,
        2.77962702e+03, -3.74876708e+02,  1.33492659e+04, -2.52670352e+03,
        7.69754062e+03,  4.67917096e+03,  4.81126338e+03, -2.91790611e+03,
        4.20695051e+03, -4.95943288e+02,  4.47315894e+03, -1.20058235e+03,
        5.84559427e+03, -2.84257424e+01,  6.22250455e+02,  8.08770222e+03,
        2.66948878e+03, -1.68507475e+03,  1.64644864e+03,  2.37136395e+03,
        1.16286136e+02,  2.02434531e+01, -3.60287286e+01,  3.48182110e+01,
       -1.45083112e+01,  1.18573684e+02, -1.09044690e+03, -1.80200903e+04,
        9.11061116e+03, -1.41678894e+01, -4.63060782e+02,  5.69215947e+01,
        2.00654802e+04,  3.91802695e+02, -1.25375854e+04, -2.36708631e+02,
       -7.08782034e+01, -2.30896751e+02,  3.80427878e+02,  2.83521576e+02,
       -1.56680425e+02, -6.45823056e+01,  2.26529905e+02, -3.19870572e+02,
        2.74254254e+02, -6.84264644e+01,  3.59357515e+02, -4.27869567e+01,
       -1.44994859e+03, -6.26024647e+02,  2.21045347e+02,  1.09408386e+02,
       -7.01254713e+01,  1.44614139e+02,  1.31446427e+02, -1.88411569e+02,
        2.89178969e+00, -1.69430222e+01, -4.21047012e+02, -5.20027326e+02,
       -2.10148572e+02,  2.99965256e+01,  2.43921083e+02, -3.06620340e+01,
       -3.85243132e+01, -6.38896534e+01, -2.71872389e+02,  5.55021899e+02,
        1.28802107e+03,  2.88346444e+02, -2.46427568e+02, -2.04856980e+02,
       -1.68819336e+01, -4.11247313e+01,  3.00913600e+02,  1.79335163e+00,
       -2.60806651e+02,  2.30237573e+02, -3.02181204e+02, -1.75579272e+03,
        3.56978111e+02, -6.91823372e+00,  4.82140793e+01,  5.53612623e+01,
        2.61954385e+01, -7.59604348e+01,  1.21925837e+02, -9.49515630e+01,
        2.09147059e+01,  6.06019477e+02,  8.84469537e+02,  2.43422930e+02,
       -5.06952797e+01, -1.54627102e+02, -5.18773742e+02,  2.75428638e+01,
        2.62296856e+02,  4.68709309e+01,  1.02513897e+02,  4.11700384e+03,
        2.73432426e+03,  1.06187878e+02, -8.65528136e+01,  2.70133865e+02,
        1.00751307e+03, -3.89265664e+02, -3.25129615e+01, -5.95178997e+02,
        1.28035497e+03,  8.68899302e+01, -7.38936097e+02,  1.19188798e+02,
        7.04540603e+02,  2.94155887e+02, -8.69410934e+01,  1.03940892e+02,
       -2.57195800e+01,  1.27767253e+02, -1.83486262e+01, -1.40766398e+02,
        3.00786776e+01, -1.98624091e+02, -5.76050302e+01,  3.90153784e+01,
       -2.01102360e+02,  4.11064971e+01, -8.29170990e+03, -6.36089683e+01,
       -3.13935412e+02, -1.73079281e+02, -8.84318481e+01, -2.62558794e+01,
        4.22420986e+02, -2.26952331e+02, -3.03532177e+02,  1.95969408e+03,
       -9.06720266e+00, -7.18258624e+01,  2.40768602e+03, -1.67493386e+02,
        9.32422026e+02, -7.88466190e+03,  2.45985689e+03, -3.84244645e+03,
        3.85316715e+02, -8.46835830e+03,  1.71632081e+03, -1.25476611e+02,
       -6.55769641e+01, -1.43923433e+03, -9.23061394e+01, -1.81831037e+03,
       -1.37949286e+03,  3.72270569e+03, -5.43064549e+03, -5.33491562e+03,
        2.08179839e+02, -5.51761498e+02, -2.30370664e+02, -1.09815696e+04,
        1.59826111e+03, -9.38755116e+02, -1.63808793e+03, -2.90924311e+03,
       -3.18632738e+03, -7.76860711e+01, -5.09028134e+03, -7.77560836e+01,
       -1.23901233e+03,  1.54912142e+03, -2.17535005e+03,  2.69871764e+03,
       -3.42971377e+03,  2.85113875e+03,  1.92843598e+03,  2.94435242e+03,
       -9.50442200e+02, -3.42618045e+03,  8.57906004e+03, -6.84358034e+03,
        6.93085417e+02,  2.27339994e+03,  1.30094738e+03, -1.05981696e+03,
       -2.40179926e+00, -3.16730683e+02,  5.39591126e+00,  1.70460058e+02,
        3.66954200e+03,  2.87068369e+03,  5.01095353e+02,  4.79272838e+03,
       -2.56058271e+03, -4.93140251e+02, -2.57440740e+02,  3.46511015e+03,
        1.21477852e+03,  1.35936453e+03, -5.34201975e+02,  1.31688749e+04,
        3.66055722e+03,  1.57535684e+03, -3.32410063e+03,  3.02646607e+00,
       -6.39020605e+03, -2.34241377e+03,  7.58705192e+00, -7.17377244e+01,
        3.80578844e+03,  3.88294853e+02, -4.90762027e+00,  2.44578306e+02,
       -6.80394677e+02,  1.48741922e+03,  5.14579130e+03,  4.46020399e+03,
       -2.92525150e+03, -4.46174537e+03,  3.37145550e+03,  3.11186903e+03,
        6.69798726e+03, -4.84477104e+03, -2.94383467e+03,  1.53305922e+03,
       -5.06841703e+03, -1.31151304e+03, -3.98284359e+02,  4.72478421e+02,
        8.85839418e+03, -2.35043683e+03, -5.25163882e+03, -3.83736471e+03,
       -6.42442398e+03, -1.66019727e+04,  1.16320625e+04,  7.23601899e+03,
       -5.76960657e+03, -8.49921679e+03,  1.03303959e+03,  2.22861650e+02,
        1.89644295e+04, -3.95806842e+03, -1.10135920e+04, -4.47072303e+03,
       -1.90626932e+02, -4.94940537e+02, -4.35979383e+02,  2.64099748e+01,
        2.72754065e+02,  1.26769397e+03, -4.41773850e+02,  1.39052429e+02,
       -1.17441667e+02, -2.96286623e+02,  3.09702427e+02, -3.51705381e+02,
       -2.99399184e+02, -5.09736259e+01, -3.25269109e+02, -2.12224227e+02,
        5.27952489e+01, -1.12579927e+03,  2.77360032e+02, -2.36929682e+02,
       -6.10867824e+02, -5.88999982e+02, -3.08563048e+01,  1.74398592e+03,
       -2.10206358e+02, -1.39387827e+02, -2.67153668e+02,  3.86041491e+02,
        2.66743356e+01,  2.34307091e+02,  6.02187596e+02, -6.61566980e+01,
       -4.59030041e+01, -8.94202867e+01, -1.77632993e+01, -2.77546975e+02,
       -1.89415775e+02, -4.35592757e+01, -2.03284263e+02,  1.21061785e+02,
        4.03476809e+02, -1.03549024e+02,  8.83001132e+01, -1.52292696e+01,
       -1.24028102e+01,  4.96887655e+02, -4.30671430e+02,  4.32833201e+02,
       -4.38639091e+02, -8.01877771e+02, -7.81048866e+02,  8.24471753e+01,
        5.05240066e+02, -1.96344350e+02, -2.12717064e+02, -2.11507113e+02,
        4.24911732e+02,  5.48630005e+01,  1.52752312e+02,  7.60139145e+02,
       -3.81484919e+02, -7.28888392e+02,  4.09348147e+02, -4.94004361e+02,
        1.21365928e+02, -1.73374995e+02,  1.32137909e+02,  9.34565664e+01,
        2.82821387e+02,  5.49190928e+01,  4.62770566e+02, -4.78124220e+02,
        6.91190571e+02,  2.19624070e+02, -2.56804972e+02, -1.56124045e+02,
       -1.76697053e+02,  3.43473884e+02, -2.14937354e+02, -3.49629571e+02,
        2.49114290e+02, -1.91443755e+02,  8.43302728e+01, -5.58206373e+01,
        4.23986416e+01, -2.98683586e+02,  2.80215887e+00, -1.91834034e+02,
        1.11612564e+02,  2.27925407e+02, -5.39195115e+01,  1.78354333e+02,
        9.43671104e+03, -5.83400641e+03, -1.04446276e+04, -9.37791125e+03,
       -8.20481980e+03, -1.17750603e+04, -4.00672833e+03, -4.28757081e+03,
       -3.64173818e+03, -2.21554392e+02, -7.93855812e+02, -1.78319648e+04,
       -2.39701677e+02, -1.32180332e+03, -5.73462922e+03, -6.35198418e+03,
       -9.09802589e+03,  2.02815086e+03,  3.14916279e+03,  4.01465075e+03,
        5.80620547e+03,  7.79503833e+03, -6.80759633e+03,  2.67203961e+02,
       -1.52156399e+02, -1.27469692e+03,  7.82885442e+03,  3.99719037e+03,
        8.28748822e+03,  1.16127052e+04, -1.32752424e+03,  2.82263138e+03,
        6.92708514e+03, -8.66509270e+01, -3.37222973e+01, -5.64576334e+03,
       -6.16537191e+03, -4.52781252e+02,  1.84667438e+02,  1.62834190e+03,
       -4.17250501e+01, -1.24037770e+03, -2.27790639e+03,  8.67320822e+02,
       -7.36820411e+01, -9.87556933e+02, -1.27904369e+03, -6.38221503e+03,
        3.53252179e+02,  2.24358360e+03, -3.81761792e+02,  2.37094427e+02,
        1.80692561e+02, -2.58063644e+03,  4.07196637e+02,  1.52359911e+03,
       -4.15471903e+03, -3.13686338e+03, -1.33171972e+03, -2.69238592e+02,
        4.22683319e+02,  2.99026145e+02, -2.47288905e+02, -1.55308880e+02,
       -1.05704620e+03,  2.89404038e+03,  1.98031878e+01,  3.57735891e+03,
        1.96449603e+02,  8.04377357e+01, -1.71075573e+03,  7.23334744e+02,
        6.53580491e+02, -9.23190247e+01,  1.70254761e+00, -9.19751375e+01,
       -5.89398954e+01, -6.57302924e+02,  2.01098621e+02, -3.09073064e+03,
        1.01156158e+03, -1.46866108e+03,  3.59177727e+02,  2.17798994e+02,
        6.29443868e+02, -2.55388881e+02,  5.60862945e+02,  3.36874824e+02,
        5.33741092e+02, -1.08972611e+02, -1.20670715e+03,  3.50281183e+01,
       -5.51235265e+02,  4.13095678e+02,  2.72623510e+03, -3.38318359e+03,
       -1.22023097e+03, -6.81810362e+02, -3.24525038e+03,  2.09059377e+02,
       -2.20355728e+03, -4.60590263e+03, -5.15437500e+02,  5.00861634e+02,
        1.41395831e+03, -5.37057782e+03,  5.85825841e+02,  1.56324010e+02,
       -1.85336619e+03,  8.93612696e+02,  3.59844981e+02,  1.14545622e+02,
        3.86047021e+02,  2.03915689e+03,  8.89248414e+02, -5.76830664e+03,
        3.18313760e+02,  9.36938815e+02,  4.41504593e+02,  1.94862813e+03,
       -3.15525697e+03, -6.90290042e+02, -3.54738974e+02,  5.21721296e+03,
       -5.27384654e+03, -3.50409087e+03,  4.95694278e+03,  2.68050538e+02,
        2.38279145e+03,  2.04594867e+03, -2.43047869e+04,  1.10634372e+04,
        8.78122753e+02,  6.15528837e+03,  4.39614692e+03,  1.36421054e+02,
       -7.76120408e+03,  1.84024297e+01, -2.20862680e-01,  1.17049041e+04,
        1.02648732e+03,  1.24092452e+04,  8.07214453e+03, -6.70678791e+03,
        2.08038166e+02, -8.24939087e+01, -1.05908398e+04, -4.40848978e+03,
        3.94600411e+03, -6.96842938e+03, -1.31200422e+04, -1.06092942e+02,
       -1.32724301e+03, -6.51209672e+02,  1.96419180e+03, -2.27351675e+02,
       -1.69506822e+04, -8.21011602e+02,  2.23870887e+04, -6.85402809e+03,
        1.14963662e+04, -8.18636745e+03,  4.85785222e+03,  4.77833644e+03,
        1.60228489e+02,  1.34889501e+02,  1.11786238e+04,  6.75721512e+03,
       -2.03259385e+03,  1.16285351e+02, -9.96621620e+01,  1.24320131e+01,
       -1.90609974e+02, -2.73395850e+03,  1.30724770e+02,  4.01758033e+02,
        2.37673503e+02, -2.21606350e+00, -3.64197870e+03,  6.30730646e+03,
        2.82761104e+02, -4.07627670e+03,  4.10369098e+03, -6.90370719e+02,
       -4.85210182e+02, -1.25953168e+03,  2.85919527e+03,  8.19702522e+03,
       -1.71079633e+04, -1.77314403e+02,  2.99685997e+02, -2.16111020e+03,
        1.39978883e+03, -7.80222077e+03,  3.72688135e+03, -3.13808342e+03,
        1.92853772e+03,  7.61478081e+02,  5.32385624e+03, -4.42706227e+02,
       -5.29784062e+03, -8.30772105e+02, -2.18542010e+03,  3.05708565e+03,
       -8.24301550e+02,  7.66875174e+03, -9.94482554e+03, -3.95136566e+03,
        3.13379409e+03,  2.99055575e+03, -1.00237679e+04,  4.75796259e+03,
        7.30751623e+03,  2.80163879e+02,  6.16090159e+03,  1.69443894e+03,
        3.76971751e+03,  7.35924805e+03, -4.22397554e+02,  5.35162940e+03,
       -8.37226208e+02, -2.83145015e+02, -9.51349753e+02,  1.17296901e+03,
       -6.41832028e+02,  2.00876262e+03, -1.14062082e+02,  2.90376972e+03,
       -6.38502640e+03,  8.77087523e+02,  7.33451636e+03, -1.66906298e+03,
        2.68489440e+03, -7.52686444e+02, -1.25897390e+03, -7.69796397e+03,
        1.03378566e+03,  4.50683171e+03, -8.79729100e+03,  5.36701756e+02,
        2.08859144e+02,  8.69791556e+03,  2.82639439e+03, -4.74664696e+02,
       -3.29748208e+02, -4.00848163e+03,  1.19392960e+04,  1.06679431e+02,
       -2.62223259e+03, -1.16732597e+02, -1.13014174e+03,  1.03074891e+00])

@unittest.skipIf(os.environ['HAVE_GAP'] != '1', 'GAP support not enabled')
class TestGAP_fit_silion(quippytest.QuippyTestCase):
    
    def test_gap_fit(self):
    
        with open('sparse_file', 'w') as fh:
            for sp in sparse_points:
                fh.write(f'{sp}\n')
                
        command_line = ("at_file=train_sub3.xyz gap={soap l_max=8 n_max=8 atom_sigma=0.5 "
                        "zeta=4 cutoff=4.0 cutoff_transition_width=1.0 central_weight=1.0 "
                        "n_sparse=1000 delta=3.0 f0=0.0 covariance_type=dot_product "
                        "sparse_method=index_file sparse_file=sparse_file} "
                        "default_sigma={0.001 0.1 0.05 0.0} "
                        "energy_parameter_name=dft_energy force_parameter_name=dft_force "
                        "virial_parameter_name=dft_virial config_type_parameter_name=config_type "
                        "sparse_jitter=1.0e-8 e0_offset=2.0 gp_file=gp.xml rnd_seed=1")
        # os.system('gap_fit '+command_line)
        
        tree = ET.parse('gp.xml')
        root = tree.getroot()
        gp_label = root.tag
        
        # check GP coefficients match expected values
        idx = np.array([int(tag.attrib['i']) for tag in root[1][1][0].findall('sparseX')])
        idx -= 1 # convert from one- to zero-based indexing
        alpha = np.array([float(tag.attrib['alpha']) for tag in root[1][1][0].findall('sparseX')])
        alpha = alpha[idx] # reorder correctly
        
        # print(repr(alpha))
        # print(alpha - alpha_ref)
        # print(np.abs(alpha - alpha_ref).max())
        print(np.abs((alpha - alpha_ref) / alpha_ref).max())
        assert np.abs((alpha - alpha_ref) / alpha_ref).max() < 1e-2
        
        pot = Potential(f'xml_label={gp_label}', param_filename='gp.xml')
        
        dataset = read('train_sub3.xyz@:')
        for atoms in dataset:
            atoms.calc = pot
            info = {k.lower(): v for k, v in atoms.info.items() }
            arrays = {k.lower(): v for k, v in atoms.arrays.items() }
            energy = atoms.get_potential_energy()
            # atoms.info['gap_energy'] = energy
            forces = atoms.get_forces()
            # atoms.arrays['gap_forces'] = forces        

            # check for consistency with reference GAP model        
            assert abs(atoms.info['gap_energy'] - energy) < 1e-6        
            assert np.abs(atoms.arrays['gap_forces'] - forces).max() < 1e-6

            # check error wrt training data
            de = abs(energy - info['dft_energy']) / len(atoms)
            assert de < 1e-3        
            
            df = np.sqrt(((forces - arrays['dft_force'])**2).mean())
            assert df < 0.3
            
            if 'dft_virial' in atoms.info:
                stress = atoms.get_stress()        
                virial = - voigt_6_to_full_3x3_stress(stress * atoms.get_volume())
                # atoms.info['gap_virial'] = virial
                assert np.abs(atoms.info['gap_virial'] - virial).max() < 1e-6
                
                dft_virial = info['dft_virial'].reshape((3, 3), order='F')
                dv = np.sqrt(((virial - dft_virial)**2).mean())
                assert dv < 3.0
                
        # from ase.io import write
        # write('dump.xyz', dataset)


if __name__ == '__main__':
    unittest.main()
