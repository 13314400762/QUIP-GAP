# HQ XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
# HQ X
# HQ X   quippy: Python interface to QUIP atomistic simulation library
# HQ X
# HQ X   Copyright James Kermode 2019
# HQ X
# HQ X   These portions of the source code are released under the GNU General
# HQ X   Public License, version 2, http://www.gnu.org/copyleft/gpl.html
# HQ X
# HQ X   If you would like to license the source code under different terms,
# HQ X   please contact James Kermode, james.kermode@gmail.com
# HQ X
# HQ X   When using this software, please cite the following reference:
# HQ X
# HQ X   http://www.jrkermode.co.uk/quippy
# HQ X
# HQ XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX

import unittest
import os

import xml.etree.ElementTree as ET

import numpy as np
import quippytest

from quippy.potential import Potential
from ase.constraints import voigt_6_to_full_3x3_stress
from ase.io import read

# fixed set of sparse points for training
sparse_points = [
    1, 2, 3, 4, 5, 8, 13, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 29, 30, 
    33, 34, 35, 36, 37, 38, 43, 44, 46, 47, 48, 49, 50, 51, 53, 54, 57, 61, 62,
    63, 64, 65, 66, 68, 70, 71, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 84, 85, 
    86, 89, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 107, 108, 109, 110,
    111, 113, 114, 116, 117, 120, 123, 124, 125, 126, 127, 128, 129, 132, 133, 134, 
    137, 142, 143, 144, 145, 146, 147, 148, 149, 150, 151, 152, 154, 155, 156, 157, 
    158, 159, 161, 163, 164, 167, 168, 169, 181, 182, 183, 185, 187, 190, 192, 194, 
    195, 196, 197, 205, 207, 210, 217, 218, 225, 233, 238, 249, 254, 256, 262, 274, 
    286, 288, 294, 297, 303, 311, 312, 316, 317, 321, 333, 336, 338, 345, 346, 352, 
    369, 371, 373, 377, 378, 381, 383, 384, 396, 397, 406, 409, 411, 416, 420, 424, 
    427, 437, 438, 442, 447, 449, 462, 466, 474, 476, 481, 482, 485, 487, 490, 492, 
    502, 503, 504, 506, 509, 511, 515, 525, 527, 532, 541, 550, 553, 554, 556, 557, 
    559, 566, 567, 570, 571, 573, 574, 576, 577, 581, 593, 594, 595, 596, 597, 598, 
    599, 600, 601, 603, 606, 608, 611, 612, 615, 617, 648, 652, 656, 659, 663, 665, 
    672, 673, 675, 676, 682, 683, 684, 685, 693, 701, 705, 721, 725, 726, 728, 738, 
    742, 743, 744, 757, 765, 766, 767, 774, 775, 785, 794, 797, 805, 810, 812, 817, 
    818, 819, 820, 821, 822, 823, 824, 825, 826, 827, 828, 829, 830, 831, 832, 833, 
    834, 835, 836, 837, 838, 839, 840, 841, 842, 843, 844, 845, 846, 847, 848, 849, 
    851, 852, 853, 854, 855, 856, 857, 858, 859, 860, 861, 862, 863, 864, 865, 866, 
    867, 868, 869, 870, 871, 872, 873, 874, 875, 876, 877, 878, 879, 880, 881, 882, 
    883, 884, 885, 887, 888, 889, 890, 891, 892, 893, 894, 895, 896, 897, 899, 901, 
    902, 903, 904, 905, 907, 908, 909, 910, 911, 912, 913, 917, 918, 923, 929, 931, 
    933, 934, 938, 945, 947, 949, 952, 955, 956, 958, 962, 963, 969, 974, 975, 976, 
    977, 980, 982, 983, 984, 991, 993, 1005, 1007, 1009, 1012, 1013, 1016, 1018, 1020, 
    1021, 1023, 1024, 1025, 1026, 1028, 1035, 1036, 1039, 1041, 1044, 1046, 1048, 1051, 
    1054, 1055, 1060, 1074, 1076, 1081, 1083, 1085, 1088, 1091, 1094, 1096, 1097, 1100,
    1101, 1105, 1106, 1109, 1113, 1114, 1119, 1122, 1124, 1126, 1127, 1128, 1129, 1130,
    1132, 1139, 1147, 1152, 1154, 1162, 1176, 1177, 1182, 1183, 1194, 1195, 1196, 1197, 
    1198, 1199, 1200, 1201, 1202, 1203, 1204, 1205, 1206, 1207, 1208, 1210, 1211, 1212, 
    1213, 1214, 1215, 1216, 1217, 1219, 1221, 1222, 1223, 1224, 1225, 1227, 1228, 1229,
    1230, 1231, 1232, 1234, 1235, 1236, 1237, 1238, 1239, 1240, 1241, 1242, 1243, 1245, 
    1246, 1247, 1248, 1249, 1250, 1251, 1252, 1253, 1254, 1255, 1256, 1257, 1259, 1260, 
    1261, 1262, 1263, 1264, 1266, 1267, 1271, 1273, 1274, 1275, 1277, 1278, 1279, 1280, 
    1281, 1282, 1283, 1284, 1285, 1286, 1287, 1288, 1289, 1290, 1294, 1295, 1296, 1297, 
    1298, 1299, 1300, 1301, 1305, 1306, 1307, 1308, 1309, 1310, 1313, 1314, 1316, 1317, 
    1318, 1320, 1321, 1322, 1323, 1324, 1329, 1330, 1331, 1333, 1334, 1339, 1340, 1341, 
    1342, 1343, 1348, 1349, 1354, 1361, 1363, 1365, 1368, 1369, 1373, 1381, 1386, 1391, 
    1392, 1398, 1399, 1402, 1403, 1407, 1411, 1413, 1414, 1421, 1423, 1424, 1427, 1429,
    1430, 1434, 1437, 1451, 1452, 1453, 1456, 1459, 1460, 1462, 1465, 1466, 1470, 1471,
    1475, 1477, 1479, 1484, 1488, 1490, 1499, 1501, 1502, 1506, 1507, 1508, 1513, 1516,
    1517, 1520, 1521, 1526, 1528, 1542, 1544, 1546, 1548, 1551, 1553, 1563, 1570, 1571,
    1575, 1579, 1582, 1584, 1597, 1598, 1601, 1603, 1607, 1622, 1631, 1633, 1647, 1653,
    1655, 1659, 1660, 1677, 1692, 1694, 1703, 1704, 1705, 1722, 1743, 1744, 1747, 1748,
    1750, 1755, 1756, 1758, 1759, 1760, 1762, 1763, 1764, 1766, 1767, 1768, 1769, 1770,
    1771, 1772, 1773, 1774, 1775, 1776, 1777, 1778, 1779, 1781, 1782, 1783, 1784, 1785,
    1786, 1787, 1788, 1789, 1790, 1791, 1792, 1793, 1794, 1795, 1796, 1797, 1799, 1800,
    1801, 1802, 1803, 1804, 1805, 1807, 1808, 1809, 1810, 1812, 1813, 1814, 1815, 1816,    
    1818, 1819, 1820, 1821, 1824, 1825, 1827, 1828, 1829, 1830, 1831, 1832, 1833, 1835, 
    1836, 1837, 1838, 1839, 1840, 1841, 1843, 1845, 1846, 1847, 1848, 1849, 1850, 1851, 
    1853, 1854, 1855, 1873, 1879, 1886, 1892, 1895, 1896, 1901, 1903, 1913, 1921, 1922, 
    1923, 1925, 1932, 1943, 1951, 1965, 1975, 1978, 1980, 2004, 2015, 2017, 2019, 2020, 
    2021, 2025, 2028, 2031, 2034, 2043, 2046, 2047, 2049, 2050, 2054, 2061, 2067, 2068, 
    2069, 2072, 2073, 2075, 2076, 2077, 2079, 2081, 2084, 2086, 2088, 2090, 2092, 2093, 
    2094, 2095, 2097, 2099, 2106, 2108, 2109, 2110, 2111, 2113, 2114, 2116, 2117, 2118, 
    2122, 2123, 2124, 2125, 2126, 2127, 2128, 2129, 2130, 2131, 2132, 2133, 2135, 2144, 
    2145, 2146, 2147, 2148, 2149, 2151, 2152, 2158, 2161, 2163, 2164, 2165, 2166, 2168, 
    2169, 2170, 2171, 2176, 2177, 2179, 2181, 2185, 2186, 2189, 2191, 2192, 2195, 2196, 
    2197, 2202, 2205, 2206, 2209, 2210, 2211, 2213, 2217, 2218, 2219, 2220, 2221, 2224, 
    2231, 2233, 2234, 2235, 2236, 2237, 2238, 2239, 2240, 2246, 2248, 2249, 2251, 2253, 
    2255, 2256, 2257, 2259, 2267, 2273, 2274, 2289, 2292, 2296, 2303, 2305, 2306, 2307, 
    2308, 2319, 2326, 2329, 2330, 2332, 2333, 2334, 2335, 2346, 2349, 2354, 2357, 2362, 
    2365, 2374, 2379, 2388, 2397, 2398, 2401, 2403, 2404, 2405, 2406, 2407, 2408, 2409, 
    2410, 2411, 2413, 2416, 2422, 2424, 2426, 2429, 2434, 2437, 2448, 2454, 2455, 2456, 
    2459, 2460, 2461, 2463, 2464, 2469, 2474, 2476, 2478, 2481, 2482, 2484, 2489, 2491, 
    2494, 2495, 2499, 2503, 2504, 2508, 2513, 2517, 2520, 2522, 2524, 2525, 2531, 2534, 
    2535, 2536, 2538, 2549, 2552, 2553, 2555, 2556, 2563, 2565, 2566, 2567, 2568, 2569, 
    2570, 2578, 2585, 2587, 2589, 2591, 2593, 2596, 2598, 2600, 2605, 2609, 2610, 2612, 
    2613, 2617, 2619
]


# expected fit coefficients
alpha_ref = np.array(
      [-1.62358345e-02, -9.29373538e+01, -9.86468701e+02, -2.01124154e+02,
       -2.87917093e+01,  2.08473815e+03,  4.74389407e+02, -2.00184308e+02,
       -5.32846014e+02,  2.13520776e+02, -2.68482244e+02, -6.41436003e+02,
       -4.07662730e+02,  1.85487434e+02, -1.53403984e+03,  7.39581168e+03,
        2.60438776e+02,  5.64403475e+03, -5.58372318e+03, -8.83226794e+01,
       -8.76612213e+01, -7.52976813e+01,  3.75802981e+01, -7.61782695e+01,
       -5.56867997e+02,  2.61168011e+02, -5.89860334e+02, -2.00250602e+03,
       -3.16281754e+02,  8.79993187e+02,  6.03449336e+02,  3.11726368e+01,
       -1.83239640e+02,  5.31395068e+02, -1.82406096e+02,  5.87215658e+01,
        5.65050543e+02,  1.32223834e+04, -1.20742372e+02, -3.15201294e+02,
       -4.37146311e+02,  2.22670916e+02,  1.67755980e+02, -1.23176612e+02,
        6.43174648e+02, -1.24299288e+04,  3.61547382e+03,  1.47281395e+03,
       -4.48460254e+01,  5.57134194e+01,  4.20378312e+02,  1.15973350e+02,
        3.72496967e+01,  1.11091965e+02,  8.97768602e+01,  7.69143273e+01,
       -5.18978036e+02,  2.34895209e+03, -4.07963057e+02, -7.95119672e+03,
        5.82780973e+01,  9.26107857e+02, -2.68086703e+02,  3.96879402e+02,
        6.54114217e+01, -2.35186850e+02, -9.93103380e-01, -3.09587227e+02,
       -3.61284121e+02, -1.73003627e+01,  3.94290014e+01, -9.01505035e+02,
       -3.25918590e+02, -5.34214134e+02, -1.41721376e+02, -5.37945115e+02,
        4.06701629e+02, -2.58294292e+02, -1.59465875e+02, -3.44608088e+01,
       -3.46353612e+02, -2.53671944e+02,  5.03024423e+02,  4.07911784e+02,
        3.91442122e+02,  1.79079623e+02, -3.04849235e+02,  5.18436053e+02,
        3.24544425e+02,  4.16995795e+02,  1.69871138e+03,  2.59074920e+02,
        1.05271061e+03,  1.68742378e+02,  4.24897187e+02,  2.30376472e+02,
        1.83475855e+02, -3.46181920e+02,  3.99003852e+02,  4.04624139e+02,
       -1.24264022e+02,  2.36246434e+02, -2.38131777e+02, -9.22571270e+02,
       -6.91423722e+02, -3.52646700e+02,  1.34271083e+03,  4.83667242e+02,
        8.68792241e+02, -8.31531867e+02, -6.46018633e+02,  6.65388413e+02,
       -2.11152662e+03,  4.06559789e+03,  1.38153671e+03,  5.15580029e+03,
       -1.89688285e+03, -1.19897584e+04,  3.22812560e+03,  4.22091378e+03,
       -9.39354942e+03,  3.90681641e+03, -1.81062769e+04,  1.26734498e+04,
       -6.27737855e+03,  3.93019071e+03,  1.55261225e+03,  1.92297514e+03,
        1.03755006e+04, -6.62992754e+03,  9.19088491e+03, -4.25429010e+02,
       -1.52879015e+03,  1.02547635e+02, -6.35947123e+02,  2.79004554e+02,
        9.77154523e+02, -1.17762651e+04, -5.08999218e+03, -2.39431491e+03,
       -1.04391337e+03, -2.33178869e+03,  4.10429270e+03, -3.45671091e+03,
        1.49028454e+02,  2.62038297e+03, -1.82156524e+04, -1.14454624e+03,
        4.31934928e+03,  6.24272319e+03, -1.14451683e+03,  8.74642103e+03,
       -9.14390442e+03,  1.33831654e+03,  4.55077043e+03, -3.45040250e+03,
        6.13582042e+03,  3.35211586e+03,  1.14228501e+03,  5.27497737e+03,
       -5.55017001e+02, -1.26638302e+04, -9.95185316e+03,  4.87421098e+03,
       -1.33561975e+03,  7.46984602e+00,  5.11655887e+03,  1.97207466e+04,
        5.88465578e+03, -6.01543460e+03,  1.01264973e+04,  2.31377268e+03,
       -2.45451893e+03,  1.68856501e+04,  1.02541843e+04, -8.52925754e+03,
       -2.53330026e+01,  2.37663047e+02, -1.50716050e+03,  5.33335564e+02,
       -1.45127172e+03,  3.99473651e+02,  5.01003415e+02, -1.91742167e+02,
       -1.47566753e+03, -2.83230422e+03,  6.54274827e+02,  2.03709645e+03,
       -1.59095932e+03,  9.39021187e+02,  2.83681236e+02,  8.00637004e+02,
       -1.28055123e+02,  3.24328411e+03,  2.33692174e+03, -1.56405752e+02,
       -6.56427487e+02, -2.23521072e+03, -1.01911528e+03,  1.07451329e+03,
        2.09557199e+03, -3.52335407e+02, -2.45870436e+03,  7.82643762e+02,
        1.39392018e+03,  3.82512047e+01,  7.39394955e+02,  2.71378023e+03,
       -4.64283588e+02,  1.76452163e+03, -7.47581542e+02, -3.80660769e+03,
       -1.29037627e+02,  1.04969549e+03, -2.14630237e+03, -2.09938362e+02,
       -1.09285338e+02, -3.23809248e+01, -1.54053512e+02,  1.10917191e+02,
        3.36808523e+02,  3.34228837e+02,  4.64772799e+01, -1.93996283e+02,
       -7.22036631e+02,  3.28418649e+03, -1.38551589e+04, -3.86862325e+03,
       -1.46011713e+04, -7.51581488e+03, -2.92006253e+03,  3.00518300e+02,
        2.70352351e+03, -9.83540241e+03, -1.28726967e+04, -1.00198891e+04,
        1.23349524e+03,  1.53597493e+02, -2.28409164e+02,  2.02076181e+03,
        7.69730220e+03,  2.64516126e+03, -6.09905985e+01, -2.16893698e+03,
        4.51999978e+03, -2.11766058e+03, -7.91923186e+02, -5.65195464e+03,
        1.73533556e+03, -9.07787621e+02,  7.71758644e+02,  2.68589650e+03,
        1.77973356e+04, -1.09773412e+04,  1.22576838e+04,  1.77438538e+04,
        1.04175679e+04,  6.22031173e+01,  5.61855956e+02, -5.22829169e+03,
        6.01894952e+03,  6.54965431e+03, -3.80786068e+03,  1.21406168e+02,
        3.69217234e+03, -2.03848024e+03,  1.11101698e+04, -1.46902678e+01,
        9.27736302e+01, -7.27522570e+00, -8.75362556e+01,  2.35847603e+02,
        5.65215885e+01,  5.75193081e+01, -2.40760649e+01,  1.08643607e+02,
       -2.76278439e+02, -8.71449441e+01, -2.47634009e+02,  9.60294372e+00,
        1.13193627e+02,  7.62188162e+01, -1.92107507e+02, -1.33922670e+01,
        2.93965829e+01,  9.34413061e+02,  7.53166536e+00,  3.15974589e+02,
        1.70977278e+02,  5.55027996e+02,  5.60304937e+01, -1.88326155e+02,
       -2.38703364e+02,  1.12979911e+01, -2.10469321e+02, -2.24501864e+02,
       -1.14632326e+02, -3.51273041e+02,  5.10541810e+02,  1.48608114e+02,
       -2.93503212e+01,  5.64750694e+02, -4.60474321e+01,  4.10355160e+02,
        8.56810208e+01, -7.51972804e+01,  8.12144548e+01, -1.84440150e+01,
        3.28511367e+02,  1.36568775e+02,  1.59205826e+02,  5.24270531e+02,
        1.95076202e+02, -8.09938499e+00, -1.85385598e+02, -2.03619612e+02,
        8.00665373e+01,  3.13846415e+02,  8.49016539e+01,  8.13786027e+01,
        1.24764999e+02, -3.70616682e+02, -1.29396388e+02,  2.53839468e+01,
       -1.16013234e+02,  1.34231696e+00,  4.03932452e+02,  1.12999220e+02,
        1.44429383e+01,  1.88162139e+02, -4.47351836e+02,  2.38720458e+01,
       -2.28288737e+01, -1.53797649e+02,  6.31492381e+01,  1.90672957e+02,
       -3.30194425e+01, -1.28280569e+02,  5.42746172e+02, -7.76903141e+01,
       -1.14410400e+03,  8.69582446e+00,  1.35062581e+02,  1.33689441e+03,
        1.93668011e+02,  2.13383339e+03,  3.66464371e+01,  4.05478386e+01,
        1.42619399e+02,  4.42638767e+01,  7.55655368e+01, -1.31817378e+00,
       -2.50801030e+03, -2.03140009e+01, -4.24275896e+01, -1.17541803e+02,
       -6.06476004e+01,  2.04382645e+01, -2.52006571e+01, -2.75164503e+03,
        7.64223465e+03, -3.45275172e+03, -8.28423407e+03, -2.58377239e+03,
        8.81223963e+03, -7.80466031e+03,  3.74537455e+03, -2.57607020e+02,
        2.00547001e+03,  2.19892496e+03, -7.01652087e+03, -5.36749887e+02,
       -2.30695992e+03, -1.39142464e+03,  6.48623190e+02, -5.62206040e+03,
       -8.54933698e+03, -8.21944127e+03, -4.65869045e+03, -4.16477669e+03,
        6.62002554e+03, -1.12935571e+03,  1.82672500e+03, -2.09162653e+02,
        3.64183651e+03,  6.53826229e+03,  9.59134352e+02,  3.52390513e+03,
       -1.59195584e+03, -8.86282914e+03,  4.64556267e+03, -9.26041449e+03,
       -1.28075288e+03,  3.92488547e+03, -3.80038177e+02,  2.43246400e+02,
       -1.78656202e+02, -1.32182272e+04,  2.99733261e+01, -5.15444458e+01,
        1.63328450e+03,  1.15390102e+04,  1.43145367e+04,  4.32511432e+03,
       -3.55182546e+03, -2.79817426e+03, -1.79179500e+03,  2.74252555e+03,
        5.50884893e+02, -1.90576459e+03,  2.84503954e+03, -1.32957888e+03,
        2.77956066e+03, -3.74876573e+02,  1.33492780e+04, -2.52675455e+03,
        7.69755177e+03,  4.67918705e+03,  4.81126302e+03, -2.91791604e+03,
        4.20696772e+03, -4.95942503e+02,  4.47316767e+03, -1.20058471e+03,
        5.84559036e+03, -2.84258141e+01,  6.22235234e+02,  8.08769697e+03,
        2.66946109e+03, -1.68507954e+03,  1.64644885e+03,  2.37130259e+03,
        1.16276857e+02,  2.02434665e+01, -3.60287339e+01,  3.48182429e+01,
       -1.45083283e+01,  1.18573703e+02, -1.09054968e+03, -1.80201421e+04,
        9.11054089e+03, -1.42757542e+01, -4.63060783e+02,  5.69216168e+01,
        2.00655586e+04,  3.91802666e+02, -1.25374690e+04, -2.36709096e+02,
       -7.08780378e+01, -2.30896843e+02,  3.80427865e+02,  2.83521804e+02,
       -1.56680316e+02, -6.45823723e+01,  2.26530073e+02, -3.19870675e+02,
        2.74252527e+02, -6.84265381e+01,  3.59358237e+02, -4.27869140e+01,
       -1.44994343e+03, -6.26024887e+02,  2.21045793e+02,  1.09408623e+02,
       -7.01255946e+01,  1.44614129e+02,  1.31446388e+02, -1.88411410e+02,
        2.89181943e+00, -1.69428404e+01, -4.21046922e+02, -5.20027571e+02,
       -2.10148523e+02,  2.99965625e+01,  2.43920795e+02, -3.06621290e+01,
       -3.85246132e+01, -6.38895269e+01, -2.71873717e+02,  5.55022752e+02,
        1.28802075e+03,  2.88346469e+02, -2.46429032e+02, -2.04857076e+02,
       -1.68819047e+01, -4.11247530e+01,  3.00913708e+02,  1.79420469e+00,
       -2.60806409e+02,  2.30237694e+02, -3.02181494e+02, -1.75579298e+03,
        3.56978815e+02, -6.91833821e+00,  4.82139953e+01,  5.53611181e+01,
        2.61954957e+01, -7.59605446e+01,  1.21925647e+02, -9.49516627e+01,
        2.09138197e+01,  6.06017492e+02,  8.84469734e+02,  2.43420560e+02,
       -5.06953943e+01, -1.54627172e+02, -5.18773496e+02,  2.75425114e+01,
        2.62297284e+02,  4.68706385e+01,  1.02514015e+02,  4.11709673e+03,
        2.73431847e+03,  1.06187963e+02, -8.65527955e+01,  2.70133889e+02,
        1.00750781e+03, -3.89265497e+02, -3.25123278e+01, -5.95180800e+02,
        1.28035651e+03,  8.68897853e+01, -7.38936151e+02,  1.19188700e+02,
        7.04540466e+02,  2.94155745e+02, -8.69410831e+01,  1.03940806e+02,
       -2.57197978e+01,  1.27767181e+02, -1.83462091e+01, -1.40765578e+02,
        3.00787543e+01, -1.98624353e+02, -5.76047021e+01,  3.90149654e+01,
       -2.01103193e+02,  4.11065053e+01, -8.29172791e+03, -6.36089976e+01,
       -3.13935423e+02, -1.73079351e+02, -8.84318824e+01, -2.62558619e+01,
        4.22421167e+02, -2.26952555e+02, -3.03532034e+02,  1.95970011e+03,
       -9.08467688e+00, -7.18256706e+01,  2.40769073e+03, -1.67497478e+02,
        9.32421994e+02, -7.88466036e+03,  2.45984583e+03, -3.84245704e+03,
        3.85327527e+02, -8.46837063e+03,  1.71632433e+03, -1.25471883e+02,
       -6.55693875e+01, -1.43924607e+03, -9.23004009e+01, -1.81831347e+03,
       -1.37950293e+03,  3.72270294e+03, -5.43059523e+03, -5.33490700e+03,
        2.08179597e+02, -5.51764047e+02, -2.30370796e+02, -1.09815421e+04,
        1.59826402e+03, -9.38758986e+02, -1.63809590e+03, -2.90924194e+03,
       -3.18632742e+03, -7.76755409e+01, -5.09029874e+03, -7.77600543e+01,
       -1.23907427e+03,  1.54912695e+03, -2.17535170e+03,  2.69871867e+03,
       -3.42971202e+03,  2.85113560e+03,  1.92844498e+03,  2.94436051e+03,
       -9.50450830e+02, -3.42619096e+03,  8.57906579e+03, -6.84359481e+03,
        6.93085955e+02,  2.27340928e+03,  1.30094214e+03, -1.05982208e+03,
       -2.40356940e+00, -3.16731506e+02,  5.39713806e+00,  1.70460033e+02,
        3.66953809e+03,  2.87068554e+03,  5.01096094e+02,  4.79271467e+03,
       -2.56057075e+03, -4.93155575e+02, -2.57444958e+02,  3.46511903e+03,
        1.21478436e+03,  1.35937242e+03, -5.34186735e+02,  1.31688866e+04,
        3.66056212e+03,  1.57535732e+03, -3.32409953e+03,  3.02663319e+00,
       -6.39020134e+03, -2.34241421e+03,  7.58684680e+00, -7.17349243e+01,
        3.80577742e+03,  3.88294131e+02, -4.90760447e+00,  2.44578280e+02,
       -6.80424526e+02,  1.48753329e+03,  5.14580309e+03,  4.46021181e+03,
       -2.92525637e+03, -4.46170195e+03,  3.37135266e+03,  3.11189227e+03,
        6.69802534e+03, -4.84478157e+03, -2.94376755e+03,  1.53315187e+03,
       -5.06841756e+03, -1.31149136e+03, -3.98284008e+02,  4.72405675e+02,
        8.85842065e+03, -2.35043027e+03, -5.25159801e+03, -3.83743988e+03,
       -6.42440668e+03, -1.66019062e+04,  1.16320831e+04,  7.23602385e+03,
       -5.76966529e+03, -8.49919768e+03,  1.03302933e+03,  2.22861634e+02,
        1.89644531e+04, -3.95805060e+03, -1.10136109e+04, -4.47071271e+03,
       -1.90627102e+02, -4.94938280e+02, -4.35978191e+02,  2.64097432e+01,
        2.72754715e+02,  1.26769344e+03, -4.41775318e+02,  1.39048575e+02,
       -1.17441720e+02, -2.96286536e+02,  3.09702269e+02, -3.51705371e+02,
       -2.99399496e+02, -5.09732536e+01, -3.25268644e+02, -2.12224338e+02,
        5.27950682e+01, -1.12579749e+03,  2.77360031e+02, -2.36929873e+02,
       -6.10869302e+02, -5.89000574e+02, -3.08569955e+01,  1.74398752e+03,
       -2.10206828e+02, -1.39387578e+02, -2.67153851e+02,  3.86042519e+02,
        2.66750610e+01,  2.34306990e+02,  6.02186866e+02, -6.61568351e+01,
       -4.59029258e+01, -8.94197272e+01, -1.77633081e+01, -2.77547498e+02,
       -1.89415825e+02, -4.35595936e+01, -2.03284805e+02,  1.21061643e+02,
        4.03476638e+02, -1.03548928e+02,  8.83001494e+01, -1.52290401e+01,
       -1.24029258e+01,  4.96884555e+02, -4.30671385e+02,  4.32833126e+02,
       -4.38638975e+02, -8.01877500e+02, -7.81049101e+02,  8.24465958e+01,
        5.05240394e+02, -1.96344244e+02, -2.12716845e+02, -2.11507301e+02,
        4.24911701e+02,  5.48627432e+01,  1.52752409e+02,  7.60140000e+02,
       -3.81484531e+02, -7.28888103e+02,  4.09348021e+02, -4.94004548e+02,
        1.21365934e+02, -1.73375598e+02,  1.32137603e+02,  9.34567864e+01,
        2.82820825e+02,  5.49192058e+01,  4.62769965e+02, -4.78124591e+02,
        6.91191998e+02,  2.19623609e+02, -2.56805098e+02, -1.56123927e+02,
       -1.76697128e+02,  3.43471877e+02, -2.14937825e+02, -3.49629817e+02,
        2.49114571e+02, -1.91443660e+02,  8.43305380e+01, -5.58186229e+01,
        4.23986765e+01, -2.98683924e+02,  2.80207222e+00, -1.91833835e+02,
        1.11612475e+02,  2.27925317e+02, -5.39195212e+01,  1.78354289e+02,
        9.43668637e+03, -5.83400975e+03, -1.04445777e+04, -9.37790941e+03,
       -8.20482491e+03, -1.17750304e+04, -4.00672500e+03, -4.28756304e+03,
       -3.64175009e+03, -2.21529872e+02, -7.93849609e+02, -1.78319724e+04,
       -2.39701674e+02, -1.32181104e+03, -5.73461758e+03, -6.35190825e+03,
       -9.09805430e+03,  2.02815117e+03,  3.14915581e+03,  4.01459900e+03,
        5.80613140e+03,  7.79488485e+03, -6.80758068e+03,  2.67203926e+02,
       -1.52156749e+02, -1.27470538e+03,  7.82885827e+03,  3.99716752e+03,
        8.28755496e+03,  1.16126774e+04, -1.32753782e+03,  2.82260133e+03,
        6.92713885e+03, -8.66506683e+01, -3.37220856e+01, -5.64573639e+03,
       -6.16539708e+03, -4.52780810e+02,  1.84667842e+02,  1.62834845e+03,
       -4.17246607e+01, -1.24036760e+03, -2.27790333e+03,  8.67324955e+02,
       -7.36802645e+01, -9.87557123e+02, -1.27902124e+03, -6.38226833e+03,
        3.53255440e+02,  2.24359128e+03, -3.81763767e+02,  2.37093660e+02,
        1.80692601e+02, -2.58063577e+03,  4.07191763e+02,  1.52360239e+03,
       -4.15470928e+03, -3.13686686e+03, -1.33172242e+03, -2.69238555e+02,
        4.22683543e+02,  2.99026716e+02, -2.47289075e+02, -1.55309423e+02,
       -1.05704658e+03,  2.89403833e+03,  1.98026559e+01,  3.57736786e+03,
        1.96449740e+02,  8.04381266e+01, -1.71075687e+03,  7.23336183e+02,
        6.53582059e+02, -9.23194525e+01,  1.70218968e+00, -9.19750853e+01,
       -5.89394509e+01, -6.57303467e+02,  2.01114578e+02, -3.09074015e+03,
        1.01155791e+03, -1.46866172e+03,  3.59177517e+02,  2.17799706e+02,
        6.29439899e+02, -2.55393699e+02,  5.60866441e+02,  3.36872980e+02,
        5.33731344e+02, -1.08972483e+02, -1.20670351e+03,  3.50265464e+01,
       -5.51234341e+02,  4.13095831e+02,  2.72622972e+03, -3.38317884e+03,
       -1.22023202e+03, -6.81813398e+02, -3.24524881e+03,  2.09060552e+02,
       -2.20354847e+03, -4.60590899e+03, -5.15437227e+02,  5.00861482e+02,
        1.41393565e+03, -5.37058829e+03,  5.85826352e+02,  1.56323880e+02,
       -1.85336866e+03,  8.93625179e+02,  3.59853750e+02,  1.14543957e+02,
        3.86050006e+02,  2.03915797e+03,  8.89239575e+02, -5.76830994e+03,
        3.18314209e+02,  9.36939074e+02,  4.41503492e+02,  1.94862797e+03,
       -3.15525255e+03, -6.90288716e+02, -3.54741110e+02,  5.21721595e+03,
       -5.27386950e+03, -3.50409399e+03,  4.95695009e+03,  2.68045292e+02,
        2.38279207e+03,  2.04594658e+03, -2.43047519e+04,  1.10635213e+04,
        8.78125088e+02,  6.15523874e+03,  4.39616922e+03,  1.36420687e+02,
       -7.76125668e+03,  1.84024000e+01, -2.20866067e-01,  1.17049050e+04,
        1.02644582e+03,  1.24092453e+04,  8.07219973e+03, -6.70683964e+03,
        2.08038125e+02, -8.24937550e+01, -1.05908398e+04, -4.40843395e+03,
        3.94605705e+03, -6.96843726e+03, -1.31201491e+04, -1.06106829e+02,
       -1.32717128e+03, -6.51209060e+02,  1.96419298e+03, -2.27348501e+02,
       -1.69506503e+04, -8.20996738e+02,  2.23870561e+04, -6.85404083e+03,
        1.14963237e+04, -8.18622987e+03,  4.85787796e+03,  4.77844253e+03,
        1.60228678e+02,  1.34889342e+02,  1.11786610e+04,  6.75718396e+03,
       -2.03257405e+03,  1.16286002e+02, -9.96619460e+01,  1.24320075e+01,
       -1.90610456e+02, -2.73397180e+03,  1.30725459e+02,  4.01757841e+02,
        2.37673620e+02, -2.20455600e+00, -3.64194946e+03,  6.30729035e+03,
        2.82761121e+02, -4.07628280e+03,  4.10368370e+03, -6.90369389e+02,
       -4.85172636e+02, -1.25953076e+03,  2.85917263e+03,  8.19704882e+03,
       -1.71079835e+04, -1.77269727e+02,  2.99686388e+02, -2.16107989e+03,
        1.39979227e+03, -7.80223935e+03,  3.72686085e+03, -3.13805419e+03,
        1.92853410e+03,  7.61478303e+02,  5.32387766e+03, -4.42731543e+02,
       -5.29785633e+03, -8.30773133e+02, -2.18543040e+03,  3.05707873e+03,
       -8.24296596e+02,  7.66880150e+03, -9.94483865e+03, -3.95137464e+03,
        3.13380330e+03,  2.99053802e+03, -1.00237532e+04,  4.75799274e+03,
        7.30756134e+03,  2.80158815e+02,  6.16082804e+03,  1.69443156e+03,
        3.76965366e+03,  7.35923427e+03, -4.22394093e+02,  5.35163100e+03,
       -8.37202652e+02, -2.83143518e+02, -9.51343445e+02,  1.17296877e+03,
       -6.41832007e+02,  2.00878811e+03, -1.14062439e+02,  2.90376787e+03,
       -6.38504421e+03,  8.77076918e+02,  7.33452066e+03, -1.66904690e+03,
        2.68486680e+03, -7.52687572e+02, -1.25897319e+03, -7.69797438e+03,
        1.03377027e+03,  4.50681626e+03, -8.79728392e+03,  5.36703657e+02,
        2.08848369e+02,  8.69795300e+03,  2.82640000e+03, -4.74655646e+02,
       -3.29748144e+02, -4.00845490e+03,  1.19393192e+04,  1.06689934e+02,
       -2.62223379e+03, -1.16731777e+02, -1.13014882e+03,  1.03075241e+00])

@unittest.skipIf(os.environ['HAVE_GAP'] != '1', 'GAP support not enabled')
class TestGAP_fit_silion(quippytest.QuippyTestCase):
    
    def test_gap_fit(self):
    
        with open('sparse_file', 'w') as fh:
            for sp in sparse_points:
                fh.write(f'{sp}\n')
                
        command_line = ("at_file=train_sub3.xyz gap={soap l_max=8 n_max=8 atom_sigma=0.5 "
                        "zeta=4 cutoff=4.0 cutoff_transition_width=1.0 central_weight=1.0 "
                        "n_sparse=1000 delta=3.0 f0=0.0 covariance_type=dot_product "
                        "sparse_method=index_file sparse_file=sparse_file} "
                        "default_sigma={0.001 0.1 0.05 0.0} "
                        "energy_parameter_name=dft_energy force_parameter_name=dft_force "
                        "virial_parameter_name=dft_virial config_type_parameter_name=config_type "
                        "sparse_jitter=1.0e-8 e0_offset=2.0 gp_file=gp.xml rnd_seed=1")
        os.system('gap_fit '+command_line)
        
        tree = ET.parse('gp.xml')
        root = tree.getroot()
        gp_label = root.tag
        
        # check GP coefficients match expected values
        idx = np.array([int(tag.attrib['i']) for tag in root[1][1][0].findall('sparseX')])
        idx -= 1 # convert from one- to zero-based indexing
        alpha = np.array([float(tag.attrib['alpha']) for tag in root[1][1][0].findall('sparseX')])
        alpha = alpha[idx] # reorder correctly
        
        # print(repr(alpha))
        # print(alpha - alpha_ref)
        # print(np.abs(alpha - alpha_ref).max())
        print(np.abs((alpha - alpha_ref) / alpha_ref).max())
        assert np.abs((alpha - alpha_ref) / alpha_ref).max() < 1e-2
        
        pot = Potential(f'xml_label={gp_label}', param_filename='gp.xml')
        
        dataset = read('train_sub3.xyz@:')
        for atoms in dataset:
            atoms.calc = pot
            info = {k.lower(): v for k, v in atoms.info.items() }
            arrays = {k.lower(): v for k, v in atoms.arrays.items() }
            energy = atoms.get_potential_energy()
            # atoms.info['gap_energy'] = energy
            forces = atoms.get_forces()
            # atoms.arrays['gap_forces'] = forces        

            # check for consistency with reference GAP model        
            assert abs(atoms.info['gap_energy'] - energy) < 1e-6        
            assert np.abs(atoms.arrays['gap_forces'] - forces).max() < 1e-6

            # check error wrt training data
            de = abs(energy - info['dft_energy']) / len(atoms)
            print(de)
            # assert de < 5e-3
            
            df = np.sqrt(((forces - arrays['dft_force'])**2).mean())
            print(df)
            # assert df < 0.5
            
            if 'dft_virial' in atoms.info:
                stress = atoms.get_stress()        
                virial = - voigt_6_to_full_3x3_stress(stress * atoms.get_volume())
                # atoms.info['gap_virial'] = virial
                assert np.abs(atoms.info['gap_virial'] - virial).max() < 1e-6
                
                dft_virial = info['dft_virial'].reshape((3, 3), order='F')
                dv = np.sqrt(((virial - dft_virial)**2).mean())
                print(dv)
                # assert dv < 10.0
                
        # from ase.io import write
        # write('dump.xyz', dataset)


if __name__ == '__main__':
    unittest.main()
