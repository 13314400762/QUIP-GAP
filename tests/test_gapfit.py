# HQ XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
# HQ X
# HQ X   quippy: Python interface to QUIP atomistic simulation library
# HQ X
# HQ X   Copyright James Kermode 2019
# HQ X
# HQ X   These portions of the source code are released under the GNU General
# HQ X   Public License, version 2, http://www.gnu.org/copyleft/gpl.html
# HQ X
# HQ X   If you would like to license the source code under different terms,
# HQ X   please contact James Kermode, james.kermode@gmail.com
# HQ X
# HQ X   When using this software, please cite the following reference:
# HQ X
# HQ X   http://www.jrkermode.co.uk/quippy
# HQ X
# HQ XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX

import unittest
import os

import xml.etree.ElementTree as ET

import numpy as np
import quippytest

from quippy.potential import Potential
from ase.constraints import voigt_6_to_full_3x3_stress
from ase.io import read

# fixed set of sparse points for training
si_sparse_points = [
    1, 2, 3, 4, 5, 8, 13, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 29, 30, 
    33, 34, 35, 36, 37, 38, 43, 44, 46, 47, 48, 49, 50, 51, 53, 54, 57, 61, 62,
    63, 64, 65, 66, 68, 70, 71, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 84, 85, 
    86, 89, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 107, 108, 109, 110,
    111, 113, 114, 116, 117, 120, 123, 124, 125, 126, 127, 128, 129, 132, 133, 134, 
    137, 142, 143, 144, 145, 146, 147, 148, 149, 150, 151, 152, 154, 155, 156, 157, 
    158, 159, 161, 163, 164, 167, 168, 169, 181, 182, 183, 185, 187, 190, 192, 194, 
    195, 196, 197, 205, 207, 210, 217, 218, 225, 233, 238, 249, 254, 256, 262, 274, 
    286, 288, 294, 297, 303, 311, 312, 316, 317, 321, 333, 336, 338, 345, 346, 352, 
    369, 371, 373, 377, 378, 381, 383, 384, 396, 397, 406, 409, 411, 416, 420, 424, 
    427, 437, 438, 442, 447, 449, 462, 466, 474, 476, 481, 482, 485, 487, 490, 492, 
    502, 503, 504, 506, 509, 511, 515, 525, 527, 532, 541, 550, 553, 554, 556, 557, 
    559, 566, 567, 570, 571, 573, 574, 576, 577, 581, 593, 594, 595, 596, 597, 598, 
    599, 600, 601, 603, 606, 608, 611, 612, 615, 617, 648, 652, 656, 659, 663, 665, 
    672, 673, 675, 676, 682, 683, 684, 685, 693, 701, 705, 721, 725, 726, 728, 738, 
    742, 743, 744, 757, 765, 766, 767, 774, 775, 785, 794, 797, 805, 810, 812, 817, 
    818, 819, 820, 821, 822, 823, 824, 825, 826, 827, 828, 829, 830, 831, 832, 833, 
    834, 835, 836, 837, 838, 839, 840, 841, 842, 843, 844, 845, 846, 847, 848, 849, 
    851, 852, 853, 854, 855, 856, 857, 858, 859, 860, 861, 862, 863, 864, 865, 866, 
    867, 868, 869, 870, 871, 872, 873, 874, 875, 876, 877, 878, 879, 880, 881, 882, 
    883, 884, 885, 887, 888, 889, 890, 891, 892, 893, 894, 895, 896, 897, 899, 901, 
    902, 903, 904, 905, 907, 908, 909, 910, 911, 912, 913, 917, 918, 923, 929, 931, 
    933, 934, 938, 945, 947, 949, 952, 955, 956, 958, 962, 963, 969, 974, 975, 976, 
    977, 980, 982, 983, 984, 991, 993, 1005, 1007, 1009, 1012, 1013, 1016, 1018, 1020, 
    1021, 1023, 1024, 1025, 1026, 1028, 1035, 1036, 1039, 1041, 1044, 1046, 1048, 1051, 
    1054, 1055, 1060, 1074, 1076, 1081, 1083, 1085, 1088, 1091, 1094, 1096, 1097, 1100,
    1101, 1105, 1106, 1109, 1113, 1114, 1119, 1122, 1124, 1126, 1127, 1128, 1129, 1130,
    1132, 1139, 1147, 1152, 1154, 1162, 1176, 1177, 1182, 1183, 1194, 1195, 1196, 1197, 
    1198, 1199, 1200, 1201, 1202, 1203, 1204, 1205, 1206, 1207, 1208, 1210, 1211, 1212, 
    1213, 1214, 1215, 1216, 1217, 1219, 1221, 1222, 1223, 1224, 1225, 1227, 1228, 1229,
    1230, 1231, 1232, 1234, 1235, 1236, 1237, 1238, 1239, 1240, 1241, 1242, 1243, 1245, 
    1246, 1247, 1248, 1249, 1250, 1251, 1252, 1253, 1254, 1255, 1256, 1257, 1259, 1260, 
    1261, 1262, 1263, 1264, 1266, 1267, 1271, 1273, 1274, 1275, 1277, 1278, 1279, 1280, 
    1281, 1282, 1283, 1284, 1285, 1286, 1287, 1288, 1289, 1290, 1294, 1295, 1296, 1297, 
    1298, 1299, 1300, 1301, 1305, 1306, 1307, 1308, 1309, 1310, 1313, 1314, 1316, 1317, 
    1318, 1320, 1321, 1322, 1323, 1324, 1329, 1330, 1331, 1333, 1334, 1339, 1340, 1341, 
    1342, 1343, 1348, 1349, 1354, 1361, 1363, 1365, 1368, 1369, 1373, 1381, 1386, 1391, 
    1392, 1398, 1399, 1402, 1403, 1407, 1411, 1413, 1414, 1421, 1423, 1424, 1427, 1429,
    1430, 1434, 1437, 1451, 1452, 1453, 1456, 1459, 1460, 1462, 1465, 1466, 1470, 1471,
    1475, 1477, 1479, 1484, 1488, 1490, 1499, 1501, 1502, 1506, 1507, 1508, 1513, 1516,
    1517, 1520, 1521, 1526, 1528, 1542, 1544, 1546, 1548, 1551, 1553, 1563, 1570, 1571,
    1575, 1579, 1582, 1584, 1597, 1598, 1601, 1603, 1607, 1622, 1631, 1633, 1647, 1653,
    1655, 1659, 1660, 1677, 1692, 1694, 1703, 1704, 1705, 1722, 1743, 1744, 1747, 1748,
    1750, 1755, 1756, 1758, 1759, 1760, 1762, 1763, 1764, 1766, 1767, 1768, 1769, 1770,
    1771, 1772, 1773, 1774, 1775, 1776, 1777, 1778, 1779, 1781, 1782, 1783, 1784, 1785,
    1786, 1787, 1788, 1789, 1790, 1791, 1792, 1793, 1794, 1795, 1796, 1797, 1799, 1800,
    1801, 1802, 1803, 1804, 1805, 1807, 1808, 1809, 1810, 1812, 1813, 1814, 1815, 1816,    
    1818, 1819, 1820, 1821, 1824, 1825, 1827, 1828, 1829, 1830, 1831, 1832, 1833, 1835, 
    1836, 1837, 1838, 1839, 1840, 1841, 1843, 1845, 1846, 1847, 1848, 1849, 1850, 1851, 
    1853, 1854, 1855, 1873, 1879, 1886, 1892, 1895, 1896, 1901, 1903, 1913, 1921, 1922, 
    1923, 1925, 1932, 1943, 1951, 1965, 1975, 1978, 1980, 2004, 2015, 2017, 2019, 2020, 
    2021, 2025, 2028, 2031, 2034, 2043, 2046, 2047, 2049, 2050, 2054, 2061, 2067, 2068, 
    2069, 2072, 2073, 2075, 2076, 2077, 2079, 2081, 2084, 2086, 2088, 2090, 2092, 2093, 
    2094, 2095, 2097, 2099, 2106, 2108, 2109, 2110, 2111, 2113, 2114, 2116, 2117, 2118, 
    2122, 2123, 2124, 2125, 2126, 2127, 2128, 2129, 2130, 2131, 2132, 2133, 2135, 2144, 
    2145, 2146, 2147, 2148, 2149, 2151, 2152, 2158, 2161, 2163, 2164, 2165, 2166, 2168, 
    2169, 2170, 2171, 2176, 2177, 2179, 2181, 2185, 2186, 2189, 2191, 2192, 2195, 2196, 
    2197, 2202, 2205, 2206, 2209, 2210, 2211, 2213, 2217, 2218, 2219, 2220, 2221, 2224, 
    2231, 2233, 2234, 2235, 2236, 2237, 2238, 2239, 2240, 2246, 2248, 2249, 2251, 2253, 
    2255, 2256, 2257, 2259, 2267, 2273, 2274, 2289, 2292, 2296, 2303, 2305, 2306, 2307, 
    2308, 2319, 2326, 2329, 2330, 2332, 2333, 2334, 2335, 2346, 2349, 2354, 2357, 2362, 
    2365, 2374, 2379, 2388, 2397, 2398, 2401, 2403, 2404, 2405, 2406, 2407, 2408, 2409, 
    2410, 2411, 2413, 2416, 2422, 2424, 2426, 2429, 2434, 2437, 2448, 2454, 2455, 2456, 
    2459, 2460, 2461, 2463, 2464, 2469, 2474, 2476, 2478, 2481, 2482, 2484, 2489, 2491, 
    2494, 2495, 2499, 2503, 2504, 2508, 2513, 2517, 2520, 2522, 2524, 2525, 2531, 2534, 
    2535, 2536, 2538, 2549, 2552, 2553, 2555, 2556, 2563, 2565, 2566, 2567, 2568, 2569, 
    2570, 2578, 2585, 2587, 2589, 2591, 2593, 2596, 2598, 2600, 2605, 2609, 2610, 2612, 
    2613, 2617, 2619
]


# expected fit coefficients
si_alpha_ref = np.array([
       -2.26193663e-02, -1.08708205e+02, -9.30717291e+02, -2.03422539e+02,
       -1.08696877e+02,  2.03893013e+03,  4.77583523e+02, -2.15857386e+02,
       -5.63593208e+02,  2.07441453e+02, -2.49197320e+02, -6.31874413e+02,
       -3.21913353e+02,  1.14955119e+02, -1.52022880e+03,  7.61002363e+03,
        3.05960810e+02,  5.63061861e+03, -4.83455500e+03, -7.76051528e+01,
       -7.81416644e+01, -7.32963338e+01,  5.70900899e+01, -7.47272029e+01,
       -5.69140260e+02,  2.38023777e+02, -5.91230837e+02, -1.89397097e+03,
       -3.23672088e+02,  7.87375530e+02,  5.15558088e+02,  2.67338015e+00,
       -1.58010609e+02,  5.49767775e+02, -1.91169540e+02,  5.34942055e+01,
        1.04945285e+03,  1.30821917e+04, -1.35913603e+02, -2.56846273e+02,
       -3.71729156e+02,  2.30061131e+02,  1.80385827e+02, -1.32628107e+02,
        6.38465068e+02, -1.17369065e+04,  3.43001485e+03,  1.37836200e+03,
       -5.22903935e+01,  2.67402910e+01,  3.85282213e+02,  1.04999297e+02,
        1.35653296e+01,  1.21198363e+02,  7.93968945e+01,  7.38543256e+01,
       -5.05498103e+02,  2.42349479e+03, -5.00541298e+01, -8.02544749e+03,
        4.80353959e+01,  9.19408611e+02, -2.73738610e+02,  3.88801376e+02,
        5.03253335e+01, -2.20219747e+02,  1.33645276e+01, -3.48215782e+02,
       -4.13869738e+02, -1.26125636e+01,  4.48246909e+01, -8.60991490e+02,
       -3.09979067e+02, -5.18606707e+02, -1.38867692e+02, -4.42812083e+02,
        3.84083086e+02, -2.34347811e+02, -1.69553391e+02, -5.26601917e+01,
       -3.44287370e+02, -2.68437443e+02,  4.90694171e+02,  5.97362009e+02,
        3.97767377e+02,  1.85658305e+02, -3.00226404e+02,  5.04474577e+02,
        3.23839812e+02,  4.66772709e+02,  1.71733784e+03,  2.43855454e+02,
        9.02836366e+02,  1.74328303e+02,  4.40673664e+02,  2.30328785e+02,
        1.69321538e+02, -3.07727494e+02,  3.75980430e+02,  4.66463637e+02,
       -1.73092354e+02,  2.58583335e+02, -1.61462604e+02, -9.53254833e+02,
       -6.98180661e+02, -3.81121914e+02,  1.36091561e+03,  4.82341030e+02,
        8.63022631e+02, -8.70145604e+02, -6.58894807e+02,  7.76470229e+02,
       -2.14792853e+03,  4.67772981e+03,  9.40091725e+02,  4.99624967e+03,
       -1.52490348e+03, -1.24022319e+04,  2.37035435e+03,  4.82682765e+03,
       -9.20550735e+03,  4.29814072e+03, -1.77905601e+04,  1.27690796e+04,
       -6.58493190e+03,  4.05142685e+03,  1.35098856e+03,  1.56432038e+03,
        1.09022808e+04, -6.99391998e+03,  9.18629199e+03, -7.30875183e+02,
       -1.69615361e+03,  1.32861242e+02, -7.73336552e+02,  3.75523169e+02,
        9.38363616e+02, -1.13750163e+04, -4.41345655e+03, -2.75027787e+03,
       -1.78897056e+03, -2.98018706e+03,  4.76578703e+03, -3.59619809e+03,
        1.42593583e+02,  2.02928034e+03, -1.83987746e+04, -8.29037101e+02,
        4.58938417e+03,  5.93556773e+03, -1.44028217e+03,  8.70776185e+03,
       -9.08628542e+03,  1.23296581e+03,  4.53496463e+03, -2.67322016e+03,
        5.72892868e+03,  2.90920781e+03,  1.19086315e+03,  4.45131890e+03,
       -5.24263390e+02, -1.27021817e+04, -8.93803611e+03,  4.87302707e+03,
       -1.30296503e+03,  7.31812768e+00,  4.58847652e+03,  1.94182562e+04,
        6.33576364e+03, -5.60636677e+03,  1.00485813e+04,  2.33452615e+03,
       -2.53093336e+03,  1.78461483e+04,  1.04785553e+04, -9.26856004e+03,
       -2.95516458e+01,  2.39260321e+02, -1.76398360e+03,  5.59553882e+02,
       -1.45494456e+03,  3.88341763e+02,  5.56880574e+02, -1.50819166e+02,
       -1.40207677e+03, -2.83866621e+03,  7.22730462e+02,  2.16521747e+03,
       -1.57793779e+03,  1.03266868e+03,  2.86993206e+02,  9.67892745e+02,
       -7.31367320e+01,  3.14784134e+03,  2.27222250e+03, -1.65385496e+02,
       -7.96992126e+02, -2.29494999e+03, -9.89445149e+02,  1.01767007e+03,
        1.94798979e+03, -3.33344727e+02, -2.31130680e+03,  6.73658669e+02,
        1.33890143e+03, -1.54833934e+02,  6.99575420e+02,  2.60970221e+03,
       -3.81064391e+02,  1.91995524e+03, -7.08287210e+02, -3.64701600e+03,
       -1.90275276e+02,  1.07677275e+03, -2.15774084e+03, -2.15510402e+02,
       -1.05024151e+02, -3.44175821e+01, -1.52286178e+02,  1.04727902e+02,
        3.36770156e+02,  3.28789105e+02,  4.97474186e+01, -2.04645323e+02,
       -7.27341635e+02,  3.33951228e+03, -1.35143693e+04, -3.73389151e+03,
       -1.42962576e+04, -7.92034463e+03, -2.92977589e+03,  3.43091693e+02,
        2.72705990e+03, -1.06362360e+04, -1.27133086e+04, -1.06500776e+04,
        1.58387182e+03,  1.58213727e+02, -2.11939187e+02,  1.26368164e+03,
        7.81250701e+03,  1.98778669e+03,  1.60716495e+02, -1.96000113e+03,
        4.70447238e+03, -2.68472280e+03, -5.30643263e+02, -5.41430656e+03,
        1.93009590e+03, -1.18795888e+03,  1.11572371e+03,  2.78761549e+03,
        1.76134817e+04, -1.06514737e+04,  1.20262751e+04,  1.80077694e+04,
        9.98994233e+03, -1.11809023e+03,  5.50297794e+02, -5.65953051e+03,
        6.86895952e+03,  5.83559645e+03, -3.30407275e+03,  1.17905646e+02,
        3.22922792e+03, -2.20094373e+03,  1.22446992e+04, -1.82579293e+01,
        9.46820817e+01, -9.10606096e+00, -7.17697704e+01,  2.32016145e+02,
        5.24892595e+01,  5.55070422e+01, -2.04554243e+01,  1.09417535e+02,
       -2.76243419e+02, -8.48499833e+01, -2.57497647e+02,  7.36318889e+00,
        1.17498386e+02,  6.72245889e+01, -1.97821178e+02, -8.45930642e+00,
        1.82124173e+01,  8.61310626e+02,  1.64277450e+01,  3.40292816e+02,
        1.88818445e+02,  5.10956564e+02,  6.04762906e+01, -1.90930386e+02,
       -2.72028528e+01,  2.92953770e+01, -1.67775123e+02, -2.20771927e+02,
       -1.17880505e+02, -3.70871121e+02,  5.03076165e+02,  1.58383117e+02,
       -3.58781568e+01,  5.52923856e+02, -3.45544228e+01,  4.10169463e+02,
        9.22450012e+01, -7.33311632e+01,  7.29551905e+01, -2.13100636e+01,
        3.48970094e+02,  1.35637249e+02,  1.59398745e+02,  5.24236532e+02,
        1.80000415e+02, -9.65010119e+00, -1.97054717e+02, -1.92331496e+02,
        8.45721101e+01,  3.17695822e+02,  6.80341845e+01,  7.59558862e+01,
        1.34351110e+02, -3.79262116e+02, -1.33449765e+02,  2.92346983e+01,
       -1.05366330e+02,  6.78431900e+00,  4.09352477e+02,  1.07561905e+02,
        1.20681503e+01,  1.70967557e+02, -4.33323731e+02,  2.22835992e+01,
       -2.33552776e+01, -1.57529796e+02,  5.30449972e+01,  1.90470794e+02,
       -3.84383376e+01, -1.28245833e+02,  5.54482672e+02, -8.13182754e+01,
       -1.18837530e+03,  1.08100676e+01,  9.79842396e+01,  1.36543731e+03,
        1.90646720e+02,  2.09418613e+03,  3.93705007e+01,  5.39852368e+01,
        1.35130335e+02,  5.19777820e+01,  8.27649997e+01, -4.40228398e+00,
       -2.74721918e+03, -6.95473832e-01, -1.94524919e+01, -1.14961338e+02,
       -6.03487424e+01,  7.22434793e+00, -2.41717624e+01, -2.72323244e+03,
        7.94933286e+03, -3.31838741e+03, -8.23777607e+03, -2.43342691e+03,
        8.43302712e+03, -7.92287569e+03,  3.58395709e+03, -2.74435300e+02,
        1.94337209e+03,  1.79022037e+03, -6.65212919e+03, -7.04007321e+02,
       -2.10744040e+03, -9.12146314e+02,  6.39252023e+02, -5.75581127e+03,
       -8.94413993e+03, -7.79330318e+03, -4.38282933e+03, -4.14291895e+03,
        6.61790803e+03, -1.50356459e+03,  1.78424134e+03, -2.11008640e+02,
        3.34631900e+03,  6.02500835e+03,  5.11274849e+02,  3.53809809e+03,
       -1.32456887e+03, -9.06682771e+03,  4.23028624e+03, -9.21659779e+03,
       -1.34197678e+03,  3.82875822e+03, -2.95588989e+02,  2.20997814e+02,
       -1.97399764e+02, -1.37133247e+04,  6.78322684e+00, -5.23687631e+01,
        1.75177147e+03,  1.12803235e+04,  1.42017906e+04,  4.99537993e+03,
       -3.28050134e+03, -2.60022581e+03, -1.78406561e+03,  2.82539998e+03,
        5.71221552e+02, -1.90489942e+03,  2.94149873e+03, -1.34874505e+03,
        2.92524371e+03, -3.44481799e+02,  1.32837581e+04, -2.30026764e+03,
        7.70529101e+03,  4.41580184e+03,  4.62509128e+03, -2.70512198e+03,
        4.37492262e+03, -5.22411590e+02,  4.38340819e+03, -1.09026708e+03,
        5.97099297e+03, -2.68328711e+01,  6.58505921e+02,  7.91232185e+03,
        2.45072103e+03, -1.62191693e+03,  1.53377635e+03,  2.52441176e+03,
        1.04274262e+02,  2.07831796e+01, -3.66198454e+01,  3.66887610e+01,
       -1.61349584e+01,  1.09684632e+02, -1.08920676e+03, -1.79797320e+04,
        8.69680130e+03,  2.19329638e+02, -4.52445307e+02,  6.82294758e+01,
        2.01341931e+04,  3.84298658e+02, -1.22340456e+04, -2.39593639e+02,
       -6.53069202e+01, -2.39558664e+02,  3.84431585e+02,  2.78649141e+02,
       -1.55512795e+02, -5.66457454e+01,  2.28699360e+02, -3.20822063e+02,
        3.65352418e+02, -6.57383246e+01,  3.39702017e+02, -5.48549449e+01,
       -1.49467490e+03, -6.18184115e+02,  2.30790455e+02,  1.07073132e+02,
       -6.95978765e+01,  1.44825882e+02,  1.37940597e+02, -1.69044847e+02,
        1.06686129e+00, -1.50675193e+01, -4.14645385e+02, -5.68184905e+02,
       -2.12625835e+02,  1.48494514e+01,  2.22496773e+02, -6.09956725e+01,
       -2.34091508e+01, -6.44754442e+01, -2.75190002e+02,  5.39740524e+02,
        1.30754556e+03,  2.74636509e+02, -2.78881139e+02, -2.05693230e+02,
       -3.13815159e+01, -4.44744283e+01,  2.70375417e+02, -3.24739796e+01,
       -2.44994942e+02,  2.30114281e+02, -3.19403841e+02, -1.59601909e+03,
        3.59852720e+02, -6.20962449e+01,  4.03320075e+01,  4.66700504e+01,
        2.91234295e+01, -7.39348034e+01,  1.28765557e+02, -1.23320987e+02,
       -8.85424417e+00,  6.01175782e+02,  8.53434034e+02,  2.80169791e+02,
       -3.83489924e+01, -1.51804867e+02, -5.31324452e+02,  4.85131412e+01,
        2.51674215e+02,  6.56752598e+01,  8.11734081e+01,  3.14735695e+03,
        2.45585249e+03,  1.12212951e+02, -8.63095886e+01,  2.71578667e+02,
        8.93588365e+02, -3.75287499e+02, -5.89749906e+00, -5.43507797e+02,
        1.22216873e+03,  1.21437210e+02, -7.52372203e+02,  1.22022089e+02,
        7.42455768e+02,  2.93680366e+02, -9.15451072e+01,  9.85931260e+01,
       -2.93480254e+01,  1.32272356e+02,  1.61084181e+01, -1.04356261e+02,
        2.08303081e+01, -1.95955248e+02, -3.62550644e+01,  1.61050494e+01,
       -1.83797425e+02,  4.38628815e+01, -8.47381258e+03, -4.72706448e+01,
       -3.08976901e+02, -1.70818292e+02, -9.54004507e+01, -1.42060938e+01,
        4.38333470e+02, -1.87026807e+02, -3.05616127e+02,  2.12420894e+03,
       -6.78287178e+01, -7.54311273e+01,  2.37576962e+03, -1.08727552e+02,
        9.37027869e+02, -7.60543350e+03,  2.38740591e+03, -3.98426797e+03,
        2.58870513e+02, -8.26265230e+03,  1.43493461e+03, -3.28953927e+02,
       -3.70441848e+01, -1.24798426e+03, -1.86004707e+02, -1.71148983e+03,
       -1.10903343e+03,  3.84028760e+03, -5.30265973e+03, -5.13095091e+03,
        1.95363303e+02, -3.91412821e+02, -2.49980456e+02, -1.14675655e+04,
        1.58197289e+03, -9.80361774e+02, -1.39342537e+03, -2.94342006e+03,
       -3.20562537e+03,  7.72142138e+01, -4.93084791e+03, -2.48104395e+02,
       -1.37747609e+03,  1.52954630e+03, -2.87163561e+03,  2.76638349e+03,
       -3.35413878e+03,  2.67080283e+03,  2.14152531e+03,  3.07896564e+03,
       -1.16441028e+03, -3.12279349e+03,  8.33670706e+03, -6.75882886e+03,
        6.85379230e+02,  2.38809217e+03,  1.24203412e+03, -1.10327653e+03,
        3.18935740e+01, -2.97389594e+02, -2.41208067e+01,  1.70805539e+02,
        3.64141238e+03,  2.87072985e+03,  4.67003982e+02,  4.78328776e+03,
       -2.59026047e+03, -5.12356022e+02, -9.58183071e+01,  3.47939142e+03,
        1.29108299e+03,  1.47025316e+03, -2.69474901e+02,  1.32178972e+04,
        3.55206161e+03,  1.53181679e+03, -3.14478446e+03,  9.44811921e+00,
       -5.97421253e+03, -2.19247457e+03, -1.06532110e+01, -1.02444658e+02,
        3.52394610e+03,  3.75817361e+02, -2.45342975e+00,  2.67999421e+02,
       -4.77037952e+02,  1.50403832e+03,  5.34544212e+03,  4.55607276e+03,
       -2.61077973e+03, -3.40751960e+03,  3.16817755e+03,  3.73726565e+03,
        6.98599424e+03, -4.29547250e+03, -2.64736033e+03,  1.12698334e+03,
       -5.20207461e+03, -1.28254383e+03, -4.19811399e+02,  6.35024598e+02,
        8.98580258e+03, -2.24087904e+03, -5.31397469e+03, -3.89893617e+03,
       -5.99908383e+03, -1.66450267e+04,  1.14080968e+04,  7.82896076e+03,
       -5.82329642e+03, -8.42992555e+03,  1.22264357e+03,  2.32424780e+02,
        1.86137061e+04, -3.90028213e+03, -1.16471727e+04, -4.63369113e+03,
       -1.87263380e+02, -4.84954730e+02, -3.44443654e+02, -1.46942378e+01,
        2.73644060e+02,  1.24472624e+03, -4.72987628e+02,  1.04564426e+02,
       -1.11140417e+02, -2.83470498e+02,  3.04893157e+02, -3.63820571e+02,
       -2.88535796e+02, -2.60673881e+01, -3.74847190e+02, -2.19992042e+02,
        4.89488597e+01, -1.11680219e+03,  2.56411983e+02, -2.15772220e+02,
       -6.11684948e+02, -5.66979945e+02, -1.85337035e+01,  1.77456442e+03,
       -2.22759730e+02, -1.49877480e+02, -2.60995493e+02,  3.61534705e+02,
        1.76772094e+01,  2.31508913e+02,  5.92617654e+02, -6.24814871e+01,
       -4.49980138e+01, -6.94157389e+01, -1.29192891e+01, -2.64602755e+02,
       -1.86623116e+02, -5.73421195e+01, -2.19328928e+02,  1.24016260e+02,
        3.65041440e+02, -9.96558771e+01,  9.57669204e+01, -2.85552423e+01,
       -1.90484566e+01,  4.44106898e+02, -4.54964617e+02,  4.39549293e+02,
       -4.45750791e+02, -7.83436623e+02, -7.79903231e+02,  8.35508919e+00,
        4.86410932e+02, -1.85523826e+02, -2.01032848e+02, -2.22809374e+02,
        4.14825403e+02,  5.75962357e+01,  1.48166496e+02,  7.73298099e+02,
       -3.65861063e+02, -6.84850195e+02,  4.35236520e+02, -4.84800746e+02,
        1.02311680e+02, -1.65407802e+02,  1.35187853e+02,  9.23860955e+01,
        2.15947653e+02,  5.73375971e+01,  4.33947232e+02, -4.62862822e+02,
        6.88804300e+02,  2.30323630e+02, -2.39520360e+02, -1.28526748e+02,
       -1.69025893e+02,  3.15503925e+02, -2.06729445e+02, -3.13874717e+02,
        2.72708636e+02, -1.84865187e+02,  9.25643138e+01,  1.70254295e+01,
        4.93378554e+01, -2.89814787e+02, -2.47685137e+00, -1.98318229e+02,
        1.12247669e+02,  1.74582141e+02, -5.31352294e+01,  1.92392338e+02,
        9.85343385e+03, -5.94498912e+03, -9.79235356e+03, -9.82987846e+03,
       -8.37068859e+03, -1.20404606e+04, -3.88744725e+03, -4.11363885e+03,
       -3.32313722e+03, -1.32514459e+02, -7.55022210e+02, -1.81688074e+04,
       -2.33500453e+02, -1.27802758e+03, -6.24147080e+03, -5.94121785e+03,
       -8.25009630e+03,  2.03887718e+03,  3.33963735e+03,  3.55461288e+03,
        6.53307441e+03,  7.66184466e+03, -7.39677375e+03,  2.40515952e+02,
       -1.25971120e+02, -1.83513744e+03,  7.94313242e+03,  3.12747831e+03,
        8.48586795e+03,  1.16296296e+04, -9.39280757e+02,  2.81054524e+03,
        6.99542500e+03, -8.09304400e+01, -1.97083769e+01, -5.91255331e+03,
       -6.13765124e+03, -1.81286216e+02,  1.40305517e+02,  1.78762517e+03,
       -7.31168660e+01, -1.70669969e+03, -2.15392984e+03,  8.24185961e+02,
       -1.08268438e+02, -9.54277505e+02, -8.95975224e+02, -6.02967294e+03,
        2.88952188e+02,  2.56482731e+03, -3.24649322e+02,  2.58739996e+02,
        1.55850526e+02, -2.63890275e+03,  3.10771295e+02,  1.86387849e+03,
       -3.87204046e+03, -3.03167944e+03, -1.26982027e+03, -2.10050195e+02,
        4.32385645e+02,  3.02056145e+02, -2.40230257e+02, -1.37953133e+02,
       -1.04795284e+03,  2.82892048e+03,  6.78847689e+01,  3.69099689e+03,
        1.91041061e+02,  7.25290386e+01, -1.71349668e+03,  8.13518471e+02,
        5.88573506e+02, -1.21768221e+02,  2.68634874e+01, -9.19051729e+01,
       -5.93890390e+01, -6.15015510e+02,  1.57262376e+02, -3.23477112e+03,
        1.03533176e+03, -1.52170889e+03,  3.31178921e+02,  2.72325879e+02,
        6.09406638e+02, -2.82496371e+02,  4.52401499e+02,  3.24631766e+02,
        3.49088517e+02, -9.92767941e+01, -1.24464592e+03,  1.12053218e+00,
       -5.73304607e+02,  3.70126896e+02,  2.56479658e+03, -3.43912714e+03,
       -1.20738822e+03, -7.94828592e+02, -3.12913078e+03,  2.06073657e+02,
       -2.08091012e+03, -4.31048397e+03, -4.78361315e+02,  4.83711468e+02,
        1.62460211e+03, -5.11774191e+03,  5.95623464e+02,  1.55338258e+02,
       -1.87083194e+03,  8.11260848e+02,  5.86583429e+02,  2.27675614e+02,
        2.69729472e+02,  2.05116461e+03,  7.99469432e+02, -5.50400063e+03,
        3.30518118e+02,  1.01447307e+03,  4.83075896e+02,  1.58096702e+03,
       -3.13348484e+03, -5.99806209e+02, -1.40300354e+02,  5.13375924e+03,
       -5.20496649e+03, -3.15771497e+03,  5.06348790e+03,  7.19454126e+01,
        2.18907239e+03,  2.07660100e+03, -2.57364427e+04,  1.10840982e+04,
        1.22309633e+03,  5.87870423e+03,  4.05109362e+03,  1.55295647e+02,
       -7.02027875e+03,  1.80186951e+01,  1.06110835e+00,  1.15072543e+04,
        1.21070996e+03,  1.27834002e+04,  8.00572419e+03, -6.74694222e+03,
        1.98743372e+02, -8.97594424e+01, -1.05852536e+04, -4.46629307e+03,
        4.36906543e+03, -6.33315638e+03, -1.27443213e+04,  8.66426420e+02,
       -7.93940341e+02, -6.21633802e+02,  2.02228104e+03, -1.55717598e+02,
       -1.71141931e+04, -8.38201448e+02,  2.23492334e+04, -6.96396591e+03,
        1.14841629e+04, -8.80858051e+03,  4.44198702e+03,  5.06582686e+03,
        1.58186386e+02,  1.57681363e+02,  9.86318584e+03,  6.07132963e+03,
       -2.14911480e+03,  7.76188987e+01, -1.00191805e+02,  1.27875766e+01,
       -1.94432485e+02, -2.75176902e+03,  1.41709427e+02,  4.01618812e+02,
        2.59772437e+02,  6.61190612e+01, -3.39531347e+03,  5.94014052e+03,
        2.77741924e+02, -4.59464686e+03,  3.98511068e+03, -7.22041965e+02,
       -9.60609643e+01, -1.23617993e+03,  2.72898032e+03,  7.89703729e+03,
       -1.68628160e+04, -1.03572661e+02,  3.18896753e+02, -2.13211011e+03,
        1.25921350e+03, -7.64722843e+03,  3.64666068e+03, -2.92759287e+03,
        1.97812412e+03,  6.86433336e+02,  5.28307517e+03, -4.50009774e+02,
       -5.27806291e+03, -7.35944533e+02, -1.90735374e+03,  3.07793142e+03,
       -6.79522077e+02,  7.42920356e+03, -1.04325852e+04, -3.93172493e+03,
        3.21042462e+03,  2.74712666e+03, -9.55509582e+03,  4.64928666e+03,
        7.26251281e+03,  4.40489913e+02,  6.06374261e+03,  1.71178782e+03,
        3.33905478e+03,  6.74089457e+03, -6.22006611e+02,  5.25616003e+03,
       -8.47344222e+02, -2.78340261e+02, -9.70536807e+02,  1.16650359e+03,
       -6.90805926e+02,  1.93848107e+03, -1.19224586e+02,  2.93136334e+03,
       -6.29437994e+03,  8.02019446e+02,  6.87267594e+03, -1.77923469e+03,
        2.45237633e+03, -7.71657153e+02, -1.30738011e+03, -7.91669786e+03,
        8.75951729e+02,  4.19450826e+03, -8.54418631e+03,  5.66627420e+02,
        3.64090782e+02,  8.58755953e+03,  2.61501917e+03, -6.87543437e+02,
       -3.30266373e+02, -3.59005100e+03,  1.20541058e+04,  1.16239251e+02,
       -2.86845039e+03, -1.50057377e+02, -1.27052860e+03,  1.42613901e-01])

@unittest.skipIf(os.environ['HAVE_GAP'] != '1', 'GAP support not enabled')
class TestGAP_fit(quippytest.QuippyTestCase):
    
    def check_gap_fit(self, command_line, sparse_points, alpha_ref, training_filename):
    
        with open('sparse_file', 'w') as fh:
            for sp in sparse_points:
                fh.write(f'{sp}\n')                
        os.system('gap_fit '+command_line)
        
        tree = ET.parse('gp.xml')
        root = tree.getroot()
        gp_label = root.tag
        
        # check GP coefficients match expected values
        idx = np.array([int(tag.attrib['i']) for tag in root[1][1][0].findall('sparseX')])
        idx -= 1 # convert from one- to zero-based indexing
        alpha = np.array([float(tag.attrib['alpha']) for tag in root[1][1][0].findall('sparseX')])
        alpha = alpha[idx] # reorder correctly
        assert np.abs((alpha - alpha_ref) / alpha_ref).max() < 1e-5
        
        pot = Potential(f'xml_label={gp_label}', param_filename='gp.xml')
        
        dataset = read(f'{training_filename}@:')
        for atoms in dataset:
            atoms.calc = pot
            info = {k.lower(): v for k, v in atoms.info.items() }
            arrays = {k.lower(): v for k, v in atoms.arrays.items() }
            energy = atoms.get_potential_energy()
            atoms.info['gap_energy'] = energy
            forces = atoms.get_forces()
            atoms.arrays['gap_forces'] = forces        

            # check for consistency with reference GAP model        
            assert abs(atoms.info['gap_energy'] - energy) < 1e-6        
            assert np.abs(atoms.arrays['gap_forces'] - forces).max() < 1e-6
            
            if 'dft_virial' in atoms.info:
                stress = atoms.get_stress()
                virial = - voigt_6_to_full_3x3_stress(stress * atoms.get_volume())
                atoms.info['gap_virial'] = virial
                assert np.abs(atoms.info['gap_virial'] - virial).max() < 1e-6

    def test_gap_fit_silicon(self):
        command_line = ("at_file=train_sub3.xyz gap={soap l_max=8 n_max=8 atom_sigma=0.5 "
                        "zeta=4 cutoff=4.0 cutoff_transition_width=1.0 central_weight=1.0 "
                        "n_sparse=1000 delta=3.0 f0=0.0 covariance_type=dot_product "
                        "sparse_method=index_file sparse_file=sparse_file} "
                        "default_sigma={0.001 0.1 0.05 0.0} "
                        "energy_parameter_name=dft_energy force_parameter_name=dft_force "
                        "virial_parameter_name=dft_virial config_type_parameter_name=config_type "
                        "sparse_jitter=1.0e-8 e0_offset=2.0 gp_file=gp.xml rnd_seed=1")
        self.check_gap_fit(command_line, si_sparse_points, si_alpha_ref, 'train_sub3.xyz')

if __name__ == '__main__':
    unittest.main()
