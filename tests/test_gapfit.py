# HQ XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
# HQ X
# HQ X   quippy: Python interface to QUIP atomistic simulation library
# HQ X
# HQ X   Copyright James Kermode 2019
# HQ X
# HQ X   These portions of the source code are released under the GNU General
# HQ X   Public License, version 2, http://www.gnu.org/copyleft/gpl.html
# HQ X
# HQ X   If you would like to license the source code under different terms,
# HQ X   please contact James Kermode, james.kermode@gmail.com
# HQ X
# HQ X   When using this software, please cite the following reference:
# HQ X
# HQ X   http://www.jrkermode.co.uk/quippy
# HQ X
# HQ XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX

import unittest
import os

import xml.etree.ElementTree as ET

import numpy as np
import quippytest

from quippy.potential import Potential
from ase.constraints import voigt_6_to_full_3x3_stress
from ase.io import read

# expected fit coefficients
alpha_ref = np.array(
      [ 1.60105620e-01, -1.88634680e+01, -4.25653215e+02,  6.49682071e+01,
       -3.44137663e+02,  7.41604116e+02,  1.92209007e+02,  1.08552491e+02,
        9.10845409e+01,  4.77644814e+01, -1.17728322e+02, -2.48555199e+01,
        6.86001804e+02,  6.57212945e+02, -6.47119817e+02,  4.86153827e+03,
        3.23568063e+02,  1.71459788e+03,  3.12838813e+02, -2.03378235e+02,
       -1.52680426e+02,  9.47983064e+01,  2.32838223e+02, -6.15572228e+01,
       -3.17942924e+01,  9.95663090e-01, -2.17392668e+02, -2.14473344e+02,
       -1.14243259e+02, -1.63419217e+02, -3.21769641e+02, -8.94919469e+01,
        2.34842213e+02,  4.76419811e+02, -1.58082800e+02, -1.45706925e+01,
        1.81961061e+03,  3.38785288e+02, -1.05725991e+02, -2.14750327e+02,
        4.45106640e+01,  5.76078717e+01,  2.78191858e+02, -2.51863096e+02,
        2.10392181e+02, -4.59743166e+03,  3.26703347e+03,  2.40036679e+02,
        2.16038204e+01, -3.00333921e+02,  3.39590204e+02, -5.65569682e+02,
       -1.22937337e+02,  9.77965625e+01,  2.69880354e+01, -4.09077678e+01,
       -2.03892576e+02, -2.96835592e+02,  7.35755830e+02, -8.93975115e+02,
        8.92189312e+01, -1.25733853e+02,  2.47803902e+02,  5.24594524e+01,
        2.71207897e+02,  1.38568930e+02, -1.61415542e+00, -2.47181357e+02,
        5.67783920e+02, -5.35770222e+01, -8.75613872e+01,  1.16256921e+02,
       -9.24069061e+00, -4.72972556e+02,  1.29532368e+02,  1.56201746e+02,
        1.73906248e+02, -2.78135002e+02, -1.75484293e+02,  2.94787814e+01,
       -8.99468281e+01,  1.15978383e+02, -2.33220895e+02, -8.17493074e+02,
       -2.34343800e+02,  1.28748352e+01, -2.16399958e+02, -1.42188992e+02,
        1.23580108e+02,  1.90407221e+02,  3.79079612e+02,  2.76795590e+02,
       -2.77124400e+03,  1.05517246e+02,  1.22531521e+01,  3.17135355e+01,
       -6.27378894e+01,  3.12079909e+02,  2.89675143e+01,  1.94962128e+02,
       -8.89562122e+02,  6.84449240e+02, -1.83812294e+02,  4.05053025e+02,
       -1.62512185e+02, -8.00840515e+01, -4.76602759e+02,  4.50881028e+02,
        1.03291321e+02,  1.30376086e+02, -3.27908645e+02, -2.48915333e+03,
       -3.46994331e+03,  4.78907351e+02, -1.44220972e+03,  3.24893737e+03,
       -2.45124352e+03, -3.85490672e+03,  6.81277278e+03,  8.86670301e+02,
        1.62143449e+03,  1.24611105e+03,  1.74635464e+03, -2.08387817e+03,
        6.74703336e+01,  3.60491368e+03, -3.44162534e+03,  1.44991090e+03,
        6.48700321e+02, -2.79142046e+03,  1.75255153e+03, -2.25335039e+03,
        7.52705103e+02, -1.80711324e+02, -4.09072666e+03, -7.53218787e-01,
       -1.72948528e+02,  6.76571286e+02,  1.85723423e+03, -9.24887754e+02,
       -5.00441908e+03,  7.44525391e+02,  1.47756755e+03,  4.39986721e+03,
       -4.32106180e+02,  7.60245151e+02,  4.47141722e+03,  1.14333507e+02,
       -6.37157601e+02, -8.02082801e+02,  1.33019065e+03,  6.51462768e+01,
       -5.31254209e+03, -3.79091197e+03, -5.28095017e+03, -1.89955202e+03,
        2.65742896e+03,  2.17077204e+03, -1.74075262e+03,  2.67931462e+02,
       -2.25913166e+02, -7.05086661e+03, -5.24242049e+03,  3.24907320e+03,
       -5.54246213e+02,  3.90791858e+00, -3.44155722e+03,  8.74515036e+03,
        1.38120403e+03, -4.17022143e+03, -6.37365097e+03,  2.09442978e+03,
       -1.82634016e+02,  2.47900408e+03,  6.31045684e+03,  2.69147012e+03,
       -3.19462142e+01,  1.24109861e+02, -6.49981785e+02, -1.38532954e+03,
       -5.92941813e+01, -3.22093213e+02,  9.30610720e+02,  6.54656652e+01,
        3.74895001e+02, -7.19390158e+02,  7.36025413e+01,  9.22475497e+02,
       -6.94615960e+02, -1.30629513e+02, -1.82585417e+01,  4.31531340e-02,
        5.95353646e-01,  8.27625481e+02,  2.66074635e+02,  3.03811454e+02,
        7.77110745e+02, -1.98653019e+03, -1.01041622e+03, -9.51949715e+01,
        9.59212654e+02, -1.12191293e+02,  5.48638238e+01,  7.20301245e+02,
        6.45118060e+02, -1.74233830e+02,  1.57536966e+03, -1.01325269e+02,
       -1.07174851e+03,  1.09195714e+01, -2.08927549e+02, -4.04704015e+02,
        2.10784729e+02,  1.24140796e+03, -1.12168159e+03, -2.53428808e+01,
       -9.76793092e+01, -5.06932442e+01,  6.92063379e+01, -2.17220365e+01,
        7.11553352e+01,  8.71119095e+01,  1.67838547e+01,  3.21753841e+01,
        4.96376164e+02,  3.30893393e+02,  1.66797179e+03, -1.18219396e+03,
       -2.48469008e+03, -5.53667635e+03,  1.96117373e+03,  6.59161748e+01,
       -2.96298341e+02, -3.20923694e+03,  4.88684201e+02, -5.81110721e+02,
       -7.66931088e+02, -3.78983297e+01, -2.88483396e+03,  2.02050352e+03,
        3.10741191e+03,  2.79125874e+03,  3.69376861e+03, -4.06851742e+03,
        1.69345731e+03, -3.00089772e+02, -2.64494103e+02,  2.29726703e+03,
       -2.37258956e+03, -2.88990507e+03,  3.90870043e+01,  1.04573809e+03,
       -3.07250198e+03,  3.66330562e+02,  1.20677906e+03, -2.27171258e+03,
       -4.76937343e+02, -1.72693860e+03, -1.19675437e+02, -2.15195713e+03,
       -1.38542851e+03,  2.72558679e+03, -6.94546125e+03, -3.90274953e+01,
        9.49155613e+02, -6.72941440e+03, -3.93586058e+02, -2.50144585e+01,
        8.78172439e+01, -2.19916088e-01,  9.23130988e+01,  1.05781755e+02,
       -3.50965655e+01, -2.19440494e+01, -3.76114422e+00,  3.80730180e+01,
        1.16678837e+00, -1.09650639e+01, -2.00005078e+02, -6.03837278e+01,
        2.06165532e+01,  6.91105474e+00,  1.15880327e+02, -6.63765568e+00,
        1.10399388e+02,  4.08004727e+01,  1.44431473e+02, -7.25943630e+02,
       -2.71356981e+02,  2.10760754e+02, -4.78127857e+01, -7.67745389e+01,
        6.67793235e+01,  2.60709186e+01, -2.13757642e+02, -5.87745237e+01,
       -2.37265689e+02,  7.02507188e+02,  1.72113876e+02,  2.11777990e+01,
        1.47874815e+02, -2.85737272e+02,  9.06551635e+00,  3.31630196e+02,
        5.13332508e+01, -8.12885929e+01, -3.48306322e+01, -3.72732182e+01,
       -2.40539736e+02,  1.14262659e+02,  5.68311727e+01, -5.24218170e+01,
        3.69340292e+01, -2.01421871e+02, -1.21502681e+02,  1.14069914e+01,
        9.72199823e+01,  5.76280100e+01,  1.54790049e+02,  3.95642693e+01,
       -4.73740834e+01,  1.02080706e+02, -3.76916904e+01, -1.33967318e+01,
       -7.42088309e+01,  2.44022319e+01,  2.44976485e+02,  1.22036892e+02,
       -7.41565813e+01,  1.24017086e+02,  3.00806892e+01,  1.14311602e+02,
        3.69407917e+00, -6.15290153e+01,  3.57354512e+00,  1.82052976e+02,
        9.51408769e+00,  5.88772400e+01, -1.34602245e+02, -1.19192260e+01,
        3.39201662e+02, -3.90628998e+00, -1.75284822e+02,  2.68532309e+02,
        8.79158656e+01,  8.67187922e+02, -5.11925074e+01,  1.38597135e+02,
        4.60592281e+01,  6.48678301e+01, -1.79926848e+02, -1.61152750e+01,
       -1.06092028e+03,  1.67650585e+02, -3.61834464e+01, -3.61663164e+01,
        4.74998153e+01, -3.08594803e+02,  9.11849012e+01,  3.43314606e+02,
        2.77420727e+03, -1.30897240e+03,  1.81071063e+03, -6.61864363e+02,
        3.48833088e+03, -1.68012888e+03,  1.40399173e+02, -1.97074203e+03,
        1.36859569e+03,  7.19454099e+01, -5.20998072e+02, -2.10213220e+03,
       -8.99592931e+02,  9.11530233e+02,  2.39970601e+02, -1.79323922e+03,
       -2.65051332e+03, -3.93800270e+02, -1.52747456e+03, -4.68489520e+02,
       -1.64140592e+03, -1.15337448e+03,  3.42552463e+02,  1.90524961e+01,
        3.84765739e+03,  2.46681129e+03, -2.89706248e+03,  1.27516862e+03,
       -7.09176529e+02, -1.33087446e+03,  4.22642479e+03,  5.05298006e+02,
       -4.46251037e+02,  1.25721175e+03, -8.04979510e+02, -2.80135739e+00,
        1.18605064e+02, -3.76410751e+03,  8.54580410e+01, -1.17218534e+01,
       -2.30276276e+02,  1.24991075e+03,  3.20608667e+03,  3.77935313e+03,
       -3.94675565e+03, -4.61103833e+02, -6.46815376e+02,  1.17602048e+02,
       -3.06144950e+01,  1.38194523e+02,  1.41868724e+03,  7.10806481e+02,
       -3.61121018e+03,  1.13658228e+02,  6.98877934e+03,  6.70211026e+02,
        4.29403840e+03,  1.08709944e+03, -1.14642251e+03,  1.89144704e+03,
        8.95179031e+02,  1.61766934e+02,  4.35538867e+01,  4.49463177e+01,
       -3.22903369e+02, -1.43632882e+01, -7.99290962e+02, -7.49416289e+02,
        1.24563376e+03, -4.09156883e+01, -7.42088665e+02, -2.51344835e+03,
        3.49114449e+02,  1.23533625e+01, -1.97819446e+01, -1.62865609e+01,
        1.72732232e+01, -1.38236826e+02, -3.55612266e+03, -2.33613603e+03,
       -4.50936237e+03,  8.84288171e+02, -6.22877155e+02,  7.45796357e+01,
        3.11713965e+03,  6.46114175e+02, -8.68966159e+03, -7.16608856e+01,
        1.28663305e+02, -1.91102508e+01, -5.86844089e+01,  6.36314704e+00,
        3.85102951e+01, -3.26820262e+01,  8.20398710e+01, -5.49521211e+01,
        3.18028365e+02,  1.43409114e+02,  1.90280190e+02,  2.03001855e+02,
        1.31104381e+02, -4.81341236e+02,  9.91568576e+01,  1.19865792e+02,
       -1.10305855e+02,  8.02174417e+01,  5.85375539e+01, -1.47682507e+02,
        8.52829300e+01,  8.66799387e+01,  2.09920362e+01, -7.77523565e+02,
        1.20202657e+01, -1.50541952e+02,  1.93913113e+01,  2.45047940e+01,
        5.54606662e+01,  1.73215393e+00,  3.91151589e+02, -6.66792352e+01,
        2.13401902e+02,  3.52959092e+01, -1.34150445e+01,  4.60199320e+00,
        2.01100356e+01, -6.75159414e+01,  3.65296889e+01,  3.56818551e+01,
        6.35271834e+01,  1.46975538e+02,  3.89731297e+01,  3.95880524e+02,
        6.77728798e+02, -2.76372473e+01,  9.83398853e+01,  5.13617776e+01,
        5.63504079e+01, -1.99332536e+00, -1.96311734e+01, -6.31537336e+01,
        1.90048384e+02, -5.82826639e+01,  3.23850231e+02, -2.02604824e+02,
       -9.79290574e+01, -3.71888956e+01,  1.57037073e+01, -1.74189411e+02,
       -3.00043812e+01, -4.04413040e+02, -3.72116923e+01, -8.32306939e+02,
        6.07895623e+02,  3.70370885e+00, -5.72070602e+01,  3.87885718e+02,
        7.10032593e+02,  8.36845656e+00, -2.98888970e+00,  1.21017374e+02,
        1.10504159e+03,  2.21121155e+02, -4.43423544e+02,  4.64608806e+01,
       -3.48850783e+02,  9.39086984e+01, -2.36835189e+01,  2.37833038e+01,
       -3.62080304e+01,  1.10966875e+02,  5.11767499e+02, -1.48432095e+02,
       -6.60924659e+01, -1.64157074e+02, -4.50935497e+01,  5.00973490e+01,
       -2.30184696e+02, -2.92806497e+00,  2.24122673e+02, -1.86484236e+01,
       -1.87037090e+01, -9.81902783e+00,  1.16390687e+01,  2.46114637e+01,
       -6.08644433e+01, -2.00243730e+02, -5.76688172e+01,  3.13567863e+02,
        4.76192591e+02,  3.07176502e+02,  9.20257590e+02, -9.66137995e+02,
       -1.04390744e+03,  2.35502637e+03, -4.98896237e+02, -3.83390871e+02,
        7.76892343e+02, -8.36658818e+02,  1.17647748e+03,  2.45925173e+02,
        3.71013294e+02, -1.64423810e+03, -2.59107917e+01, -8.78778346e+02,
        7.99816048e+02,  1.30652851e+03, -6.27495081e+03,  3.36139466e+02,
       -1.75421081e+01,  1.45776525e+03,  6.38353791e+01, -2.58837785e+03,
       -5.59085989e+02, -5.01464336e+02,  1.48824926e+03, -9.71980051e+02,
       -1.29177488e+03,  2.00608355e+02, -5.05279416e+02, -8.42009803e+02,
        7.99418295e+01,  6.71803965e+01,  2.47915128e+02, -5.78731782e+02,
        3.38753305e+02,  1.58316798e+03,  2.57432557e+03, -6.58542760e+02,
       -1.33379518e+03,  2.04804878e+02,  1.11586450e+03, -2.37478751e+03,
        4.08111656e+02,  1.74993270e+03,  1.82119691e+03, -9.19489535e+01,
        5.91448680e+02, -5.03992672e+01, -5.34758723e+01,  9.28956090e+01,
        1.51591577e+03,  1.10687787e+03, -1.94850038e+02,  3.25094439e+03,
       -3.34278779e+01, -3.36969367e+02,  1.08357507e+03, -5.67124990e+01,
       -6.18262596e+02,  9.93574101e+02,  1.10674916e+03,  3.69189335e+03,
       -1.33361806e+02, -2.33402144e+02, -3.48879675e+03, -6.22172540e+01,
        1.54026728e+03, -1.41843960e+03, -1.21651557e+02, -3.48821272e+02,
        4.87847696e+03,  4.31605352e+01, -2.26870922e+01, -3.83747638e+01,
        6.51190755e+03,  2.30365761e+03,  1.22682489e+03, -2.90877170e+02,
        7.61377366e+02,  5.43238054e+03,  2.62513531e+03,  4.79729178e+03,
        2.03495904e+03, -6.18350089e+03, -1.84902396e+03,  5.19386569e+03,
       -1.26106515e+03, -2.13478804e+03,  2.46760347e+02, -6.02299039e+03,
        6.11463771e+02, -1.61071698e+03,  1.02412408e+02,  4.10032890e+03,
       -7.04043320e+03, -2.51084553e+03,  3.97939762e+03,  2.24378071e+03,
       -6.43540296e+03, -1.78744710e+03,  2.42800816e+03, -4.32856905e+01,
        3.19862139e+03,  2.02176724e+03,  1.77580118e+03,  1.57247694e+03,
       -1.95036767e-01,  6.39579423e+02,  8.84447082e+02, -1.46267258e+02,
        2.10576396e+01,  8.24924088e+01, -7.41113876e+02, -9.36206518e+02,
       -8.69884555e+01, -1.43335727e+02, -4.21612442e+02, -1.44901912e+02,
       -1.08245738e+01,  4.18412049e+01,  4.47157483e+00,  5.52647053e-01,
       -6.94099121e+00, -2.78626584e+02, -8.90116749e+01, -9.88020638e+01,
       -3.89977519e+02, -4.18825650e+02, -3.18588898e+01,  8.69317206e+02,
       -1.31526369e+02, -1.60674731e+02, -7.92129601e+01,  4.92113347e+01,
        1.20703458e+02,  1.97833069e+02,  1.73603406e+00, -9.88739546e+01,
       -1.99324457e+01,  9.41857699e+01, -2.59131740e+02, -1.16750237e+02,
       -2.22577074e+02,  7.10442899e+01,  4.58957355e+02,  3.41395561e+01,
       -1.84622132e+02, -1.79459724e+01, -5.98008178e+01, -8.20025156e+01,
       -5.71993291e+01,  6.87770232e+02, -9.51814287e+01,  1.90696676e+02,
        6.40454611e+01, -4.73396195e+02, -1.90087231e+02,  2.85697809e+02,
        8.60353986e+01, -6.89725887e+01, -1.52512630e+02, -1.16889924e+02,
        8.08896989e+01, -1.52122534e+02, -6.70507519e+01, -3.88166526e+01,
       -1.59399315e+02, -3.10086898e+02, -8.56742591e+01, -5.70715366e+01,
        3.84666232e+01, -1.94555180e+02,  2.17327673e+01,  2.14616263e+02,
       -2.96481231e+02, -5.68591179e+00,  3.27603557e+02,  2.64611716e+01,
        2.59128550e+01, -2.39628999e+02, -1.10832259e+02,  1.14298330e+02,
       -4.82602622e+01, -1.05110995e+02,  2.21294647e+01, -2.63911445e+02,
       -1.78360729e+02, -2.12480301e+02,  1.74210188e+01, -1.87244446e+02,
       -3.33022682e+01, -4.79798592e+01,  3.25219498e+01, -1.14467516e+02,
       -4.82756949e+01,  1.95030650e+02, -8.69718554e+00,  9.86028765e+01,
       -3.13262218e+03, -3.06825425e+02, -2.39485569e+03, -6.02380134e+03,
       -2.09747450e+03, -3.18530818e+03,  1.28050399e+03,  2.37093364e+03,
       -3.63054234e+03, -2.29049337e+03, -7.42216247e+02,  5.32284345e+02,
        1.40937033e+02,  2.31099177e+03, -2.52596160e+03,  4.96912251e+03,
       -6.07002467e+03, -1.36206237e+03,  2.57923079e+02,  6.60966738e+03,
       -2.38127939e+03,  1.44102681e+03,  7.71706181e+02, -9.66305865e+01,
       -1.76559833e+02,  2.48271449e+03,  3.61202350e+03,  1.02540707e+03,
        7.73424457e+03,  8.12255750e+03,  1.21197664e+03,  1.72073026e+03,
        5.22469721e+02, -1.55438062e+02, -7.30009437e+01,  2.34220457e+03,
       -6.72668225e+02, -8.46402575e+02, -9.67781629e+01, -2.57642811e+03,
       -2.54950501e+01, -6.75590734e+02, -5.51532477e+02,  4.68553340e+02,
        1.09099217e+03, -9.09655872e+02, -6.79664685e+00, -1.98195142e+03,
       -8.13170885e+02, -3.73704236e+02, -1.56278448e+03,  4.68534958e+02,
       -1.21362823e+02, -4.25721660e+02, -9.28315716e+02,  1.88185879e+03,
       -1.45248768e+03, -9.21561623e+02, -5.24677810e+02, -3.91044257e+02,
        1.79892551e+02,  8.31822499e+01,  8.54884673e+01,  5.32260764e+01,
       -1.45098394e+02,  1.25222494e+03,  6.39789377e+02, -6.31377770e+02,
        1.21103725e+02,  7.44114071e+01, -7.30787970e+02,  6.33725804e+02,
        9.62261473e+02,  2.03405282e+01,  7.25746615e+01, -7.36615846e+01,
       -3.09008911e+02, -2.18805116e+02, -9.57609462e+02, -1.30280063e+03,
        7.69163021e+02, -3.17920332e+02, -1.02842700e+02,  1.14922677e+02,
       -1.19389237e+03,  2.97665178e+02,  3.09193555e+02,  6.68351303e+01,
        4.00965746e+02, -1.92172594e+02,  1.06706431e+03,  2.25282639e+02,
       -1.70421641e+02,  1.81612504e+02,  2.04693249e+02, -4.94982942e+02,
        4.28099396e+02, -7.75791143e+02, -4.99415890e+02,  6.19780183e+01,
        2.90688859e+03, -2.87586419e+02, -5.70218736e+01,  2.11892499e+02,
       -2.00050392e+03,  6.23165645e+02, -1.25618223e+02,  1.84787306e+01,
        1.10257129e+02,  2.04560230e+03,  2.38256935e+02, -8.09995042e+02,
       -1.58586241e+03,  2.96977341e+02,  1.30395434e+03, -3.45442852e+03,
        1.77483049e+02,  7.72069106e+02,  9.24027327e+02, -2.15270425e+03,
        1.99554148e+03,  2.74228807e+02, -1.43525300e+03,  1.18839833e+03,
        4.39935069e+03, -2.15760771e+03,  2.38596630e+03, -2.21223032e+03,
        2.96559430e+02, -1.05602950e+03,  4.13327486e+02,  4.67307521e+02,
        3.33061598e+03,  4.68045954e+03, -5.11460712e+03,  6.71717707e+01,
        2.20262190e+03, -1.26690713e+01, -1.82674672e+01,  5.26589773e+02,
        4.66288393e+03,  5.68210227e+03, -3.27458998e+03, -7.87430316e+03,
        1.67415513e+02, -5.58478168e+01, -4.44623067e+03,  1.78022574e+02,
        4.66036279e+03, -1.15652268e+04,  6.63153481e+03,  3.97218546e+03,
        6.13398428e+02, -2.65527755e+02, -3.76962490e+02,  2.15069100e+03,
       -4.17080327e+03,  8.00460019e+02,  4.66695139e+03, -4.20182687e+02,
        3.66648985e+03,  3.50818018e+03, -1.42650528e+03,  3.43995141e+02,
        5.42496242e+01, -7.41238879e+01, -5.60685468e+03, -5.13298829e+03,
        4.86941877e+03,  2.00140139e+02, -4.09515926e+01,  4.22387080e+00,
       -3.00529835e+01, -1.85932329e+03,  9.19330750e+01,  9.03453781e+01,
        7.75461208e+01,  1.61769114e+03,  1.35398809e+03,  3.22113603e+03,
        2.15527313e+02, -1.45234325e+03, -4.73248330e+02,  1.63499846e+02,
        2.38941312e+03, -6.67989138e+02,  1.38690345e+02,  4.70105695e+03,
       -2.78048566e+03, -6.74757861e+02,  6.81567541e+01, -3.54643180e+01,
        1.27763998e+01,  1.28310672e+02, -7.63292961e+02,  1.53955401e+02,
       -4.55964448e+02,  1.10520845e+03, -3.96604755e+03, -2.16406957e+03,
       -7.43285280e+02, -6.60126091e+02, -1.61263381e+03,  5.44139201e+02,
        8.86610393e+02,  1.91052503e+02, -5.67171935e+03,  9.28226818e+02,
        2.26427207e+03, -1.41501591e+02, -2.26729508e+03,  1.46815914e+03,
        3.20172161e+03, -9.74871918e+02,  5.55286456e+02,  1.27841812e+03,
       -1.98501425e+03, -3.68057979e+03,  8.06183967e+02,  1.83041527e+03,
       -2.51073234e+03, -1.18158989e+03, -1.58167629e+02,  5.82930972e+02,
        9.65841017e+01, -1.32981403e+03, -4.85338497e+01, -4.55158598e+02,
       -4.08182621e+03,  6.81759312e+02, -1.43673212e+03, -1.77712356e+03,
        3.27225034e+03, -9.52043471e+01, -6.02404225e+02, -5.24512174e+03,
        2.33957212e+03, -1.08588117e+03,  1.02823287e+03,  7.26431890e+02,
        3.13748631e+02,  3.55186918e+03,  1.05246447e+03, -6.36068763e+02,
       -6.69508413e+01, -2.24016977e+03,  5.77468199e+03,  1.83647208e+03,
        3.86179179e+02,  4.38364286e+01,  8.08679579e+02, -4.43306777e+00])

@unittest.skipIf(os.environ['HAVE_GAP'] != '1', 'GAP support not enabled')
class TestGAP_fit_silion(quippytest.QuippyTestCase):
    command_line = ("at_file=train_sub3.xyz gap={soap l_max=8 n_max=8 atom_sigma=0.5 "
                    "zeta=4 cutoff=4.0 cutoff_transition_width=1.0 central_weight=1.0 "
                    "n_sparse=1000 delta=3.0 f0=0.0 covariance_type=dot_product "
                    "sparse_method=cur_points print_sparse_index=si_sub3.dat} "
                    "default_sigma={0.001 0.1 0.05 0.0} "
                    "energy_parameter_name=dft_energy force_parameter_name=dft_force "
                    "virial_parameter_name=dft_virial config_type_parameter_name=config_type "
                    "sparse_jitter=1.0e-8 e0_offset=2.0 gp_file=gp.xml rnd_seed=1")
    os.system('gap_fit '+command_line)
    
    tree = ET.parse('gp.xml')
    root = tree.getroot()
    gp_label = root.tag
    
    # check GP coefficients match expected values
    alpha = np.array([float(tag.attrib['alpha']) for tag in root[1][1][0].findall('sparseX')])
    assert np.abs(alpha - alpha_ref).max() < 1e-4
    
    pot = Potential(f'xml_label={gp_label}', param_filename='gp.xml')
    
    dataset = read('train_sub3.xyz@:')
    for atoms in dataset:
        atoms.calc = pot
        info = {k.lower(): v for k, v in atoms.info.items() }
        arrays = {k.lower(): v for k, v in atoms.arrays.items() }
        energy = atoms.get_potential_energy()
        forces = atoms.get_forces()

        # check for consistency with reference GAP model        
        assert abs(atoms.info['gap_energy'] - energy) < 1e-6        
        assert np.abs(atoms.arrays['gap_forces'] - forces).max() < 1e-6

        # check error wrt training data
        de = abs(energy - info['dft_energy']) / len(atoms)
        assert de < 1e-3        
        
        df = np.sqrt(((forces - arrays['dft_force'])**2).mean())
        assert df < 0.3
        
        if 'dft_virial' in atoms.info:
            stress = atoms.get_stress()        
            virial = - voigt_6_to_full_3x3_stress(stress * atoms.get_volume())
            assert np.abs(atoms.info['gap_virial'] - virial).max() < 1e-6
            
            dft_virial = info['dft_virial'].reshape((3, 3), order='F')
            dv = np.sqrt(((virial - dft_virial)**2).mean())
            assert dv < 3.0

if __name__ == '__main__':
    unittest.main()
