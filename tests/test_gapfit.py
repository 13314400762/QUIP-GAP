# HQ XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
# HQ X
# HQ X   quippy: Python interface to QUIP atomistic simulation library
# HQ X
# HQ X   Copyright James Kermode 2019
# HQ X
# HQ X   These portions of the source code are released under the GNU General
# HQ X   Public License, version 2, http://www.gnu.org/copyleft/gpl.html
# HQ X
# HQ X   If you would like to license the source code under different terms,
# HQ X   please contact James Kermode, james.kermode@gmail.com
# HQ X
# HQ X   When using this software, please cite the following reference:
# HQ X
# HQ X   http://www.jrkermode.co.uk/quippy
# HQ X
# HQ XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX

import unittest
import os

import xml.etree.ElementTree as ET

import numpy as np
import quippytest

from quippy.potential import Potential
from ase.constraints import voigt_6_to_full_3x3_stress
from ase.io import read

# expected fit coefficients
alpha_ref = np.array(
      [ 1.60105684e-01, -1.88635276e+01, -4.25654008e+02,  6.49682641e+01,
       -3.44136851e+02,  7.41603441e+02,  1.92209067e+02,  1.08552447e+02,
        9.10848057e+01,  4.77645407e+01, -1.17728306e+02, -2.48559546e+01,
        6.86001830e+02,  6.57213186e+02, -6.47119455e+02,  4.86155244e+03,
        3.23567895e+02,  1.71459754e+03,  3.12839599e+02, -2.03378707e+02,
       -1.52680661e+02,  9.47984565e+01,  2.32838061e+02, -6.15572084e+01,
       -3.17942345e+01,  9.95767798e-01, -2.17392860e+02, -2.14473061e+02,
       -1.14243093e+02, -1.63419062e+02, -3.21769582e+02, -8.94920804e+01,
        2.34842267e+02,  4.76419828e+02, -1.58082646e+02, -1.45707936e+01,
        1.81959762e+03,  3.38793190e+02, -1.05726114e+02, -2.14750177e+02,
        4.45104240e+01,  5.76078445e+01,  2.78191902e+02, -2.51863062e+02,
        2.10392121e+02, -4.59741774e+03,  3.26703236e+03,  2.40037532e+02,
        2.16038786e+01, -3.00334110e+02,  3.39590316e+02, -5.65569957e+02,
       -1.22937407e+02,  9.77965742e+01,  2.69880026e+01, -4.09077722e+01,
       -2.03892487e+02, -2.96836553e+02,  7.35746088e+02, -8.93974419e+02,
        8.92190944e+01, -1.25733523e+02,  2.47803972e+02,  5.24594918e+01,
        2.71207862e+02,  1.38569206e+02, -1.61408727e+00, -2.47181494e+02,
        5.67784174e+02, -5.35770291e+01, -8.75614506e+01,  1.16256905e+02,
       -9.24079412e+00, -4.72973190e+02,  1.29532378e+02,  1.56202088e+02,
        1.73906276e+02, -2.78134979e+02, -1.75484370e+02,  2.94787121e+01,
       -8.99467670e+01,  1.15978209e+02, -2.33221100e+02, -8.17493528e+02,
       -2.34343563e+02,  1.28747997e+01, -2.16400038e+02, -1.42188832e+02,
        1.23580232e+02,  1.90407263e+02,  3.79079401e+02,  2.76795390e+02,
       -2.77124120e+03,  1.05517457e+02,  1.22532313e+01,  3.17135711e+01,
       -6.27379810e+01,  3.12079787e+02,  2.89673569e+01,  1.94961935e+02,
       -8.89561980e+02,  6.84449802e+02, -1.83813547e+02,  4.05052231e+02,
       -1.62511843e+02, -8.00841541e+01, -4.76603048e+02,  4.50881588e+02,
        1.03290844e+02,  1.30376396e+02, -3.27907872e+02, -2.48912274e+03,
       -3.46993258e+03,  4.78885637e+02, -1.44218320e+03,  3.24898419e+03,
       -2.45131735e+03, -3.85492279e+03,  6.81280858e+03,  8.86670049e+02,
        1.62146479e+03,  1.24609591e+03,  1.74632470e+03, -2.08386852e+03,
        6.74635840e+01,  3.60491496e+03, -3.44170040e+03,  1.44992336e+03,
        6.48729807e+02, -2.79141830e+03,  1.75255430e+03, -2.25334403e+03,
        7.52706188e+02, -1.80711228e+02, -4.09072687e+03, -7.52898233e-01,
       -1.72948323e+02,  6.76576426e+02,  1.85723188e+03, -9.24897851e+02,
       -5.00442742e+03,  7.44552488e+02,  1.47756519e+03,  4.39988510e+03,
       -4.32106191e+02,  7.60247731e+02,  4.47138923e+03,  1.14331400e+02,
       -6.37135418e+02, -8.02080862e+02,  1.33020885e+03,  6.51328721e+01,
       -5.31253482e+03, -3.79093473e+03, -5.28092417e+03, -1.89955145e+03,
        2.65743172e+03,  2.17076699e+03, -1.74074433e+03,  2.67941253e+02,
       -2.25912628e+02, -7.05086219e+03, -5.24243879e+03,  3.24910594e+03,
       -5.54245964e+02,  3.90792107e+00, -3.44155506e+03,  8.74519431e+03,
        1.38119810e+03, -4.17021486e+03, -6.37365397e+03,  2.09442864e+03,
       -1.82634989e+02,  2.47898598e+03,  6.31045881e+03,  2.69144904e+03,
       -3.19462124e+01,  1.24109824e+02, -6.49980902e+02, -1.38532918e+03,
       -5.92941455e+01, -3.22093049e+02,  9.30609753e+02,  6.54657518e+01,
        3.74894642e+02, -7.19389888e+02,  7.36018042e+01,  9.22475802e+02,
       -6.94615558e+02, -1.30629872e+02, -1.82586051e+01,  4.33060141e-02,
        5.95803284e-01,  8.27625381e+02,  2.66074292e+02,  3.03810691e+02,
        7.77111519e+02, -1.98652805e+03, -1.01041606e+03, -9.51948910e+01,
        9.59212266e+02, -1.12191512e+02,  5.48636097e+01,  7.20300349e+02,
        6.45117558e+02, -1.74233901e+02,  1.57536962e+03, -1.01325615e+02,
       -1.07174890e+03,  1.09195115e+01, -2.08927680e+02, -4.04703451e+02,
        2.10785079e+02,  1.24140730e+03, -1.12168100e+03, -2.53429520e+01,
       -9.76792472e+01, -5.06932377e+01,  6.92062907e+01, -2.17220152e+01,
        7.11553480e+01,  8.71119323e+01,  1.67838549e+01,  3.21753431e+01,
        4.96376637e+02,  3.30891838e+02,  1.66797715e+03, -1.18219603e+03,
       -2.48469400e+03, -5.53668241e+03,  1.96117541e+03,  6.59170573e+01,
       -2.96299312e+02, -3.20924552e+03,  4.88681928e+02, -5.81122640e+02,
       -7.66933983e+02, -3.78983747e+01, -2.88484009e+03,  2.02050884e+03,
        3.10741892e+03,  2.79126840e+03,  3.69375929e+03, -4.06851732e+03,
        1.69344429e+03, -3.00086114e+02, -2.64493782e+02,  2.29727216e+03,
       -2.37258923e+03, -2.88990873e+03,  3.90875507e+01,  1.04572483e+03,
       -3.07250155e+03,  3.66321764e+02,  1.20679909e+03, -2.27171431e+03,
       -4.76910892e+02, -1.72693314e+03, -1.19675424e+02, -2.15197683e+03,
       -1.38540842e+03,  2.72559577e+03, -6.94547947e+03, -3.90274839e+01,
        9.49137635e+02, -6.72942410e+03, -3.93603210e+02, -2.50144790e+01,
        8.78172143e+01, -2.19901698e-01,  9.23129450e+01,  1.05781642e+02,
       -3.50965426e+01, -2.19440615e+01, -3.76114777e+00,  3.80730380e+01,
        1.16674914e+00, -1.09650576e+01, -2.00005249e+02, -6.03837036e+01,
        2.06165862e+01,  6.91108037e+00,  1.15880412e+02, -6.63770169e+00,
        1.10399420e+02,  4.08000739e+01,  1.44431530e+02, -7.25943898e+02,
       -2.71357158e+02,  2.10760886e+02, -4.78128250e+01, -7.67744934e+01,
        6.67793122e+01,  2.60710077e+01, -2.13757169e+02, -5.87745264e+01,
       -2.37265643e+02,  7.02507858e+02,  1.72113859e+02,  2.11778381e+01,
        1.47874868e+02, -2.85737582e+02,  9.06551631e+00,  3.31630337e+02,
        5.13332679e+01, -8.12886842e+01, -3.48306257e+01, -3.72731837e+01,
       -2.40539736e+02,  1.14262668e+02,  5.68311557e+01, -5.24217242e+01,
        3.69340968e+01, -2.01421940e+02, -1.21502705e+02,  1.14069528e+01,
        9.72200619e+01,  5.76279961e+01,  1.54790072e+02,  3.95643273e+01,
       -4.73741277e+01,  1.02080432e+02, -3.76917052e+01, -1.33967218e+01,
       -7.42088037e+01,  2.44022981e+01,  2.44976348e+02,  1.22036854e+02,
       -7.41566181e+01,  1.24017014e+02,  3.00804271e+01,  1.14311580e+02,
        3.69403153e+00, -6.15289417e+01,  3.57359956e+00,  1.82052955e+02,
        9.51415150e+00,  5.88771242e+01, -1.34602266e+02, -1.19192258e+01,
        3.39202552e+02, -3.90629471e+00, -1.75284654e+02,  2.68531720e+02,
        8.79158107e+01,  8.67188892e+02, -5.11925200e+01,  1.38597131e+02,
        4.60592743e+01,  6.48678420e+01, -1.79926948e+02, -1.61153109e+01,
       -1.06092237e+03,  1.67650669e+02, -3.61834765e+01, -3.61662842e+01,
        4.74998116e+01, -3.08594571e+02,  9.11849377e+01,  3.43314526e+02,
        2.77419300e+03, -1.30897450e+03,  1.81070839e+03, -6.61865073e+02,
        3.48833245e+03, -1.68012657e+03,  1.40391031e+02, -1.97074623e+03,
        1.36859302e+03,  7.19492999e+01, -5.21001248e+02, -2.10213320e+03,
       -8.99594741e+02,  9.11535423e+02,  2.39970797e+02, -1.79323378e+03,
       -2.65051363e+03, -3.93805828e+02, -1.52747236e+03, -4.68489661e+02,
       -1.64140635e+03, -1.15337053e+03,  3.42552494e+02,  1.90524606e+01,
        3.84765361e+03,  2.46682125e+03, -2.89706533e+03,  1.27516949e+03,
       -7.09185119e+02, -1.33087348e+03,  4.22643988e+03,  5.05296993e+02,
       -4.46244660e+02,  1.25720889e+03, -8.04978167e+02, -2.80151860e+00,
        1.18605102e+02, -3.76410778e+03,  8.54580154e+01, -1.17218480e+01,
       -2.30271484e+02,  1.24991691e+03,  3.20608485e+03,  3.77935701e+03,
       -3.94675869e+03, -4.61102660e+02, -6.46815339e+02,  1.17601935e+02,
       -3.06155441e+01,  1.38194795e+02,  1.41868430e+03,  7.10805160e+02,
       -3.61119356e+03,  1.13658325e+02,  6.98877302e+03,  6.70202452e+02,
        4.29403801e+03,  1.08710666e+03, -1.14642643e+03,  1.89144467e+03,
        8.95182449e+02,  1.61766449e+02,  4.35535170e+01,  4.49465362e+01,
       -3.22910679e+02, -1.43633275e+01, -7.99290660e+02, -7.49411397e+02,
        1.24562879e+03, -4.09162050e+01, -7.42088519e+02, -2.51346239e+03,
        3.49112598e+02,  1.23533628e+01, -1.97819461e+01, -1.62865491e+01,
        1.72732130e+01, -1.38236848e+02, -3.55612893e+03, -2.33613508e+03,
       -4.50935534e+03,  8.84285150e+02, -6.22877262e+02,  7.45797156e+01,
        3.11710283e+03,  6.46114272e+02, -8.68966723e+03, -7.16608562e+01,
        1.28663323e+02, -1.91101919e+01, -5.86844865e+01,  6.36318431e+00,
        3.85102851e+01, -3.26821109e+01,  8.20398152e+01, -5.49521726e+01,
        3.18028765e+02,  1.43409272e+02,  1.90280037e+02,  2.03001714e+02,
        1.31103786e+02, -4.81341466e+02,  9.91567943e+01,  1.19865751e+02,
       -1.10305855e+02,  8.02174425e+01,  5.85375415e+01, -1.47682573e+02,
        8.52829533e+01,  8.66799330e+01,  2.09918388e+01, -7.77524478e+02,
        1.20202900e+01, -1.50542005e+02,  1.93912807e+01,  2.45052226e+01,
        5.54605454e+01,  1.73214105e+00,  3.91152084e+02, -6.66796837e+01,
        2.13402463e+02,  3.52962099e+01, -1.34159071e+01,  4.60201889e+00,
        2.01101032e+01, -6.75159554e+01,  3.65296831e+01,  3.56817083e+01,
        6.35274018e+01,  1.46975543e+02,  3.89731448e+01,  3.95879811e+02,
        6.77729882e+02, -2.76369433e+01,  9.83399235e+01,  5.13617475e+01,
        5.63503883e+01, -1.99328381e+00, -1.96311739e+01, -6.31537391e+01,
        1.90048507e+02, -5.82833652e+01,  3.23850606e+02, -2.02603999e+02,
       -9.79288869e+01, -3.71888678e+01,  1.57037268e+01, -1.74189084e+02,
       -3.00045152e+01, -4.04413302e+02, -3.72117018e+01, -8.32306518e+02,
        6.07894901e+02,  3.70368132e+00, -5.72071064e+01,  3.87885912e+02,
        7.10034011e+02,  8.36847566e+00, -2.98893812e+00,  1.21016560e+02,
        1.10504231e+03,  2.21121640e+02, -4.43423671e+02,  4.64608325e+01,
       -3.48851098e+02,  9.39087076e+01, -2.36835244e+01,  2.37832968e+01,
       -3.62080296e+01,  1.10966934e+02,  5.11768111e+02, -1.48432966e+02,
       -6.60924181e+01, -1.64157155e+02, -4.50935317e+01,  5.00973279e+01,
       -2.30184779e+02, -2.92805926e+00,  2.24119848e+02, -1.86482237e+01,
       -1.87036371e+01, -9.81905862e+00,  1.16390072e+01,  2.46113823e+01,
       -6.08645416e+01, -2.00243819e+02, -5.76687847e+01,  3.13568167e+02,
        4.76190588e+02,  3.07176514e+02,  9.20257239e+02, -9.66137376e+02,
       -1.04390710e+03,  2.35501530e+03, -4.98892790e+02, -3.83389408e+02,
        7.76895753e+02, -8.36652157e+02,  1.17647568e+03,  2.45925102e+02,
        3.71012491e+02, -1.64423973e+03, -2.59109387e+01, -8.78778881e+02,
        7.99815240e+02,  1.30653238e+03, -6.27494707e+03,  3.36143712e+02,
       -1.75420947e+01,  1.45776724e+03,  6.38354101e+01, -2.58835982e+03,
       -5.59086149e+02, -5.01463275e+02,  1.48824377e+03, -9.71981910e+02,
       -1.29177552e+03,  2.00605515e+02, -5.05279576e+02, -8.42008442e+02,
        7.99342593e+01,  6.71813239e+01,  2.47918725e+02, -5.78734409e+02,
        3.38748415e+02,  1.58317066e+03,  2.57432162e+03, -6.58536306e+02,
       -1.33379255e+03,  2.04801850e+02,  1.11585764e+03, -2.37478683e+03,
        4.08111874e+02,  1.74992722e+03,  1.82119382e+03, -9.19501099e+01,
        5.91448585e+02, -5.03996851e+01, -5.34767753e+01,  9.28955181e+01,
        1.51591455e+03,  1.10687864e+03, -1.94850160e+02,  3.25094391e+03,
       -3.34262661e+01, -3.36971993e+02,  1.08357322e+03, -5.67108024e+01,
       -6.18264933e+02,  9.93574723e+02,  1.10675013e+03,  3.69189336e+03,
       -1.33359070e+02, -2.33400820e+02, -3.48879803e+03, -6.22172652e+01,
        1.54026445e+03, -1.41844204e+03, -1.21651617e+02, -3.48821157e+02,
        4.87847610e+03,  4.31606528e+01, -2.26870694e+01, -3.83746646e+01,
        6.51191612e+03,  2.30360580e+03,  1.22683091e+03, -2.90879508e+02,
        7.61376169e+02,  5.43238988e+03,  2.62512269e+03,  4.79728788e+03,
        2.03494178e+03, -6.18350586e+03, -1.84902741e+03,  5.19384157e+03,
       -1.26104338e+03, -2.13478475e+03,  2.46760285e+02, -6.02299230e+03,
        6.11459595e+02, -1.61071233e+03,  1.02408289e+02,  4.10033748e+03,
       -7.04044637e+03, -2.51085589e+03,  3.97938943e+03,  2.24378025e+03,
       -6.43539175e+03, -1.78743534e+03,  2.42801124e+03, -4.32856821e+01,
        3.19860334e+03,  2.02176429e+03,  1.77580437e+03,  1.57247830e+03,
       -1.95019941e-01,  6.39579206e+02,  8.84447246e+02, -1.46267087e+02,
        2.10572681e+01,  8.24925223e+01, -7.41113807e+02, -9.36206144e+02,
       -8.69884511e+01, -1.43335744e+02, -4.21612700e+02, -1.44902173e+02,
       -1.08246031e+01,  4.18411664e+01,  4.47134750e+00,  5.52601344e-01,
       -6.94091654e+00, -2.78627028e+02, -8.90118669e+01, -9.88020256e+01,
       -3.89977312e+02, -4.18826124e+02, -3.18588358e+01,  8.69317398e+02,
       -1.31526340e+02, -1.60674696e+02, -7.92131040e+01,  4.92113627e+01,
        1.20703666e+02,  1.97832961e+02,  1.73603824e+00, -9.88738283e+01,
       -1.99324229e+01,  9.41858173e+01, -2.59131585e+02, -1.16750013e+02,
       -2.22576992e+02,  7.10441788e+01,  4.58957461e+02,  3.41395886e+01,
       -1.84622335e+02, -1.79458551e+01, -5.98009499e+01, -8.20025789e+01,
       -5.71993269e+01,  6.87769412e+02, -9.51813230e+01,  1.90696728e+02,
        6.40454031e+01, -4.73396144e+02, -1.90087309e+02,  2.85698961e+02,
        8.60352420e+01, -6.89725610e+01, -1.52512540e+02, -1.16889923e+02,
        8.08897003e+01, -1.52122608e+02, -6.70507747e+01, -3.88167735e+01,
       -1.59399088e+02, -3.10086819e+02, -8.56744377e+01, -5.70715570e+01,
        3.84665610e+01, -1.94555156e+02,  2.17328244e+01,  2.14616258e+02,
       -2.96481428e+02, -5.68587699e+00,  3.27603619e+02,  2.64611050e+01,
        2.59134058e+01, -2.39629093e+02, -1.10832261e+02,  1.14298240e+02,
       -4.82602471e+01, -1.05111677e+02,  2.21294638e+01, -2.63911495e+02,
       -1.78360724e+02, -2.12480240e+02,  1.74211453e+01, -1.87244483e+02,
       -3.33020834e+01, -4.79799625e+01,  3.25219278e+01, -1.14467510e+02,
       -4.82757172e+01,  1.95030758e+02, -8.69718569e+00,  9.86029076e+01,
       -3.13263898e+03, -3.06823466e+02, -2.39485027e+03, -6.02380620e+03,
       -2.09747012e+03, -3.18532418e+03,  1.28050366e+03,  2.37093375e+03,
       -3.63054193e+03, -2.29049109e+03, -7.42222185e+02,  5.32291594e+02,
        1.40937032e+02,  2.31100149e+03, -2.52595767e+03,  4.96912267e+03,
       -6.07002463e+03, -1.36206157e+03,  2.57929527e+02,  6.60969107e+03,
       -2.38128840e+03,  1.44098606e+03,  7.71704305e+02, -9.66306064e+01,
       -1.76559849e+02,  2.48271385e+03,  3.61201473e+03,  1.02540528e+03,
        7.73424826e+03,  8.12254091e+03,  1.21197215e+03,  1.72073051e+03,
        5.22456104e+02, -1.55438058e+02, -7.30007501e+01,  2.34219713e+03,
       -6.72658947e+02, -8.46403904e+02, -9.67782045e+01, -2.57641341e+03,
       -2.54945672e+01, -6.75589439e+02, -5.51533518e+02,  4.68553039e+02,
        1.09099192e+03, -9.09656562e+02, -6.79646536e+00, -1.98196816e+03,
       -8.13168519e+02, -3.73704284e+02, -1.56278690e+03,  4.68535576e+02,
       -1.21362760e+02, -4.25721959e+02, -9.28315631e+02,  1.88186298e+03,
       -1.45247246e+03, -9.21559764e+02, -5.24677518e+02, -3.91044477e+02,
        1.79892541e+02,  8.31824707e+01,  8.54886299e+01,  5.32256319e+01,
       -1.45098627e+02,  1.25222897e+03,  6.39790032e+02, -6.31373819e+02,
        1.21103661e+02,  7.44111674e+01, -7.30787917e+02,  6.33725636e+02,
        9.62258463e+02,  2.03405400e+01,  7.25747001e+01, -7.36616791e+01,
       -3.09008764e+02, -2.18804823e+02, -9.57607001e+02, -1.30280143e+03,
        7.69161096e+02, -3.17920422e+02, -1.02842719e+02,  1.14922464e+02,
       -1.19389107e+03,  2.97665467e+02,  3.09193079e+02,  6.68360243e+01,
        4.00970437e+02, -1.92172456e+02,  1.06706175e+03,  2.25282897e+02,
       -1.70421627e+02,  1.81612186e+02,  2.04695681e+02, -4.94982762e+02,
        4.28099120e+02, -7.75792718e+02, -4.99416104e+02,  6.19781447e+01,
        2.90688532e+03, -2.87582634e+02, -5.70218328e+01,  2.11892446e+02,
       -2.00050053e+03,  6.23161924e+02, -1.25618473e+02,  1.84787020e+01,
        1.10258045e+02,  2.04559431e+03,  2.38257593e+02, -8.09995265e+02,
       -1.58586283e+03,  2.96975094e+02,  1.30395143e+03, -3.45442130e+03,
        1.77483008e+02,  7.72068966e+02,  9.24027120e+02, -2.15270286e+03,
        1.99554099e+03,  2.74228241e+02, -1.43525343e+03,  1.18839728e+03,
        4.39935261e+03, -2.15760871e+03,  2.38596058e+03, -2.21223184e+03,
        2.96557902e+02, -1.05602406e+03,  4.13361965e+02,  4.67307055e+02,
        3.33061335e+03,  4.68046420e+03, -5.11460694e+03,  6.71717380e+01,
        2.20262290e+03, -1.26690703e+01, -1.82674707e+01,  5.26591953e+02,
        4.66288132e+03,  5.68208420e+03, -3.27458978e+03, -7.87429708e+03,
        1.67415626e+02, -5.58478013e+01, -4.44623440e+03,  1.78018218e+02,
        4.66036645e+03, -1.15652343e+04,  6.63156675e+03,  3.97217593e+03,
        6.13421091e+02, -2.65527872e+02, -3.76962385e+02,  2.15069018e+03,
       -4.17079966e+03,  8.00459140e+02,  4.66693499e+03, -4.20181474e+02,
        3.66650158e+03,  3.50816837e+03, -1.42650919e+03,  3.43995780e+02,
        5.42497288e+01, -7.41239104e+01, -5.60684055e+03, -5.13297760e+03,
        4.86943827e+03,  2.00140115e+02, -4.09516720e+01,  4.22387335e+00,
       -3.00530001e+01, -1.85932150e+03,  9.19333624e+01,  9.03451905e+01,
        7.75459940e+01,  1.61768695e+03,  1.35398862e+03,  3.22112499e+03,
        2.15527383e+02, -1.45233326e+03, -4.73246029e+02,  1.63499279e+02,
        2.38943028e+03, -6.67989236e+02,  1.38690468e+02,  4.70106208e+03,
       -2.78048304e+03, -6.74747932e+02,  6.81566727e+01, -3.54594772e+01,
        1.27761014e+01,  1.28317361e+02, -7.63297371e+02,  1.53947971e+02,
       -4.55963940e+02,  1.10521023e+03, -3.96603949e+03, -2.16406973e+03,
       -7.43283268e+02, -6.60126775e+02, -1.61263518e+03,  5.44137827e+02,
        8.86612280e+02,  1.91046554e+02, -5.67171246e+03,  9.28225190e+02,
        2.26427291e+03, -1.41516971e+02, -2.26729273e+03,  1.46816093e+03,
        3.20171429e+03, -9.74871057e+02,  5.55295177e+02,  1.27842015e+03,
       -1.98501664e+03, -3.68057218e+03,  8.06186229e+02,  1.83041443e+03,
       -2.51073111e+03, -1.18158915e+03, -1.58164600e+02,  5.82929820e+02,
        9.65841753e+01, -1.32981086e+03, -4.85337317e+01, -4.55156901e+02,
       -4.08182996e+03,  6.81763185e+02, -1.43669612e+03, -1.77712078e+03,
        3.27225499e+03, -9.52035066e+01, -6.02404556e+02, -5.24512982e+03,
        2.33956817e+03, -1.08588176e+03,  1.02823335e+03,  7.26431333e+02,
        3.13749089e+02,  3.55186819e+03,  1.05246663e+03, -6.36070517e+02,
       -6.69509361e+01, -2.24016811e+03,  5.77468547e+03,  1.83647269e+03,
        3.86179142e+02,  4.38362529e+01,  8.08678115e+02, -4.43307160e+00])

sparse_points = [
    1, 2, 3, 4, 5, 8, 13, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 29, 30, 
    33, 34, 35, 36, 37, 38, 43, 44, 46, 47, 48, 49, 50, 51, 53, 54, 57, 61, 62,
    63, 64, 65, 66, 68, 70, 71, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 84, 85, 
    86, 89, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 107, 108, 109, 110,
    111, 113, 114, 116, 117, 120, 123, 124, 125, 126, 127, 128, 129, 132, 133, 134, 
    137, 142, 143, 144, 145, 146, 147, 148, 149, 150, 151, 152, 154, 155, 156, 157, 
    158, 159, 161, 163, 164, 167, 168, 169, 181, 182, 183, 185, 187, 190, 192, 194, 
    195, 196, 197, 205, 207, 210, 217, 218, 225, 233, 238, 249, 254, 256, 262, 274, 
    286, 288, 294, 297, 303, 311, 312, 316, 317, 321, 333, 336, 338, 345, 346, 352, 
    369, 371, 373, 377, 378, 381, 383, 384, 396, 397, 406, 409, 411, 416, 420, 424, 
    427, 437, 438, 442, 447, 449, 462, 466, 474, 476, 481, 482, 485, 487, 490, 492, 
    502, 503, 504, 506, 509, 511, 515, 525, 527, 532, 541, 550, 553, 554, 556, 557, 
    559, 566, 567, 570, 571, 573, 574, 576, 577, 581, 593, 594, 595, 596, 597, 598, 
    599, 600, 601, 603, 606, 608, 611, 612, 615, 617, 648, 652, 656, 659, 663, 665, 
    672, 673, 675, 676, 682, 683, 684, 685, 693, 701, 705, 721, 725, 726, 728, 738, 
    742, 743, 744, 757, 765, 766, 767, 774, 775, 785, 794, 797, 805, 810, 812, 817, 
    818, 819, 820, 821, 822, 823, 824, 825, 826, 827, 828, 829, 830, 831, 832, 833, 
    834, 835, 836, 837, 838, 839, 840, 841, 842, 843, 844, 845, 846, 847, 848, 849, 
    851, 852, 853, 854, 855, 856, 857, 858, 859, 860, 861, 862, 863, 864, 865, 866, 
    867, 868, 869, 870, 871, 872, 873, 874, 875, 876, 877, 878, 879, 880, 881, 882, 
    883, 884, 885, 887, 888, 889, 890, 891, 892, 893, 894, 895, 896, 897, 899, 901, 
    902, 903, 904, 905, 907, 908, 909, 910, 911, 912, 913, 917, 918, 923, 929, 931, 
    933, 934, 938, 945, 947, 949, 952, 955, 956, 958, 962, 963, 969, 974, 975, 976, 
    977, 980, 982, 983, 984, 991, 993, 1005, 1007, 1009, 1012, 1013, 1016, 1018, 1020, 
    1021, 1023, 1024, 1025, 1026, 1028, 1035, 1036, 1039, 1041, 1044, 1046, 1048, 1051, 
    1054, 1055, 1060, 1074, 1076, 1081, 1083, 1085, 1088, 1091, 1094, 1096, 1097, 1100,
    1101, 1105, 1106, 1109, 1113, 1114, 1119, 1122, 1124, 1126, 1127, 1128, 1129, 1130,
    1132, 1139, 1147, 1152, 1154, 1162, 1176, 1177, 1182, 1183, 1194, 1195, 1196, 1197, 
    1198, 1199, 1200, 1201, 1202, 1203, 1204, 1205, 1206, 1207, 1208, 1210, 1211, 1212, 
    1213, 1214, 1215, 1216, 1217, 1219, 1221, 1222, 1223, 1224, 1225, 1227, 1228, 1229,
    1230, 1231, 1232, 1234, 1235, 1236, 1237, 1238, 1239, 1240, 1241, 1242, 1243, 1245, 
    1246, 1247, 1248, 1249, 1250, 1251, 1252, 1253, 1254, 1255, 1256, 1257, 1259, 1260, 
    1261, 1262, 1263, 1264, 1266, 1267, 1271, 1273, 1274, 1275, 1277, 1278, 1279, 1280, 
    1281, 1282, 1283, 1284, 1285, 1286, 1287, 1288, 1289, 1290, 1294, 1295, 1296, 1297, 
    1298, 1299, 1300, 1301, 1305, 1306, 1307, 1308, 1309, 1310, 1313, 1314, 1316, 1317, 
    1318, 1320, 1321, 1322, 1323, 1324, 1329, 1330, 1331, 1333, 1334, 1339, 1340, 1341, 
    1342, 1343, 1348, 1349, 1354, 1361, 1363, 1365, 1368, 1369, 1373, 1381, 1386, 1391, 
    1392, 1398, 1399, 1402, 1403, 1407, 1411, 1413, 1414, 1421, 1423, 1424, 1427, 1429,
    1430, 1434, 1437, 1451, 1452, 1453, 1456, 1459, 1460, 1462, 1465, 1466, 1470, 1471,
    1475, 1477, 1479, 1484, 1488, 1490, 1499, 1501, 1502, 1506, 1507, 1508, 1513, 1516,
    1517, 1520, 1521, 1526, 1528, 1542, 1544, 1546, 1548, 1551, 1553, 1563, 1570, 1571,
    1575, 1579, 1582, 1584, 1597, 1598, 1601, 1603, 1607, 1622, 1631, 1633, 1647, 1653,
    1655, 1659, 1660, 1677, 1692, 1694, 1703, 1704, 1705, 1722, 1743, 1744, 1747, 1748,
    1750, 1755, 1756, 1758, 1759, 1760, 1762, 1763, 1764, 1766, 1767, 1768, 1769, 1770,
    1771, 1772, 1773, 1774, 1775, 1776, 1777, 1778, 1779, 1781, 1782, 1783, 1784, 1785,
    1786, 1787, 1788, 1789, 1790, 1791, 1792, 1793, 1794, 1795, 1796, 1797, 1799, 1800,
    1801, 1802, 1803, 1804, 1805, 1807, 1808, 1809, 1810, 1812, 1813, 1814, 1815, 1816,    
    1818, 1819, 1820, 1821, 1824, 1825, 1827, 1828, 1829, 1830, 1831, 1832, 1833, 1835, 
    1836, 1837, 1838, 1839, 1840, 1841, 1843, 1845, 1846, 1847, 1848, 1849, 1850, 1851, 
    1853, 1854, 1855, 1873, 1879, 1886, 1892, 1895, 1896, 1901, 1903, 1913, 1921, 1922, 
    1923, 1925, 1932, 1943, 1951, 1965, 1975, 1978, 1980, 2004, 2015, 2017, 2019, 2020, 
    2021, 2025, 2028, 2031, 2034, 2043, 2046, 2047, 2049, 2050, 2054, 2061, 2067, 2068, 
    2069, 2072, 2073, 2075, 2076, 2077, 2079, 2081, 2084, 2086, 2088, 2090, 2092, 2093, 
    2094, 2095, 2097, 2099, 2106, 2108, 2109, 2110, 2111, 2113, 2114, 2116, 2117, 2118, 
    2122, 2123, 2124, 2125, 2126, 2127, 2128, 2129, 2130, 2131, 2132, 2133, 2135, 2144, 
    2145, 2146, 2147, 2148, 2149, 2151, 2152, 2158, 2161, 2163, 2164, 2165, 2166, 2168, 
    2169, 2170, 2171, 2176, 2177, 2179, 2181, 2185, 2186, 2189, 2191, 2192, 2195, 2196, 
    2197, 2202, 2205, 2206, 2209, 2210, 2211, 2213, 2217, 2218, 2219, 2220, 2221, 2224, 
    2231, 2233, 2234, 2235, 2236, 2237, 2238, 2239, 2240, 2246, 2248, 2249, 2251, 2253, 
    2255, 2256, 2257, 2259, 2267, 2273, 2274, 2289, 2292, 2296, 2303, 2305, 2306, 2307, 
    2308, 2319, 2326, 2329, 2330, 2332, 2333, 2334, 2335, 2346, 2349, 2354, 2357, 2362, 
    2365, 2374, 2379, 2388, 2397, 2398, 2401, 2403, 2404, 2405, 2406, 2407, 2408, 2409, 
    2410, 2411, 2413, 2416, 2422, 2424, 2426, 2429, 2434, 2437, 2448, 2454, 2455, 2456, 
    2459, 2460, 2461, 2463, 2464, 2469, 2474, 2476, 2478, 2481, 2482, 2484, 2489, 2491, 
    2494, 2495, 2499, 2503, 2504, 2508, 2513, 2517, 2520, 2522, 2524, 2525, 2531, 2534, 
    2535, 2536, 2538, 2549, 2552, 2553, 2555, 2556, 2563, 2565, 2566, 2567, 2568, 2569, 
    2570, 2578, 2585, 2587, 2589, 2591, 2593, 2596, 2598, 2600, 2605, 2609, 2610, 2612, 
    2613, 2617, 2619
]


@unittest.skipIf(os.environ['HAVE_GAP'] != '1', 'GAP support not enabled')
class TestGAP_fit_silion(quippytest.QuippyTestCase):
    
    with open('sparse_file', 'w') as fh:
        for sp in sparse_points:
            fh.write(f'{sp}\n')
            
    command_line = ("at_file=train_sub3.xyz gap={soap l_max=8 n_max=8 atom_sigma=0.5 "
                    "zeta=4 cutoff=4.0 cutoff_transition_width=1.0 central_weight=1.0 "
                    "n_sparse=1000 delta=3.0 f0=0.0 covariance_type=dot_product "
                    "sparse_method=index_file sparse_file=sparse_file} "
                    "default_sigma={0.001 0.1 0.05 0.0} "
                    "energy_parameter_name=dft_energy force_parameter_name=dft_force "
                    "virial_parameter_name=dft_virial config_type_parameter_name=config_type "
                    "sparse_jitter=1.0e-8 e0_offset=2.0 gp_file=gp.xml rnd_seed=1")
    os.system('gap_fit '+command_line)
    
    tree = ET.parse('gp.xml')
    root = tree.getroot()
    gp_label = root.tag
    
    # check GP coefficients match expected values
    alpha = np.array([float(tag.attrib['alpha']) for tag in root[1][1][0].findall('sparseX')])
    print(len(alpha), repr(alpha))
    print(alpha - alpha_ref)
    print(np.abs(alpha - alpha_ref).max())
    assert np.abs(alpha - alpha_ref).max() < 1e-4
    
    pot = Potential(f'xml_label={gp_label}', param_filename='gp.xml')
    
    dataset = read('train_sub3.xyz@:')
    for atoms in dataset:
        atoms.calc = pot
        info = {k.lower(): v for k, v in atoms.info.items() }
        arrays = {k.lower(): v for k, v in atoms.arrays.items() }
        energy = atoms.get_potential_energy()
        # atoms.info['gap_energy'] = energy
        forces = atoms.get_forces()
        # atoms.arrays['gap_forces'] = forces        

        # check for consistency with reference GAP model        
        assert abs(atoms.info['gap_energy'] - energy) < 1e-6        
        assert np.abs(atoms.arrays['gap_forces'] - forces).max() < 1e-6

        # check error wrt training data
        de = abs(energy - info['dft_energy']) / len(atoms)
        assert de < 1e-3        
        
        df = np.sqrt(((forces - arrays['dft_force'])**2).mean())
        assert df < 0.3
        
        if 'dft_virial' in atoms.info:
            stress = atoms.get_stress()        
            virial = - voigt_6_to_full_3x3_stress(stress * atoms.get_volume())
            # atoms.info['gap_virial'] = virial
            assert np.abs(atoms.info['gap_virial'] - virial).max() < 1e-6
            
            dft_virial = info['dft_virial'].reshape((3, 3), order='F')
            dv = np.sqrt(((virial - dft_virial)**2).mean())
            assert dv < 3.0
            
    from ase.io import write
    # write('dump.xyz', dataset)


if __name__ == '__main__':
    unittest.main()
