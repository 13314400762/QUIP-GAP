<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>f2py_wrapper_gen &mdash; quippy  documentation</title>
    
    <link rel="stylesheet" href="../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="quippy  documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">quippy  documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/hybrid.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for f2py_wrapper_gen</h1><div class="highlight"><pre>
<span class="c"># HQ XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span>
<span class="c"># HQ X</span>
<span class="c"># HQ X   quippy: Python interface to QUIP atomistic simulation library</span>
<span class="c"># HQ X</span>
<span class="c"># HQ X   Copyright James Kermode 2010</span>
<span class="c"># HQ X</span>
<span class="c"># HQ X   These portions of the source code are released under the GNU General</span>
<span class="c"># HQ X   Public License, version 2, http://www.gnu.org/copyleft/gpl.html</span>
<span class="c"># HQ X</span>
<span class="c"># HQ X   If you would like to license the source code under different terms,</span>
<span class="c"># HQ X   please contact James Kermode, james.kermode@gmail.com</span>
<span class="c"># HQ X</span>
<span class="c"># HQ X   When using this software, please cite the following reference:</span>
<span class="c"># HQ X</span>
<span class="c"># HQ X   http://www.jrkermode.co.uk/quippy</span>
<span class="c"># HQ X</span>
<span class="c"># HQ XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span>

<span class="kn">from</span> <span class="nn">f90doc</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">numpy</span><span class="o">,</span> <span class="nn">re</span>

<div class="viewcode-block" id="wrap_mod"><a class="viewcode-back" href="../f2py_wrapper_gen.html#f2py_wrapper_gen.wrap_mod">[docs]</a><span class="k">def</span> <span class="nf">wrap_mod</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">type_map</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">kindlines</span><span class="o">=</span><span class="p">[],</span> <span class="n">initlines</span><span class="o">=</span><span class="p">{},</span> <span class="n">filtertypes</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span>
             <span class="n">callback_routines</span><span class="o">=</span><span class="p">{},</span><span class="n">public_symbols</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">sizeof_fortran_t</span><span class="o">=</span><span class="mi">12</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;Given an f90doc.C_module class &#39;mod&#39;, write a F90 wrapper file suitable for f2py to &#39;out&#39;.&quot;&quot;&quot;</span>
   <span class="n">spec</span> <span class="o">=</span> <span class="p">{}</span>
   <span class="k">def</span> <span class="nf">strip_type</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;type(&#39;</span><span class="p">):</span>
         <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;(&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">t</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;)&#39;</span><span class="p">)]</span>
      <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

   <span class="k">def</span> <span class="nf">println</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
      <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">((</span><span class="s">&#39; &#39;</span><span class="o">*</span><span class="n">indent</span><span class="p">),</span><span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">)))</span>

   <span class="k">def</span> <span class="nf">default_value</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
      <span class="n">lookup</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;real(dp)&#39;</span><span class="p">:</span> <span class="s">&#39;-1.0_dp&#39;</span><span class="p">,</span>
                <span class="s">&#39;integer&#39;</span><span class="p">:</span> <span class="s">&#39;-1&#39;</span><span class="p">,</span>
                <span class="s">&#39;character*(1)&#39;</span><span class="p">:</span> <span class="s">&#39;&quot;@&quot;&#39;</span><span class="p">,</span>
                <span class="s">&#39;character*(*)&#39;</span><span class="p">:</span> <span class="s">&#39;&quot;@&quot;&#39;</span><span class="p">}</span>
      <span class="k">if</span> <span class="nb">type</span> <span class="ow">in</span> <span class="n">lookup</span><span class="p">:</span> <span class="k">return</span> <span class="n">lookup</span><span class="p">[</span><span class="nb">type</span><span class="p">]</span>
      <span class="k">elif</span> <span class="nb">type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;character&#39;</span><span class="p">):</span> <span class="k">return</span> <span class="s">&#39;&quot;@&quot;&#39;</span>
      <span class="k">elif</span> <span class="nb">type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;type&#39;</span><span class="p">):</span> <span class="k">return</span> <span class="s">&#39;-1&#39;</span>

   <span class="c"># Skip things with callbacks (for now...)</span>
   <span class="k">def</span> <span class="nf">no_callbacks</span><span class="p">(</span><span class="n">sub</span><span class="p">):</span>
      <span class="k">try</span><span class="p">:</span>
          <span class="n">types</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sub</span><span class="o">.</span><span class="n">arguments</span><span class="p">]</span>
          <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">attributes</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sub</span><span class="o">.</span><span class="n">arguments</span><span class="p">]</span>
      <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
         <span class="k">return</span> <span class="n">sub</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">callback_routines</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

      <span class="k">return</span> <span class="bp">True</span>

   <span class="c"># Also skip allocatable and pointer array arguments</span>
   <span class="c"># (and return type if sub is a function)</span>
   <span class="k">def</span> <span class="nf">no_allocatables_or_pointers</span><span class="p">(</span><span class="n">sub</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">sub</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;initialise_ptr&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">sub</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;finalise_ptr&#39;</span><span class="p">):</span>
         <span class="k">return</span> <span class="bp">True</span>
      <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">sub</span><span class="o">.</span><span class="n">arguments</span><span class="p">:</span>
          <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&#39;attributes&#39;</span><span class="p">):</span> <span class="k">continue</span>
         
          <span class="c"># FIXME: this skips scalar pointer args too</span>

          <span class="k">if</span> <span class="p">(</span><span class="s">&#39;allocatable&#39;</span> <span class="ow">in</span> <span class="n">arg</span><span class="o">.</span><span class="n">attributes</span> <span class="ow">or</span> <span class="s">&#39;pointer&#39;</span> <span class="ow">in</span> <span class="n">arg</span><span class="o">.</span><span class="n">attributes</span><span class="p">):</span>
             <span class="k">if</span> <span class="ow">not</span> <span class="s">&#39;optional&#39;</span> <span class="ow">in</span> <span class="n">arg</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>

          <span class="c"># arrays of derived type are out as well</span>
          <span class="n">dims</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;dimension&#39;</span><span class="p">),</span> <span class="n">arg</span><span class="o">.</span><span class="n">attributes</span><span class="p">)</span>
          <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">arg</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;type&#39;</span><span class="p">):</span>
              <span class="k">return</span> <span class="bp">False</span>

      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="n">C_funct</span><span class="p">):</span>
          <span class="k">if</span> <span class="s">&#39;allocatable&#39;</span> <span class="ow">in</span> <span class="n">sub</span><span class="o">.</span><span class="n">ret_val</span><span class="o">.</span><span class="n">attributes</span> <span class="ow">or</span> <span class="s">&#39;pointer&#39;</span> <span class="ow">in</span> <span class="n">sub</span><span class="o">.</span><span class="n">ret_val</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
              <span class="k">return</span> <span class="bp">False</span>

      <span class="k">return</span> <span class="bp">True</span>

   <span class="k">def</span> <span class="nf">no_complex_scalars</span><span class="p">(</span><span class="n">sub</span><span class="p">):</span>
      <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">sub</span><span class="o">.</span><span class="n">arguments</span><span class="p">:</span>
          <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&#39;attributes&#39;</span><span class="p">):</span> <span class="k">continue</span>         
          <span class="n">dims</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;dimension&#39;</span><span class="p">),</span> <span class="n">arg</span><span class="o">.</span><span class="n">attributes</span><span class="p">)</span>
          <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;complex&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="bp">False</span>

      <span class="k">return</span> <span class="bp">True</span>


   <span class="k">def</span> <span class="nf">no_c_ptr</span><span class="p">(</span><span class="n">sub</span><span class="p">):</span>
      <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">sub</span><span class="o">.</span><span class="n">arguments</span><span class="p">:</span>
          <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&#39;attributes&#39;</span><span class="p">):</span> <span class="k">continue</span>      
          <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;type(c_ptr)&#39;</span><span class="p">:</span> <span class="k">return</span> <span class="bp">False</span>

      <span class="k">return</span> <span class="bp">True</span>

   <span class="c"># Only wrap certain types</span>
   <span class="k">def</span> <span class="nf">no_bad_types</span><span class="p">(</span><span class="n">sub</span><span class="p">):</span>
      <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">sub</span><span class="o">.</span><span class="n">arguments</span><span class="p">:</span>
         <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&#39;attributes&#39;</span><span class="p">):</span> <span class="k">continue</span>      
         <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;type&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">strip_type</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">type</span><span class="p">)</span> <span class="ow">in</span> <span class="n">filtertypes</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;omitting routine </span><span class="si">%s</span><span class="s"> as argument </span><span class="si">%s</span><span class="s"> of unwrapped type </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">arg</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
      <span class="k">return</span> <span class="bp">True</span>

   <span class="k">def</span> <span class="nf">no_private_symbols</span><span class="p">(</span><span class="n">sub</span><span class="p">):</span>
      <span class="n">subname</span> <span class="o">=</span> <span class="n">sub_to_interface</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">sub</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">subname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">public_symbols</span><span class="p">]</span>
      

   <span class="n">debug</span><span class="p">(</span><span class="n">mod</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
   <span class="n">shortname</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">name</span><span class="p">[:</span><span class="n">mod</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;_module&#39;</span><span class="p">)]</span>

   <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">out</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="c">#open(&#39;%s.f90&#39; %shortname, &#39;w&#39;)</span>

   <span class="c"># Interfaces</span>
   <span class="n">sub_to_interface</span> <span class="o">=</span> <span class="p">{}</span>
   <span class="n">subts</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="n">no_callbacks</span><span class="p">,</span> <span class="n">mod</span><span class="o">.</span><span class="n">subts</span><span class="p">)</span>
   <span class="n">functs</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="n">no_callbacks</span><span class="p">,</span> <span class="n">mod</span><span class="o">.</span><span class="n">functs</span><span class="p">)</span>
   <span class="k">for</span> <span class="n">intf</span> <span class="ow">in</span> <span class="n">mod</span><span class="o">.</span><span class="n">interfaces</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">intf</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;operator(&#39;</span><span class="p">):</span> <span class="k">continue</span>
      <span class="n">thissubs</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="n">no_callbacks</span><span class="p">,</span> <span class="n">intf</span><span class="o">.</span><span class="n">subts</span><span class="p">)</span>
      <span class="n">thisfuncts</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="n">no_callbacks</span><span class="p">,</span> <span class="n">intf</span><span class="o">.</span><span class="n">functs</span><span class="p">)</span>
      <span class="n">subts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">thissubs</span><span class="p">)</span>
      <span class="n">functs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">thisfuncts</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">thissubs</span> <span class="o">+</span> <span class="n">thisfuncts</span><span class="p">:</span>
         <span class="n">sub_to_interface</span><span class="p">[</span><span class="n">sub</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">intf</span><span class="o">.</span><span class="n">name</span>

   <span class="n">subts</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="n">no_allocatables_or_pointers</span><span class="p">,</span> <span class="n">subts</span><span class="p">)</span>
   <span class="n">functs</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="n">no_allocatables_or_pointers</span><span class="p">,</span> <span class="n">functs</span><span class="p">)</span>

   <span class="n">subts</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="n">no_complex_scalars</span><span class="p">,</span> <span class="n">subts</span><span class="p">)</span>
   <span class="n">functs</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="n">no_complex_scalars</span><span class="p">,</span> <span class="n">functs</span><span class="p">)</span>

   <span class="n">subts</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="n">no_c_ptr</span><span class="p">,</span> <span class="n">subts</span><span class="p">)</span>
   <span class="n">functs</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="n">no_c_ptr</span><span class="p">,</span> <span class="n">functs</span><span class="p">)</span>

   <span class="k">if</span> <span class="n">filtertypes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">print</span> <span class="s">&#39;Filtering routines to exclude derived types not in list </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">filtertypes</span>
      <span class="n">subts</span>  <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="n">no_bad_types</span><span class="p">,</span> <span class="n">subts</span><span class="p">)</span>
      <span class="n">functs</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="n">no_bad_types</span><span class="p">,</span> <span class="n">functs</span><span class="p">)</span>

   <span class="k">if</span> <span class="n">public_symbols</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">print</span> <span class="s">&#39;Filtering routines to exclude routines not in list of public symbols </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">public_symbols</span>
      <span class="n">subts</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="n">no_private_symbols</span><span class="p">,</span> <span class="n">subts</span><span class="p">)</span>
      <span class="n">functs</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="n">no_private_symbols</span><span class="p">,</span> <span class="n">functs</span><span class="p">)</span>

   <span class="n">debug</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">: </span><span class="si">%d</span><span class="s"> subs&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mod</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">subts</span><span class="o">+</span><span class="n">functs</span><span class="p">)))</span>

   <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">subts</span><span class="o">+</span><span class="n">functs</span><span class="p">]</span>
   <span class="k">if</span> <span class="n">shortname</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span> <span class="n">shortname</span> <span class="o">+=</span> <span class="s">&#39;_&#39;</span>

   <span class="n">indent</span> <span class="o">=</span> <span class="mi">0</span>

   <span class="n">spec</span><span class="p">[</span><span class="n">shortname</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;doc&#39;</span><span class="p">:</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mod</span><span class="o">.</span><span class="n">doc</span><span class="p">),</span>
                                  <span class="s">&#39;routines&#39;</span><span class="p">:</span> <span class="p">{},</span>
                                  <span class="s">&#39;types&#39;</span><span class="p">:</span> <span class="p">{},</span>
                                  <span class="s">&#39;interfaces&#39;</span><span class="p">:</span> <span class="p">{},</span>
                                  <span class="s">&#39;parameters&#39;</span><span class="p">:</span> <span class="p">[]}</span>

   <span class="c"># for some reason setting parameters in Fortran causes an AssertionError</span>
   <span class="c"># when importing module. For now, let&#39;s just copy them into python dictionary</span>
   <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">mod</span><span class="o">.</span><span class="n">elements</span><span class="p">:</span>
      <span class="k">if</span> <span class="s">&#39;parameter&#39;</span> <span class="ow">in</span> <span class="n">el</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
          <span class="n">spec</span><span class="p">[</span><span class="n">shortname</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="s">&#39;parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">el</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">el</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">el</span><span class="o">.</span><span class="n">attributes</span><span class="p">,</span> <span class="n">el</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>

   <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">subts</span> <span class="o">+</span> <span class="n">functs</span><span class="p">:</span>

      <span class="n">arglines</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="n">init</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="n">got_types</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="n">uses</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
      <span class="n">type_lines</span> <span class="o">=</span> <span class="p">[]</span>

      <span class="c"># Imported routine</span>
      <span class="c">##uses.append(&#39;use %s, only: imported_%s =&gt; %s&#39; % (mod.name, sub.name,sub.name))</span>
      <span class="n">uses</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">mod</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
      
      <span class="c"># Add argument for return value, after last non-optional argument</span>
      <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span><span class="s">&#39;ret_val&#39;</span><span class="p">):</span>
          <span class="n">ret_val</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">ret_val</span>
          <span class="n">ret_val</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#39;ret_&#39;</span><span class="o">+</span><span class="n">ret_val</span><span class="o">.</span><span class="n">name</span>
          <span class="n">ret_val</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;intent(out)&#39;</span><span class="p">)</span>
          <span class="n">ret_val</span><span class="o">.</span><span class="n">is_ret_val</span> <span class="o">=</span> <span class="bp">True</span>
          <span class="n">sub</span><span class="o">.</span><span class="n">arguments</span> <span class="o">=</span> <span class="p">([</span> <span class="n">arg</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">sub</span><span class="o">.</span><span class="n">arguments</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&#39;attributes&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&#39;attributes&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s">&#39;optional&#39;</span> <span class="ow">in</span> <span class="n">arg</span><span class="o">.</span><span class="n">attributes</span><span class="p">)</span> <span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">ret_val</span><span class="p">]</span> <span class="o">+</span> 
                           <span class="p">[</span> <span class="n">arg</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">sub</span><span class="o">.</span><span class="n">arguments</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&#39;attributes&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="s">&#39;optional&#39;</span> <span class="ow">in</span> <span class="n">arg</span><span class="o">.</span><span class="n">attributes</span>
                             <span class="ow">and</span> <span class="ow">not</span> <span class="s">&#39;pointer&#39;</span> <span class="ow">in</span> <span class="n">arg</span><span class="o">.</span><span class="n">attributes</span>
                             <span class="ow">and</span> <span class="ow">not</span> <span class="s">&#39;allocatable&#39;</span> <span class="ow">in</span> <span class="n">arg</span><span class="o">.</span><span class="n">attributes</span> <span class="p">])</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="n">sub</span><span class="o">.</span><span class="n">arguments</span> <span class="o">=</span> <span class="p">[</span><span class="n">arg</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">sub</span><span class="o">.</span><span class="n">arguments</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&#39;attributes&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="s">&#39;optional&#39;</span> <span class="ow">in</span> <span class="n">arg</span><span class="o">.</span><span class="n">attributes</span> <span class="ow">or</span>
                          <span class="p">(</span><span class="ow">not</span> <span class="s">&#39;pointer&#39;</span> <span class="ow">in</span> <span class="n">arg</span><span class="o">.</span><span class="n">attributes</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s">&#39;allocatable&#39;</span> <span class="ow">in</span> <span class="n">arg</span><span class="o">.</span><span class="n">attributes</span><span class="p">)]</span>


      <span class="n">args</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">arguments</span>
      <span class="n">old_arg_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>
      <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
         <span class="n">a</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">a</span><span class="o">.</span><span class="n">name</span>
      <span class="n">argnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">args</span><span class="p">][:]</span>
      <span class="n">newargnames</span> <span class="o">=</span> <span class="n">argnames</span><span class="p">[:]</span>

      <span class="n">optionals</span> <span class="o">=</span> <span class="p">[]</span>

      <span class="n">n_dummy</span> <span class="o">=</span> <span class="mi">0</span>

      <span class="n">newname</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">name</span>
      <span class="n">spec</span><span class="p">[</span><span class="n">shortname</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="s">&#39;routines&#39;</span><span class="p">][</span><span class="n">newname</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> \
      <span class="p">{</span><span class="s">&#39;doc&#39;</span><span class="p">:</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">doc</span><span class="p">),</span><span class="s">&#39;args&#39;</span><span class="p">:[],</span> <span class="s">&#39;args_str&#39;</span><span class="p">:</span> <span class="p">{}}</span>
      <span class="n">args_spec</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="n">shortname</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="s">&#39;routines&#39;</span><span class="p">][</span><span class="n">newname</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="s">&#39;args&#39;</span><span class="p">]</span>
      <span class="n">args_str_spec</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="n">shortname</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="s">&#39;routines&#39;</span><span class="p">][</span><span class="n">newname</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="s">&#39;args_str&#39;</span><span class="p">]</span>

      <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">sub</span><span class="o">.</span><span class="n">args_str</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
         <span class="k">print</span> <span class="s">&#39;Sub </span><span class="si">%s</span><span class="s"> setting args_str </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
         <span class="n">args_str_spec</span><span class="p">[</span><span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;value&#39;</span><span class="p">:</span> <span class="n">arg</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                    <span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="n">arg</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                                    <span class="s">&#39;var&#39;</span> <span class="p">:</span> <span class="n">arg</span><span class="o">.</span><span class="n">var</span><span class="p">,</span>
                                    <span class="s">&#39;doc&#39;</span><span class="p">:</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">doc</span><span class="p">)}</span>

      <span class="c"># See if this routine is in any interfaces</span>
      <span class="k">for</span> <span class="n">intf</span> <span class="ow">in</span> <span class="n">mod</span><span class="o">.</span><span class="n">interfaces</span><span class="p">:</span>
          <span class="n">subnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">intf</span><span class="o">.</span><span class="n">subts</span> <span class="o">+</span> <span class="n">intf</span><span class="o">.</span><span class="n">functs</span><span class="p">]</span>
          <span class="k">if</span> <span class="n">sub</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">subnames</span><span class="p">:</span>
              <span class="k">if</span> <span class="ow">not</span> <span class="n">intf</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">spec</span><span class="p">[</span><span class="n">shortname</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="s">&#39;interfaces&#39;</span><span class="p">]:</span>
                  <span class="n">spec</span><span class="p">[</span><span class="n">shortname</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="s">&#39;interfaces&#39;</span><span class="p">][</span><span class="n">intf</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> \
                      <span class="p">{</span><span class="s">&#39;doc&#39;</span><span class="p">:</span> <span class="n">intf</span><span class="o">.</span><span class="n">doc</span><span class="p">,</span>
                       <span class="s">&#39;routines&#39;</span><span class="p">:</span> <span class="p">[]}</span>

              <span class="n">spec</span><span class="p">[</span><span class="n">shortname</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="s">&#39;interfaces&#39;</span><span class="p">][</span><span class="n">intf</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="s">&#39;routines&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

      <span class="n">allocates</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="n">callbacklines</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="n">transfer_in</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="n">transfer_out</span> <span class="o">=</span> <span class="p">[]</span>

      <span class="k">for</span> <span class="n">argindex</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>

          <span class="n">append_argline</span> <span class="o">=</span> <span class="bp">True</span>

          <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&#39;attributes&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&#39;type&#39;</span><span class="p">):</span>
             <span class="n">callback_spec</span> <span class="o">=</span> <span class="n">callback_routines</span><span class="p">[</span><span class="n">sub</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
             <span class="n">arglines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">callback_spec</span><span class="p">[</span><span class="s">&#39;arglines&#39;</span><span class="p">])</span>
             <span class="n">args_spec</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s">&#39;doc&#39;</span><span class="p">:</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">doc</span><span class="p">),</span> <span class="s">&#39;name&#39;</span><span class="p">:</span><span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="s">&#39;callback&#39;</span><span class="p">,</span> <span class="s">&#39;attributes&#39;</span><span class="p">:</span> <span class="n">callback_spec</span><span class="p">[</span><span class="s">&#39;attributes&#39;</span><span class="p">]})</span>
             <span class="n">callbacklines</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s">&#39;if (.false.) then&#39;</span><span class="p">,</span><span class="s">&#39;call </span><span class="si">%s</span><span class="s">(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">callback_spec</span><span class="p">[</span><span class="s">&#39;call&#39;</span><span class="p">]),</span><span class="s">&#39;end if&#39;</span><span class="p">])</span>
             <span class="k">continue</span>

          <span class="n">attributes</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">attributes</span>
          <span class="n">mytype</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">type</span>

          <span class="k">if</span> <span class="s">&#39;optional&#39;</span> <span class="ow">in</span> <span class="n">attributes</span> <span class="ow">and</span> <span class="s">&#39;intent(out)&#39;</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span> 
              <span class="n">attributes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s">&#39;intent(out)&#39;</span><span class="p">)</span>
              <span class="n">attributes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;intent(inout)&#39;</span><span class="p">)</span>

          <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;type&#39;</span><span class="p">):</span>

              <span class="n">tname</span> <span class="o">=</span> <span class="n">strip_type</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>

              <span class="k">if</span> <span class="ow">not</span> <span class="n">tname</span> <span class="ow">in</span> <span class="n">got_types</span><span class="p">:</span>
                 <span class="c">##uses.append(&#39;use %s, only: imported_%s =&gt; %s&#39; % (type_map[tname], tname, tname))</span>
                 <span class="n">uses</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">type_map</span><span class="p">[</span><span class="n">tname</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

                 <span class="n">type_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s">&#39;type </span><span class="si">%s</span><span class="s">_ptr_type&#39;</span> <span class="o">%</span>  <span class="n">tname</span><span class="p">,</span>
                                    <span class="s">&#39;type(</span><span class="si">%s</span><span class="s">), pointer :: p =&gt; NULL()&#39;</span> <span class="o">%</span> <span class="n">tname</span><span class="p">,</span>
                                    <span class="s">&#39;end type </span><span class="si">%s</span><span class="s">_ptr_type&#39;</span> <span class="o">%</span> <span class="n">tname</span><span class="p">])</span>
                 <span class="n">got_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tname</span><span class="p">)</span>
                          
              <span class="k">if</span> <span class="n">tname</span> <span class="ow">in</span> <span class="n">initlines</span><span class="p">:</span>
                 <span class="n">use</span><span class="p">,</span> <span class="p">(</span><span class="n">exe</span><span class="p">,</span> <span class="n">exe_optional</span><span class="p">)</span> <span class="o">=</span> <span class="n">initlines</span><span class="p">[</span><span class="n">tname</span><span class="p">]</span>
                 <span class="k">if</span> <span class="n">use</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span> <span class="n">uses</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">use</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                 <span class="k">if</span> <span class="s">&#39;optional&#39;</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
                    <span class="n">init</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exe_optional</span> <span class="o">%</span> <span class="p">{</span><span class="s">&#39;OLD_ARG&#39;</span><span class="p">:</span><span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">):],</span> <span class="s">&#39;ARG&#39;</span><span class="p">:</span><span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;PTR&#39;</span><span class="p">:</span><span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s">&#39;_ptr%p&#39;</span><span class="p">})</span>
                 <span class="k">else</span><span class="p">:</span>
                    <span class="n">init</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exe</span> <span class="o">%</span> <span class="p">{</span><span class="s">&#39;OLD_ARG&#39;</span><span class="p">:</span><span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">):],</span> <span class="s">&#39;ARG&#39;</span><span class="p">:</span><span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;PTR&#39;</span><span class="p">:</span><span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s">&#39;_ptr%p&#39;</span><span class="p">})</span>

              <span class="n">ptr_type</span> <span class="o">=</span> <span class="s">&#39;type(</span><span class="si">%s</span><span class="s">_ptr_type)&#39;</span> <span class="o">%</span> <span class="n">tname</span>

              <span class="c"># Preserve original fortran intent</span>
              <span class="n">fintent</span> <span class="o">=</span> <span class="p">[</span> <span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attributes</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;intent&#39;</span><span class="p">)]</span>
              <span class="k">if</span> <span class="n">fintent</span> <span class="o">!=</span> <span class="p">[]:</span> <span class="n">fintent</span> <span class="o">=</span> <span class="n">fintent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;intent&#39;</span><span class="p">,</span> <span class="s">&#39;fintent&#39;</span><span class="p">)</span>

              <span class="k">if</span> <span class="p">(</span><span class="s">&#39;intent(out)&#39;</span> <span class="ow">in</span> <span class="n">attributes</span> <span class="ow">or</span> 
                  <span class="p">((</span><span class="n">sub</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;_initialise&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;_init&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="n">sub</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;_allocate&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> \
                   <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">argnames</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">argnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">prefix</span><span class="o">+</span><span class="s">&#39;this&#39;</span> <span class="ow">and</span> <span class="n">arg</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">prefix</span><span class="o">+</span><span class="s">&#39;this&#39;</span><span class="p">)):</span>
                 <span class="k">if</span> <span class="ow">not</span> <span class="s">&#39;pointer&#39;</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
                    <span class="n">allocates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                 <span class="n">intent</span> <span class="o">=</span> <span class="s">&#39;intent(out)&#39;</span>
                 <span class="n">transfer_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
              <span class="k">else</span><span class="p">:</span>
                 <span class="n">intent</span> <span class="o">=</span> <span class="s">&#39;intent(in)&#39;</span>
                 <span class="n">transfer_in</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;optional&#39;</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">))</span>

              <span class="n">arglines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;integer, </span><span class="si">%s%s</span><span class="s"> :: </span><span class="si">%s</span><span class="s">(</span><span class="si">%d</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">intent</span><span class="p">,</span>
                                                            <span class="p">(</span><span class="s">&#39;optional&#39;</span> <span class="ow">in</span> <span class="n">attributes</span> <span class="ow">and</span> <span class="s">&#39;, optional&#39;</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span><span class="p">),</span>
                                                            <span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">sizeof_fortran_t</span><span class="p">))</span>
              
              <span class="n">arglines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> :: </span><span class="si">%s</span><span class="s">_ptr&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ptr_type</span><span class="p">,</span> <span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
              <span class="n">argnames</span><span class="p">[</span><span class="n">argindex</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">_ptr</span><span class="si">%%</span><span class="s">p&#39;</span> <span class="o">%</span> <span class="n">arg</span><span class="o">.</span><span class="n">name</span>
              <span class="n">append_argline</span> <span class="o">=</span> <span class="bp">False</span>

              
          <span class="k">elif</span> <span class="n">arg</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;character&#39;</span><span class="p">):</span>
              <span class="c"># change from &#39;(len=*)&#39; or &#39;(*)&#39; syntax to *(*) syntax</span>
              <span class="k">try</span><span class="p">:</span>
                  <span class="n">lind</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;(&#39;</span><span class="p">)</span>
                  <span class="n">rind</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">rindex</span><span class="p">(</span><span class="s">&#39;)&#39;</span><span class="p">)</span>
                  <span class="n">mytype</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">type</span><span class="p">[:</span><span class="n">lind</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;*&#39;</span><span class="o">+</span><span class="n">arg</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="n">lind</span><span class="p">:</span><span class="n">rind</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;len=&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
                  <span class="c">#mytype = &#39;character*(*)&#39;</span>

                  <span class="c"># Try to get length of string arguments</span>
                  <span class="k">if</span> <span class="ow">not</span> <span class="n">mytype</span><span class="p">[</span><span class="mi">11</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;*&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">x</span> <span class="ow">in</span> <span class="s">&#39;0123456789&#39;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mytype</span><span class="p">[</span><span class="mi">11</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]):</span>
                      <span class="k">try</span><span class="p">:</span>
                          <span class="n">mytype</span> <span class="o">=</span> <span class="s">&#39;character*(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">string_lengths</span><span class="p">[</span><span class="n">mytype</span><span class="p">[</span><span class="mi">11</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
                      <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                          <span class="n">mytype</span> <span class="o">=</span> <span class="s">&#39;character*(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">string_lengths</span><span class="p">[</span><span class="s">&#39;default&#39;</span><span class="p">]</span>

                  <span class="n">attributes</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;intent&#39;</span><span class="p">)</span> <span class="ow">or</span>
                                      <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;dimension&#39;</span><span class="p">)</span> <span class="ow">or</span>
                                      <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;optional&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;pointer&#39;</span><span class="p">),</span> <span class="n">attributes</span><span class="p">)</span>

                  <span class="c"># Default string length for intent(out) strings </span>
                  <span class="k">if</span> <span class="n">mytype</span><span class="p">[</span><span class="mi">11</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;*&#39;</span> <span class="ow">and</span> <span class="s">&#39;intent(out)&#39;</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
                      <span class="n">mytype</span> <span class="o">=</span> <span class="s">&#39;character*(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">string_lengths</span><span class="p">[</span><span class="s">&#39;default&#39;</span><span class="p">]</span>


              <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                  <span class="n">mytype</span> <span class="o">=</span> <span class="s">&#39;character*(1)&#39;</span>
      
          <span class="n">dims</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;dimension(&#39;</span><span class="p">),</span> <span class="n">attributes</span><span class="p">)</span>
          <span class="k">if</span> <span class="n">dims</span> <span class="o">!=</span> <span class="p">[]:</span>
              <span class="c"># replace dimensions with n1,n2</span>
              <span class="n">dim</span> <span class="o">=</span> <span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">10</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
              <span class="n">br</span> <span class="o">=</span> <span class="mi">0</span>
              <span class="n">d</span> <span class="o">=</span> <span class="mi">1</span>
              <span class="n">ds</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">]</span>
              <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">dim</span><span class="p">:</span>
                  <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="s">&#39;,&#39;</span><span class="p">:</span> <span class="n">ds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">c</span>
                  <span class="k">if</span>   <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;(&#39;</span><span class="p">:</span> <span class="n">br</span> <span class="o">+=</span> <span class="mi">1</span>
                  <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;)&#39;</span><span class="p">:</span> <span class="n">br</span> <span class="o">-=</span> <span class="mi">1</span>
                  <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;,&#39;</span><span class="p">:</span>
                      <span class="k">if</span> <span class="n">br</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">ds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
                      <span class="k">else</span><span class="p">:</span> <span class="n">ds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="s">&#39;,&#39;</span>

              <span class="n">newds</span> <span class="o">=</span> <span class="p">[]</span>
              <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ds</span><span class="p">):</span>
                  <span class="k">if</span> <span class="n">valid_dim_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                      <span class="c">#if &#39;,&#39; in d: ds[i] = d.replace(&#39;size&#39;,&#39;shape&#39;)</span>
                      <span class="k">for</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">old_arg_names</span><span class="p">,</span> <span class="n">argnames</span><span class="p">):</span>
                         <span class="n">ds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span>
                      <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;len&#39;</span><span class="p">):</span>
                          <span class="n">arglines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;!f2py </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">, dimension(</span><span class="si">%s</span><span class="s">) :: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> \
                                              <span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> 
                                               <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;dimension&#39;</span><span class="p">),</span> <span class="n">attributes</span><span class="p">)),</span> 
                                               <span class="n">ds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;len&#39;</span><span class="p">,</span><span class="s">&#39;slen&#39;</span><span class="p">),</span> <span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                      <span class="k">continue</span>
                  <span class="n">ds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">prefix</span><span class="o">+</span><span class="s">&#39;n</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n_dummy</span><span class="p">))</span>
                  <span class="n">newds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                  <span class="n">n_dummy</span> <span class="o">+=</span> <span class="mi">1</span>

              <span class="n">attributes</span><span class="p">[</span><span class="n">attributes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="o">=</span> <span class="s">&#39;dimension(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> \
                                                          <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
              <span class="k">if</span> <span class="s">&#39;allocatable&#39;</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
                  <span class="n">attributes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s">&#39;allocatable&#39;</span><span class="p">)</span>


              <span class="c"># intent(out) arrays of variable size don&#39;t work with f2py</span>
              <span class="c">#if &#39;intent(out)&#39; in attributes:</span>
              <span class="c">#    attributes.remove(&#39;intent(out)&#39;)</span>
              <span class="c">#    attributes.append(&#39;intent(inout)&#39;)</span>

          <span class="n">charflag</span> <span class="o">=</span> <span class="bp">None</span>
          <span class="k">if</span> <span class="n">mytype</span> <span class="o">==</span> <span class="s">&#39;character*(*)&#39;</span> <span class="ow">and</span> <span class="s">&#39;intent(out)&#39;</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
              <span class="n">mytype</span> <span class="o">=</span> <span class="s">&#39;character*(n</span><span class="si">%d</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">n_dummy</span>
              <span class="n">charflag</span> <span class="o">=</span> <span class="s">&#39;n</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">n_dummy</span>
              <span class="n">n_dummy</span> <span class="o">+=</span> <span class="mi">1</span>

          <span class="k">if</span> <span class="n">append_argline</span><span class="p">:</span>
             <span class="k">if</span> <span class="n">attributes</span> <span class="o">==</span> <span class="p">[]:</span>
                <span class="n">arglines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> :: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mytype</span><span class="p">,</span> <span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
             <span class="k">else</span><span class="p">:</span>
                <span class="n">arglines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s"> :: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mytype</span><span class="p">,</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">attributes</span><span class="p">),</span><span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

          <span class="n">f2py_attributes</span> <span class="o">=</span> <span class="n">attributes</span><span class="p">[:]</span>
          <span class="c"># For types, we want the intent of the f2py &#39;pointer&#39;, rather than the real fortran intent</span>
          <span class="c"># We also store the fortran intent as &#39;fintent&#39;, to help with determining which</span>
          <span class="c"># objects are affected by a call.</span>
          <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;type&#39;</span><span class="p">):</span>
              <span class="n">f2py_attributes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">intent</span><span class="p">)</span>
              <span class="n">f2py_attributes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fintent</span><span class="p">)</span>
          <span class="n">args_spec</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s">&#39;doc&#39;</span><span class="p">:</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">doc</span><span class="p">),</span> <span class="s">&#39;name&#39;</span><span class="p">:</span><span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="n">arg</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="s">&#39;attributes&#39;</span><span class="p">:</span> <span class="n">f2py_attributes</span><span class="p">})</span>

          <span class="k">if</span> <span class="n">dims</span> <span class="o">!=</span> <span class="p">[]:</span>
              <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">newds</span><span class="p">):</span>
                  <span class="n">newargnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                  <span class="n">arglines</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;integer :: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">d</span><span class="p">)</span>
                  <span class="k">if</span> <span class="ow">not</span> <span class="s">&#39;intent(out)&#39;</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
                      <span class="n">arglines</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;!f2py intent(hide), depend(</span><span class="si">%s</span><span class="s">) :: </span><span class="si">%s</span><span class="s"> = shape(</span><span class="si">%s</span><span class="s">,</span><span class="si">%d</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
                  <span class="k">else</span><span class="p">:</span>
                      <span class="n">args_spec</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="n">d</span><span class="p">,</span> <span class="s">&#39;doc&#39;</span><span class="p">:</span> <span class="s">&#39;shape(</span><span class="si">%s</span><span class="s">,</span><span class="si">%d</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">i</span><span class="p">),</span> <span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="s">&#39;integer&#39;</span><span class="p">,</span> <span class="s">&#39;attributes&#39;</span><span class="p">:[]})</span>

          <span class="k">if</span> <span class="n">charflag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
              <span class="n">newargnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">charflag</span><span class="p">)</span>
              <span class="n">arglines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;integer :: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">charflag</span><span class="p">)</span>
              <span class="k">if</span> <span class="ow">not</span> <span class="s">&#39;intent(out)&#39;</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
                  <span class="n">arglines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;!f2py intent(hide), depend(</span><span class="si">%s</span><span class="s">) :: </span><span class="si">%s</span><span class="s"> = slen(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">charflag</span><span class="p">,</span> <span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
              <span class="k">else</span><span class="p">:</span>
                  <span class="n">args_spec</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s">&#39;name&#39;</span><span class="p">:</span><span class="n">charflag</span><span class="p">,</span><span class="s">&#39;doc&#39;</span><span class="p">:</span> <span class="s">&#39;slen(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="s">&#39;integer&#39;</span><span class="p">,</span> <span class="s">&#39;attributes&#39;</span><span class="p">:[]})</span>


          <span class="c"># Do not mess around with character*(1) multidimensional arrays</span>
          <span class="k">if</span> <span class="n">mytype</span> <span class="o">==</span> <span class="s">&#39;character*(1)&#39;</span> <span class="ow">and</span> <span class="n">dims</span> <span class="o">!=</span> <span class="p">[]</span> <span class="ow">and</span> <span class="s">&#39;intent(in)&#39;</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
             <span class="n">arglines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;!f2py intent(cache) :: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>


      <span class="c"># prepend each argument with its name so that we can leave out optionals in the middle of argument list</span>
      <span class="k">for</span> <span class="n">argindex</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
          <span class="n">argnames</span><span class="p">[</span><span class="n">argindex</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">):],</span> <span class="n">argnames</span><span class="p">[</span><span class="n">argindex</span><span class="p">])</span>

      <span class="k">def</span> <span class="nf">join_and_split_lines</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">80</span><span class="p">):</span>
          <span class="n">args_str</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
          <span class="n">line</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
          <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[:]</span> <span class="c"># make a copy</span>
          <span class="k">while</span> <span class="n">args</span><span class="p">:</span>
              <span class="n">line</span> <span class="o">+=</span> <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
              <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
                  <span class="n">line</span> <span class="o">+=</span> <span class="s">&#39;, &#39;</span>
              <span class="k">if</span> <span class="n">args</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">max_length</span><span class="p">:</span>
                  <span class="n">args_str</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">&amp;</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">&#39; &#39;</span><span class="o">*</span><span class="p">(</span><span class="n">indent</span><span class="o">+</span><span class="mi">3</span><span class="p">))</span>
                  <span class="n">line</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
          <span class="n">args_str</span> <span class="o">+=</span> <span class="n">line</span>
          <span class="k">return</span> <span class="n">args_str</span>

      <span class="n">println</span><span class="p">(</span><span class="s">&#39;subroutine </span><span class="si">%s%s</span><span class="s">(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">newname</span><span class="p">,</span> <span class="n">join_and_split_lines</span><span class="p">(</span><span class="n">newargnames</span><span class="p">)))</span>
      <span class="n">indent</span> <span class="o">+=</span> <span class="mi">3</span>
      <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">kindlines</span><span class="p">:</span>
         <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;use </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">umod</span><span class="p">)</span> <span class="k">for</span> <span class="n">umod</span> <span class="ow">in</span> <span class="n">uses</span><span class="p">]):</span>
            <span class="n">println</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">umod</span> <span class="ow">in</span> <span class="n">uses</span><span class="p">:</span>
         <span class="n">println</span><span class="p">(</span><span class="s">&#39;use </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">umod</span><span class="p">)</span>
      <span class="n">println</span><span class="p">(</span><span class="s">&#39;implicit none&#39;</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">type_lines</span><span class="p">:</span>
         <span class="n">println</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">arglines</span><span class="p">:</span>
          <span class="n">println</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
      <span class="n">println</span><span class="p">()</span>

      <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">allocates</span><span class="p">:</span> <span class="n">println</span><span class="p">(</span><span class="s">&#39;allocate(</span><span class="si">%s</span><span class="s">_ptr</span><span class="si">%%</span><span class="s">p)&#39;</span> <span class="o">%</span> <span class="n">var</span><span class="p">)</span>

      <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">callbacklines</span><span class="p">:</span> <span class="n">println</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

      <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">optional</span> <span class="ow">in</span> <span class="n">transfer_in</span><span class="p">:</span>
         <span class="k">if</span> <span class="n">optional</span><span class="p">:</span>
            <span class="n">println</span><span class="p">(</span><span class="s">&#39;if (present(</span><span class="si">%s</span><span class="s">)) then&#39;</span> <span class="o">%</span> <span class="n">var</span><span class="p">)</span>
            <span class="n">indent</span> <span class="o">+=</span> <span class="mi">3</span>
            <span class="n">println</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">_ptr = transfer(</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">_ptr)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="n">var</span><span class="p">))</span>
            <span class="n">indent</span> <span class="o">-=</span> <span class="mi">3</span>
            <span class="n">println</span><span class="p">(</span><span class="s">&#39;else&#39;</span><span class="p">)</span>
            <span class="n">indent</span> <span class="o">+=</span> <span class="mi">3</span>
            <span class="n">println</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">_ptr</span><span class="si">%%</span><span class="s">p =&gt; null()&#39;</span> <span class="o">%</span> <span class="n">var</span><span class="p">)</span>
            <span class="n">indent</span> <span class="o">-=</span> <span class="mi">3</span>
            <span class="n">println</span><span class="p">(</span><span class="s">&#39;end if&#39;</span><span class="p">)</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="n">println</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">_ptr = transfer(</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">_ptr)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="n">var</span><span class="p">))</span>

      <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">init</span><span class="p">:</span>
         <span class="n">println</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

      <span class="n">subname</span> <span class="o">=</span> <span class="n">sub_to_interface</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">sub</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

      <span class="k">if</span> <span class="n">subname</span> <span class="o">==</span> <span class="s">&#39;assignment(=)&#39;</span><span class="p">:</span>
         <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">argnames</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
         <span class="n">to_arg</span> <span class="o">=</span> <span class="n">argnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
         <span class="n">to_arg</span> <span class="o">=</span> <span class="n">to_arg</span><span class="p">[</span><span class="n">to_arg</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
         <span class="n">from_arg</span> <span class="o">=</span> <span class="n">argnames</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
         <span class="n">from_arg</span> <span class="o">=</span> <span class="n">from_arg</span><span class="p">[</span><span class="n">from_arg</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
         <span class="n">println</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">to_arg</span><span class="p">,</span> <span class="n">from_arg</span><span class="p">))</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="s">&#39;ret_val&#39;</span><span class="p">):</span>
             <span class="n">argfilt</span> <span class="o">=</span> <span class="p">[</span> <span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">arg</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">argnames</span><span class="p">,</span><span class="n">args</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&#39;is_ret_val&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">arg</span><span class="o">.</span><span class="n">is_ret_val</span><span class="p">)</span> <span class="p">]</span>
             <span class="k">if</span> <span class="n">sub</span><span class="o">.</span><span class="n">ret_val</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;type&#39;</span><span class="p">):</span>
                <span class="n">println</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">_ptr</span><span class="si">%%</span><span class="s">p = </span><span class="si">%s</span><span class="s">(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">ret_val</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">subname</span><span class="p">,</span> <span class="n">join_and_split_lines</span><span class="p">(</span><span class="n">argfilt</span><span class="p">)))</span>                          
             <span class="k">else</span><span class="p">:</span>
                <span class="n">println</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> = </span><span class="si">%s</span><span class="s">(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">ret_val</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">subname</span><span class="p">,</span> <span class="n">join_and_split_lines</span><span class="p">(</span><span class="n">argfilt</span><span class="p">)))</span>
         <span class="k">else</span><span class="p">:</span>
             <span class="n">println</span><span class="p">(</span><span class="s">&#39;call </span><span class="si">%s</span><span class="s">(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">subname</span><span class="p">,</span> <span class="n">join_and_split_lines</span><span class="p">(</span><span class="n">argnames</span><span class="p">)))</span>

      <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">transfer_out</span><span class="p">:</span> <span class="n">println</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> = transfer(</span><span class="si">%s</span><span class="s">_ptr, </span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="n">var</span><span class="p">))</span>


      <span class="k">if</span> <span class="n">sub</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;finalise&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">old_arg_names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">old_arg_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;this&#39;</span><span class="p">:</span>
         <span class="n">println</span><span class="p">(</span><span class="s">&#39;deallocate(</span><span class="si">%s</span><span class="s">this_ptr</span><span class="si">%%</span><span class="s">p)&#39;</span> <span class="o">%</span> <span class="n">prefix</span><span class="p">)</span>

      <span class="n">println</span><span class="p">()</span>

      <span class="n">indent</span> <span class="o">-=</span> <span class="mi">3</span>
      <span class="n">println</span><span class="p">(</span><span class="s">&#39;end subroutine </span><span class="si">%s%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="n">newname</span><span class="p">))</span>
      <span class="n">println</span><span class="p">()</span>


   <span class="c"># add _get_&lt;type&gt; and _set_&lt;type&gt; methods</span>

   <span class="n">numpy_type_map</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;real(dp)&#39;</span><span class="p">:</span><span class="s">&#39;d&#39;</span><span class="p">,</span>
                     <span class="s">&#39;integer&#39;</span><span class="p">:</span><span class="s">&#39;i&#39;</span><span class="p">,</span>
                     <span class="s">&#39;logical&#39;</span><span class="p">:</span><span class="s">&#39;i&#39;</span><span class="p">,</span>
                     <span class="s">&#39;character*(*)&#39;</span><span class="p">:</span><span class="s">&#39;S&#39;</span><span class="p">,</span>
                     <span class="s">&#39;complex(dp)&#39;</span><span class="p">:</span><span class="s">&#39;complex&#39;</span><span class="p">,</span>
                     <span class="s">&#39;real(qp)&#39;</span><span class="p">:</span><span class="s">&#39;float128&#39;</span><span class="p">}</span>

   <span class="n">T_REAL_A</span> <span class="o">=</span> <span class="mi">6</span>
   <span class="n">T_INTEGER_A</span> <span class="o">=</span> <span class="mi">5</span>
   <span class="n">T_CHAR_A</span> <span class="o">=</span> <span class="mi">10</span>
   <span class="n">T_COMPLEX_A</span> <span class="o">=</span> <span class="mi">7</span>
   
   <span class="n">fortran_type_code</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s">&#39;d&#39;</span><span class="p">:</span> <span class="n">T_REAL_A</span><span class="p">,</span>
      <span class="s">&#39;i&#39;</span><span class="p">:</span> <span class="n">T_INTEGER_A</span><span class="p">,</span>
      <span class="s">&#39;S&#39;</span><span class="p">:</span> <span class="n">T_CHAR_A</span><span class="p">,</span>
      <span class="s">&#39;complex&#39;</span><span class="p">:</span> <span class="n">T_COMPLEX_A</span>
      <span class="p">}</span>

   <span class="n">max_type_len</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span><span class="n">numpy_type_map</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

   <span class="n">subnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">subts</span><span class="o">+</span><span class="n">functs</span><span class="p">]</span>
   <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">mod</span><span class="o">.</span><span class="n">types</span><span class="p">:</span>

      <span class="k">if</span> <span class="n">filtertypes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">strip_type</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">in</span> <span class="n">filtertypes</span><span class="p">:</span> <span class="k">continue</span>

      <span class="n">spec</span><span class="p">[</span><span class="n">shortname</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="s">&#39;types&#39;</span><span class="p">][</span><span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;doc&#39;</span><span class="p">:</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">doc</span><span class="p">),</span> <span class="s">&#39;elements&#39;</span><span class="p">:{}}</span>
      <span class="n">args_spec</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="n">shortname</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="s">&#39;types&#39;</span><span class="p">][</span><span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s">&#39;elements&#39;</span><span class="p">]</span>
      <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">elements</span><span class="p">:</span>

          <span class="n">uses</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
          <span class="n">uses</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">type_map</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

          <span class="k">if</span> <span class="n">filtertypes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">el</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;type&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">strip_type</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">type</span><span class="p">)</span> <span class="ow">in</span> <span class="n">filtertypes</span><span class="p">:</span>
             <span class="k">print</span> <span class="s">&#39;Omitting element </span><span class="si">%s</span><span class="s"> as of unwrapped type </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">el</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
             <span class="k">continue</span>

          <span class="c">#f2py misparses arguments that are called &quot;type&quot;</span>
          <span class="n">name</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">name</span>
          <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;thetype&#39;</span>
          <span class="n">mytype</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">type</span>
          <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;character&#39;</span><span class="p">):</span>
              <span class="c"># change from &#39;(len=*)&#39; or &#39;(*)&#39; syntax to *(*) syntax</span>
              <span class="n">mytype</span> <span class="o">=</span> <span class="s">&#39;character*(*)&#39;</span>

          <span class="n">attributes</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">attributes</span><span class="p">[:]</span>
          <span class="n">dim_list</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;dimension&#39;</span><span class="p">),</span> <span class="n">attributes</span><span class="p">)</span>

          <span class="k">if</span> <span class="s">&#39;pointer&#39;</span> <span class="ow">in</span> <span class="n">attributes</span> <span class="ow">and</span> <span class="n">dim_list</span> <span class="o">!=</span> <span class="p">[]:</span> <span class="k">continue</span>
          <span class="k">if</span> <span class="n">mytype</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;type(c_ptr)&#39;</span><span class="p">:</span> <span class="k">continue</span>

          <span class="n">args_spec</span><span class="p">[</span><span class="n">el</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;doc&#39;</span><span class="p">:</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">doc</span><span class="p">),</span> <span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="n">el</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="s">&#39;attributes&#39;</span><span class="p">:</span> <span class="n">attributes</span><span class="p">}</span>

          <span class="c"># If it&#39;s a proper array (not a pointer) let&#39;s write an __array__ routine </span>
          <span class="c"># which returns shape and data location (suitable for constructing</span>
          <span class="c"># a numpy array that shares the same data)</span>

          <span class="k">if</span> <span class="n">mytype</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;type&#39;</span><span class="p">):</span>
              <span class="n">typename</span> <span class="o">=</span> <span class="n">strip_type</span><span class="p">(</span><span class="n">mytype</span><span class="p">)</span>
          <span class="k">elif</span> <span class="n">mytype</span> <span class="ow">in</span> <span class="n">numpy_type_map</span><span class="p">:</span>
              <span class="n">typename</span> <span class="o">=</span> <span class="n">numpy_type_map</span><span class="p">[</span><span class="n">mytype</span><span class="p">]</span>
          <span class="k">else</span><span class="p">:</span>
              <span class="n">typename</span> <span class="o">=</span> <span class="n">mytype</span>

          <span class="k">if</span>  <span class="n">dim_list</span> <span class="o">!=</span> <span class="p">[]:</span>
              <span class="k">if</span> <span class="n">mytype</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;type&#39;</span><span class="p">):</span>
                 <span class="n">tname</span> <span class="o">=</span> <span class="n">strip_type</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                 <span class="n">uses</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">type_map</span><span class="p">[</span><span class="n">typename</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

                 <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dim_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span> <span class="k">continue</span>

                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;subroutine </span><span class="si">%s%s</span><span class="s">__array_getitem__</span><span class="si">%s</span><span class="s">(this, i, the</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">name</span><span class="p">))</span>
                 <span class="n">indent</span> <span class="o">+=</span> <span class="mi">3</span>
                 <span class="c">#println(&#39;use %s, only: imported_%s =&gt; %s&#39; % (type_map[t.name.lower()], t.name, t.name))</span>
                 <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">kindlines</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;use </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">umod</span><span class="p">)</span> <span class="k">for</span> <span class="n">umod</span> <span class="ow">in</span> <span class="n">uses</span><span class="p">]):</span>
                       <span class="n">println</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                 <span class="k">for</span> <span class="n">umod</span> <span class="ow">in</span> <span class="n">uses</span><span class="p">:</span>
                    <span class="n">println</span><span class="p">(</span><span class="s">&#39;use </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">umod</span><span class="p">)</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;implicit none&#39;</span><span class="p">)</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;type </span><span class="si">%s</span><span class="s">_ptr_type&#39;</span> <span class="o">%</span>  <span class="n">tname</span><span class="p">)</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;type(</span><span class="si">%s</span><span class="s">), pointer :: p&#39;</span> <span class="o">%</span> <span class="n">tname</span><span class="p">)</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;end type </span><span class="si">%s</span><span class="s">_ptr_type&#39;</span> <span class="o">%</span> <span class="n">tname</span><span class="p">)</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;integer, intent(in) :: this(</span><span class="si">%d</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">sizeof_fortran_t</span><span class="p">)</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;type(</span><span class="si">%s</span><span class="s">_ptr_type) :: this_ptr&#39;</span> <span class="o">%</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;type </span><span class="si">%s</span><span class="s">_ptr_type&#39;</span> <span class="o">%</span>  <span class="n">strip_type</span><span class="p">(</span><span class="n">mytype</span><span class="p">))</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;type(</span><span class="si">%s</span><span class="s">), pointer :: p&#39;</span> <span class="o">%</span> <span class="n">strip_type</span><span class="p">(</span><span class="n">mytype</span><span class="p">))</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;end type </span><span class="si">%s</span><span class="s">_ptr_type&#39;</span> <span class="o">%</span> <span class="n">strip_type</span><span class="p">(</span><span class="n">mytype</span><span class="p">))</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;integer, intent(in) :: i&#39;</span><span class="p">)</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;integer, intent(out) :: the</span><span class="si">%s</span><span class="s">(</span><span class="si">%d</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">sizeof_fortran_t</span><span class="p">))</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;type(</span><span class="si">%s</span><span class="s">_ptr_type) :: the</span><span class="si">%s</span><span class="s">_ptr&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">typename</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
                 <span class="n">println</span><span class="p">()</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;this_ptr = transfer(this, this_ptr)&#39;</span><span class="p">)</span>

                 <span class="k">if</span> <span class="s">&#39;allocatable&#39;</span> <span class="ow">in</span> <span class="n">el</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
                     <span class="n">println</span><span class="p">(</span><span class="s">&#39;if (allocated(this_ptr</span><span class="si">%%</span><span class="s">p</span><span class="si">%%%s</span><span class="s">)) then&#39;</span> <span class="o">%</span> <span class="n">el</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                     <span class="n">indent</span> <span class="o">+=</span> <span class="mi">3</span>

                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;if (i &lt; 1 .or. i &gt; size(this_ptr</span><span class="si">%%</span><span class="s">p</span><span class="si">%%%s</span><span class="s">)) then&#39;</span> <span class="o">%</span> <span class="n">el</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                 <span class="n">indent</span> <span class="o">+=</span> <span class="mi">3</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;call system_abort(&quot;array index out of range&quot;)&#39;</span><span class="p">)</span>
                 <span class="n">indent</span> <span class="o">-=</span> <span class="mi">3</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;else&#39;</span><span class="p">)</span>
                 <span class="n">indent</span> <span class="o">+=</span> <span class="mi">3</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;the</span><span class="si">%s</span><span class="s">_ptr</span><span class="si">%%</span><span class="s">p =&gt; this_ptr</span><span class="si">%%</span><span class="s">p</span><span class="si">%%%s</span><span class="s">(i)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">el</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;the</span><span class="si">%s</span><span class="s"> = transfer(the</span><span class="si">%s</span><span class="s">_ptr,the</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
                 <span class="n">indent</span> <span class="o">-=</span> <span class="mi">3</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;endif&#39;</span><span class="p">)</span>

                 <span class="k">if</span> <span class="s">&#39;allocatable&#39;</span> <span class="ow">in</span> <span class="n">el</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
                     <span class="n">indent</span> <span class="o">-=</span> <span class="mi">3</span>
                     <span class="n">println</span><span class="p">(</span><span class="s">&#39;else&#39;</span><span class="p">)</span>
                     <span class="n">indent</span> <span class="o">+=</span> <span class="mi">3</span>
                     <span class="n">println</span><span class="p">(</span><span class="s">&#39;call system_abort(&quot;derived type array not allocated&quot;)&#39;</span><span class="p">)</span>
                     <span class="n">indent</span> <span class="o">-=</span> <span class="mi">3</span>
                     <span class="n">println</span><span class="p">(</span><span class="s">&#39;end if&#39;</span><span class="p">)</span>

                 <span class="n">indent</span> <span class="o">-=</span> <span class="mi">3</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;end subroutine </span><span class="si">%s%s</span><span class="s">__array_getitem__</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
                 <span class="n">println</span><span class="p">()</span>
                 <span class="n">args_spec</span><span class="p">[</span><span class="n">el</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s">&#39;array_getitem&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s%s</span><span class="s">__array_getitem__</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;subroutine </span><span class="si">%s%s</span><span class="s">__array_setitem__</span><span class="si">%s</span><span class="s">(this, i, the</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
                 <span class="n">indent</span> <span class="o">+=</span> <span class="mi">3</span>
                 <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">kindlines</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;use </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">umod</span><span class="p">)</span> <span class="k">for</span> <span class="n">umod</span> <span class="ow">in</span> <span class="n">uses</span><span class="p">]):</span>
                       <span class="n">println</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                 <span class="k">for</span> <span class="n">umod</span> <span class="ow">in</span> <span class="n">uses</span><span class="p">:</span>
                    <span class="n">println</span><span class="p">(</span><span class="s">&#39;use </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">umod</span><span class="p">)</span>                 

                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;implicit none&#39;</span><span class="p">)</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;type </span><span class="si">%s</span><span class="s">_ptr_type&#39;</span> <span class="o">%</span>  <span class="n">tname</span><span class="p">)</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;type(</span><span class="si">%s</span><span class="s">), pointer :: p&#39;</span> <span class="o">%</span> <span class="n">tname</span><span class="p">)</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;end type </span><span class="si">%s</span><span class="s">_ptr_type&#39;</span> <span class="o">%</span> <span class="n">tname</span><span class="p">)</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;integer, intent(in) :: this(</span><span class="si">%d</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">sizeof_fortran_t</span><span class="p">)</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;type(</span><span class="si">%s</span><span class="s">_ptr_type) :: this_ptr&#39;</span> <span class="o">%</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;type </span><span class="si">%s</span><span class="s">_ptr_type&#39;</span> <span class="o">%</span>  <span class="n">strip_type</span><span class="p">(</span><span class="n">mytype</span><span class="p">))</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;type(</span><span class="si">%s</span><span class="s">), pointer :: p&#39;</span> <span class="o">%</span> <span class="n">strip_type</span><span class="p">(</span><span class="n">mytype</span><span class="p">))</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;end type </span><span class="si">%s</span><span class="s">_ptr_type&#39;</span> <span class="o">%</span> <span class="n">strip_type</span><span class="p">(</span><span class="n">mytype</span><span class="p">))</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;integer, intent(in) :: i&#39;</span><span class="p">)</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;integer, intent(in) :: the</span><span class="si">%s</span><span class="s">(</span><span class="si">%d</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">sizeof_fortran_t</span><span class="p">))</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;type(</span><span class="si">%s</span><span class="s">_ptr_type) :: the</span><span class="si">%s</span><span class="s">_ptr&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">typename</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
                 <span class="n">println</span><span class="p">()</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;this_ptr = transfer(this, this_ptr)&#39;</span><span class="p">)</span>

                 <span class="k">if</span> <span class="s">&#39;allocatable&#39;</span> <span class="ow">in</span> <span class="n">el</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
                     <span class="n">println</span><span class="p">(</span><span class="s">&#39;if (allocated(this_ptr</span><span class="si">%%</span><span class="s">p</span><span class="si">%%%s</span><span class="s">)) then&#39;</span> <span class="o">%</span> <span class="n">el</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                     <span class="n">indent</span> <span class="o">+=</span> <span class="mi">3</span>

                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;if (i &lt; 1 .or. i &gt; size(this_ptr</span><span class="si">%%</span><span class="s">p</span><span class="si">%%%s</span><span class="s">)) then&#39;</span> <span class="o">%</span> <span class="n">el</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                 <span class="n">indent</span> <span class="o">+=</span> <span class="mi">3</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;call system_abort(&quot;array index out of range&quot;)&#39;</span><span class="p">)</span>
                 <span class="n">indent</span> <span class="o">-=</span> <span class="mi">3</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;else&#39;</span><span class="p">)</span>
                 <span class="n">indent</span> <span class="o">+=</span> <span class="mi">3</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;the</span><span class="si">%s</span><span class="s">_ptr = transfer(the</span><span class="si">%s</span><span class="s">,the</span><span class="si">%s</span><span class="s">_ptr)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;this_ptr</span><span class="si">%%</span><span class="s">p</span><span class="si">%%%s</span><span class="s">(i) = the</span><span class="si">%s</span><span class="s">_ptr</span><span class="si">%%</span><span class="s">p&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">el</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                 <span class="n">indent</span> <span class="o">-=</span> <span class="mi">3</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;endif&#39;</span><span class="p">)</span>

                 <span class="k">if</span> <span class="s">&#39;allocatable&#39;</span> <span class="ow">in</span> <span class="n">el</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
                     <span class="n">indent</span> <span class="o">-=</span> <span class="mi">3</span>
                     <span class="n">println</span><span class="p">(</span><span class="s">&#39;else&#39;</span><span class="p">)</span>
                     <span class="n">indent</span> <span class="o">+=</span> <span class="mi">3</span>
                     <span class="n">println</span><span class="p">(</span><span class="s">&#39;call system_abort(&quot;derived type array not allocated&quot;)&#39;</span><span class="p">)</span>
                     <span class="n">indent</span> <span class="o">-=</span> <span class="mi">3</span>
                     <span class="n">println</span><span class="p">(</span><span class="s">&#39;end if&#39;</span><span class="p">)</span>

                 <span class="n">indent</span> <span class="o">-=</span> <span class="mi">3</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;end subroutine </span><span class="si">%s%s</span><span class="s">__array_setitem__</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
                 <span class="n">println</span><span class="p">()</span>
                 <span class="n">args_spec</span><span class="p">[</span><span class="n">el</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s">&#39;array_setitem&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s%s</span><span class="s">__array_setitem__</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;subroutine </span><span class="si">%s%s</span><span class="s">__array_len__</span><span class="si">%s</span><span class="s">(this, n)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
                 <span class="n">indent</span> <span class="o">+=</span> <span class="mi">3</span>
                 <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">kindlines</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;use </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">umod</span><span class="p">)</span> <span class="k">for</span> <span class="n">umod</span> <span class="ow">in</span> <span class="n">uses</span><span class="p">]):</span>
                       <span class="n">println</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                 <span class="k">for</span> <span class="n">umod</span> <span class="ow">in</span> <span class="n">uses</span><span class="p">:</span>
                    <span class="n">println</span><span class="p">(</span><span class="s">&#39;use </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">umod</span><span class="p">)</span>                 

                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;implicit none&#39;</span><span class="p">)</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;type </span><span class="si">%s</span><span class="s">_ptr_type&#39;</span> <span class="o">%</span>  <span class="n">tname</span><span class="p">)</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;type(</span><span class="si">%s</span><span class="s">), pointer :: p&#39;</span> <span class="o">%</span> <span class="n">tname</span><span class="p">)</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;end type </span><span class="si">%s</span><span class="s">_ptr_type&#39;</span> <span class="o">%</span> <span class="n">tname</span><span class="p">)</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;integer, intent(in) :: this(</span><span class="si">%d</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">sizeof_fortran_t</span><span class="p">)</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;integer, intent(out) :: n&#39;</span><span class="p">)</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;type(</span><span class="si">%s</span><span class="s">_ptr_type) :: this_ptr&#39;</span> <span class="o">%</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                 <span class="n">println</span><span class="p">()</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;this_ptr = transfer(this, this_ptr)&#39;</span><span class="p">)</span>

                 <span class="k">if</span> <span class="s">&#39;allocatable&#39;</span> <span class="ow">in</span> <span class="n">el</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
                     <span class="n">println</span><span class="p">(</span><span class="s">&#39;if (allocated(this_ptr</span><span class="si">%%</span><span class="s">p</span><span class="si">%%%s</span><span class="s">)) then&#39;</span> <span class="o">%</span> <span class="n">el</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                     <span class="n">indent</span> <span class="o">+=</span> <span class="mi">3</span>

                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;n = size(this_ptr</span><span class="si">%%</span><span class="s">p</span><span class="si">%%%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">el</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

                 <span class="k">if</span> <span class="s">&#39;allocatable&#39;</span> <span class="ow">in</span> <span class="n">el</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
                     <span class="n">indent</span> <span class="o">-=</span> <span class="mi">3</span>
                     <span class="n">println</span><span class="p">(</span><span class="s">&#39;else&#39;</span><span class="p">)</span>
                     <span class="n">indent</span> <span class="o">+=</span> <span class="mi">3</span>
                     <span class="n">println</span><span class="p">(</span><span class="s">&#39;n = 0&#39;</span><span class="p">)</span>
                     <span class="n">indent</span> <span class="o">-=</span> <span class="mi">3</span>
                     <span class="n">println</span><span class="p">(</span><span class="s">&#39;end if&#39;</span><span class="p">)</span>

                 <span class="n">indent</span> <span class="o">-=</span> <span class="mi">3</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;end subroutine </span><span class="si">%s%s</span><span class="s">__array_len__</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
                 <span class="n">println</span><span class="p">()</span>
                 <span class="n">args_spec</span><span class="p">[</span><span class="n">el</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s">&#39;array_len&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s%s</span><span class="s">__array_len__</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>                 
                 

              <span class="k">else</span><span class="p">:</span>
                 <span class="n">tname</span> <span class="o">=</span> <span class="n">strip_type</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;subroutine </span><span class="si">%s%s</span><span class="s">__array__</span><span class="si">%s</span><span class="s">(this, nd, dtype, dshape, dloc)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">name</span><span class="p">))</span>
                 <span class="n">indent</span> <span class="o">+=</span> <span class="mi">3</span>
                 <span class="c">#println(&#39;use %s, only: imported_%s =&gt; %s&#39; % (type_map[t.name.lower()], t.name, t.name))</span>
                 <span class="k">for</span> <span class="n">umod</span> <span class="ow">in</span> <span class="n">uses</span><span class="p">:</span>
                    <span class="n">println</span><span class="p">(</span><span class="s">&#39;use </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">umod</span><span class="p">)</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;implicit none&#39;</span><span class="p">)</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;type </span><span class="si">%s</span><span class="s">_ptr_type&#39;</span> <span class="o">%</span>  <span class="n">tname</span><span class="p">)</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;type(</span><span class="si">%s</span><span class="s">), pointer :: p&#39;</span> <span class="o">%</span> <span class="n">tname</span><span class="p">)</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;end type </span><span class="si">%s</span><span class="s">_ptr_type&#39;</span> <span class="o">%</span> <span class="n">tname</span><span class="p">)</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;integer, intent(in) :: this(</span><span class="si">%d</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">sizeof_fortran_t</span><span class="p">)</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;type(</span><span class="si">%s</span><span class="s">_ptr_type) :: this_ptr&#39;</span> <span class="o">%</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;integer, intent(out) :: nd&#39;</span><span class="p">)</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;integer, intent(out) :: dtype&#39;</span><span class="p">)</span>
                 <span class="k">try</span><span class="p">:</span>
                     <span class="n">rank</span> <span class="o">=</span> <span class="n">dim_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
                     <span class="k">if</span> <span class="n">mytype</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;character&#39;</span><span class="p">):</span> <span class="n">rank</span> <span class="o">+=</span> <span class="mi">1</span>
                 <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                     <span class="n">rank</span> <span class="o">=</span> <span class="mi">1</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;integer, dimension(10), intent(out) :: dshape&#39;</span><span class="p">)</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;integer*</span><span class="si">%d</span><span class="s">, intent(out) :: dloc&#39;</span> <span class="o">%</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s">&#39;O&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>
                 <span class="n">println</span><span class="p">()</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;nd = </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">rank</span><span class="p">)</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;dtype = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">fortran_type_code</span><span class="p">[</span><span class="n">typename</span><span class="p">])</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;this_ptr = transfer(this, this_ptr)&#39;</span><span class="p">)</span>
                 <span class="k">if</span> <span class="s">&#39;allocatable&#39;</span> <span class="ow">in</span> <span class="n">el</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
                     <span class="n">println</span><span class="p">(</span><span class="s">&#39;if (allocated(this_ptr</span><span class="si">%%</span><span class="s">p</span><span class="si">%%%s</span><span class="s">)) then&#39;</span> <span class="o">%</span> <span class="n">el</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                     <span class="n">indent</span> <span class="o">+=</span> <span class="mi">3</span>
                 <span class="k">if</span> <span class="n">mytype</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;character&#39;</span><span class="p">):</span>
                     <span class="n">first</span> <span class="o">=</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&#39;1&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rank</span><span class="o">-</span><span class="mi">1</span><span class="p">)])</span>
                     <span class="n">println</span><span class="p">(</span><span class="s">&#39;dshape(1:</span><span class="si">%d</span><span class="s">) = (/len(this_ptr</span><span class="si">%%</span><span class="s">p</span><span class="si">%%%s</span><span class="s">(</span><span class="si">%s</span><span class="s">)), shape(this_ptr</span><span class="si">%%</span><span class="s">p</span><span class="si">%%%s</span><span class="s">)/)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">el</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">el</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                 <span class="k">else</span><span class="p">:</span>
                    <span class="n">println</span><span class="p">(</span><span class="s">&#39;dshape(1:</span><span class="si">%d</span><span class="s">) = shape(this_ptr</span><span class="si">%%</span><span class="s">p</span><span class="si">%%%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">el</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;dloc = loc(this_ptr</span><span class="si">%%</span><span class="s">p</span><span class="si">%%%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">el</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                 <span class="k">if</span> <span class="s">&#39;allocatable&#39;</span> <span class="ow">in</span> <span class="n">el</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
                     <span class="n">indent</span> <span class="o">-=</span> <span class="mi">3</span>
                     <span class="n">println</span><span class="p">(</span><span class="s">&#39;else&#39;</span><span class="p">)</span>
                     <span class="n">indent</span> <span class="o">+=</span> <span class="mi">3</span>
                     <span class="n">println</span><span class="p">(</span><span class="s">&#39;dloc = 0&#39;</span><span class="p">)</span>
                     <span class="n">indent</span> <span class="o">-=</span> <span class="mi">3</span>
                     <span class="n">println</span><span class="p">(</span><span class="s">&#39;end if&#39;</span><span class="p">)</span>

                 <span class="n">indent</span> <span class="o">-=</span> <span class="mi">3</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;end subroutine </span><span class="si">%s%s</span><span class="s">__array__</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
                 <span class="n">args_spec</span><span class="p">[</span><span class="n">el</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s">&#39;array&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s%s</span><span class="s">__array__</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                 <span class="n">println</span><span class="p">()</span>

          <span class="c"># For scalars write get/set routines</span>
          <span class="k">else</span><span class="p">:</span>
              <span class="k">if</span> <span class="n">mytype</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;type&#39;</span><span class="p">):</span>
                  <span class="n">typename</span> <span class="o">=</span> <span class="n">strip_type</span><span class="p">(</span><span class="n">mytype</span><span class="p">)</span>
                  <span class="n">uses</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">type_map</span><span class="p">[</span><span class="n">typename</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
              <span class="k">elif</span> <span class="n">mytype</span> <span class="ow">in</span> <span class="n">numpy_type_map</span><span class="p">:</span>
                  <span class="n">typename</span> <span class="o">=</span> <span class="n">numpy_type_map</span><span class="p">[</span><span class="n">mytype</span><span class="p">]</span>
              <span class="k">else</span><span class="p">:</span>
                  <span class="n">typename</span> <span class="o">=</span> <span class="n">mytype</span>

              <span class="n">println</span><span class="p">(</span><span class="s">&#39;subroutine </span><span class="si">%s%s</span><span class="s">__get__</span><span class="si">%s</span><span class="s">(this, the</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
              <span class="n">indent</span> <span class="o">+=</span> <span class="mi">3</span>
              <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">kindlines</span><span class="p">:</span>
                 <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;use </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">umod</span><span class="p">)</span> <span class="k">for</span> <span class="n">umod</span> <span class="ow">in</span> <span class="n">uses</span><span class="p">]):</span>
                    <span class="n">println</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
              <span class="k">for</span> <span class="n">umod</span> <span class="ow">in</span> <span class="n">uses</span><span class="p">:</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;use </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">umod</span><span class="p">)</span>
              <span class="n">println</span><span class="p">(</span><span class="s">&#39;implicit none&#39;</span><span class="p">)</span>
              <span class="n">println</span><span class="p">(</span><span class="s">&#39;type </span><span class="si">%s</span><span class="s">_ptr_type&#39;</span> <span class="o">%</span>  <span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
              <span class="n">println</span><span class="p">(</span><span class="s">&#39;type(</span><span class="si">%s</span><span class="s">), pointer :: p&#39;</span> <span class="o">%</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
              <span class="n">println</span><span class="p">(</span><span class="s">&#39;end type </span><span class="si">%s</span><span class="s">_ptr_type&#39;</span> <span class="o">%</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
              <span class="k">if</span> <span class="n">mytype</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;type&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">strip_type</span><span class="p">(</span><span class="n">mytype</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;type </span><span class="si">%s</span><span class="s">_ptr_type&#39;</span> <span class="o">%</span>  <span class="n">strip_type</span><span class="p">(</span><span class="n">mytype</span><span class="p">))</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;type(</span><span class="si">%s</span><span class="s">), pointer :: p&#39;</span> <span class="o">%</span> <span class="n">strip_type</span><span class="p">(</span><span class="n">mytype</span><span class="p">))</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;end type </span><span class="si">%s</span><span class="s">_ptr_type&#39;</span> <span class="o">%</span> <span class="n">strip_type</span><span class="p">(</span><span class="n">mytype</span><span class="p">))</span>
              <span class="n">println</span><span class="p">(</span><span class="s">&#39;integer, intent(in)   :: this(</span><span class="si">%d</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">sizeof_fortran_t</span><span class="p">)</span>
              <span class="n">println</span><span class="p">(</span><span class="s">&#39;type(</span><span class="si">%s</span><span class="s">_ptr_type) :: this_ptr&#39;</span> <span class="o">%</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>


              <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;type&#39;</span><span class="p">):</span>

                  <span class="c"># For derived types elements, treat as opaque reference</span>
                  <span class="n">println</span><span class="p">(</span><span class="s">&#39;integer, intent(out) :: the</span><span class="si">%s</span><span class="s">(</span><span class="si">%d</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">sizeof_fortran_t</span><span class="p">))</span>
                  <span class="n">println</span><span class="p">(</span><span class="s">&#39;type(</span><span class="si">%s</span><span class="s">_ptr_type) :: the</span><span class="si">%s</span><span class="s">_ptr&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">typename</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
                  <span class="n">println</span><span class="p">()</span>
                  <span class="n">println</span><span class="p">(</span><span class="s">&#39;this_ptr = transfer(this, this_ptr)&#39;</span><span class="p">)</span>
                  <span class="n">println</span><span class="p">(</span><span class="s">&#39;the</span><span class="si">%s</span><span class="s">_ptr</span><span class="si">%%</span><span class="s">p =&gt; this_ptr</span><span class="si">%%</span><span class="s">p</span><span class="si">%%%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">el</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                  <span class="n">println</span><span class="p">(</span><span class="s">&#39;the</span><span class="si">%s</span><span class="s"> = transfer(the</span><span class="si">%s</span><span class="s">_ptr,the</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>

              <span class="k">else</span><span class="p">:</span>
                  <span class="c"># Return by value</span>
                  <span class="k">if</span> <span class="s">&#39;pointer&#39;</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span> <span class="n">attributes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s">&#39;pointer&#39;</span><span class="p">)</span>

                  <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;character&#39;</span><span class="p">):</span>

                      <span class="c"># change from &#39;(len=*)&#39; or &#39;(*)&#39; syntax to *(*) syntax</span>
                      <span class="k">try</span><span class="p">:</span>
                          <span class="n">lind</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;(&#39;</span><span class="p">)</span>
                          <span class="n">rind</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">rindex</span><span class="p">(</span><span class="s">&#39;)&#39;</span><span class="p">)</span>
                          <span class="n">mytype</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">type</span><span class="p">[:</span><span class="n">lind</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;*&#39;</span><span class="o">+</span><span class="n">el</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="n">lind</span><span class="p">:</span><span class="n">rind</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;len=&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>

                          <span class="c"># Try to get length of string arguments</span>
                          <span class="k">if</span> <span class="ow">not</span> <span class="n">mytype</span><span class="p">[</span><span class="mi">11</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;*&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">x</span> <span class="ow">in</span> <span class="s">&#39;0123456789&#39;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mytype</span><span class="p">[</span><span class="mi">11</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]):</span>
                              <span class="k">try</span><span class="p">:</span>
                                  <span class="n">mytype</span> <span class="o">=</span> <span class="s">&#39;character*(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">string_lengths</span><span class="p">[</span><span class="n">mytype</span><span class="p">[</span><span class="mi">11</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
                              <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                  <span class="n">mytype</span> <span class="o">=</span> <span class="s">&#39;character*(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">string_lengths</span><span class="p">[</span><span class="s">&#39;default&#39;</span><span class="p">]</span>

                          <span class="c"># Default string length for intent(out) strings </span>
                          <span class="k">if</span> <span class="n">mytype</span><span class="p">[</span><span class="mi">11</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;*&#39;</span> <span class="ow">and</span> <span class="s">&#39;intent(out)&#39;</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
                              <span class="n">mytype</span> <span class="o">=</span> <span class="s">&#39;character*(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">string_lengths</span><span class="p">[</span><span class="s">&#39;default&#39;</span><span class="p">]</span>

                      <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                          <span class="k">pass</span>

                  <span class="k">if</span> <span class="n">attributes</span> <span class="o">!=</span> <span class="p">[]:</span>
                      <span class="n">println</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, intent(out) :: the</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mytype</span><span class="p">,</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">attributes</span><span class="p">),</span> <span class="n">name</span><span class="p">))</span>
                  <span class="k">else</span><span class="p">:</span>
                      <span class="n">println</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">, intent(out) :: the</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mytype</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
                  <span class="n">println</span><span class="p">()</span>
                  <span class="n">println</span><span class="p">(</span><span class="s">&#39;this_ptr = transfer(this, this_ptr)&#39;</span><span class="p">)</span>
                  <span class="n">println</span><span class="p">(</span><span class="s">&#39;the</span><span class="si">%s</span><span class="s"> = this_ptr</span><span class="si">%%</span><span class="s">p</span><span class="si">%%%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">el</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

              <span class="n">indent</span> <span class="o">-=</span> <span class="mi">3</span>
              <span class="n">println</span><span class="p">(</span><span class="s">&#39;end subroutine </span><span class="si">%s%s</span><span class="s">__get__</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
              <span class="n">args_spec</span><span class="p">[</span><span class="n">el</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s">&#39;get&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s%s</span><span class="s">__get__</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

              <span class="n">println</span><span class="p">()</span>

              <span class="n">println</span><span class="p">(</span><span class="s">&#39;subroutine </span><span class="si">%s%s</span><span class="s">__set__</span><span class="si">%s</span><span class="s">(this, the</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
              <span class="n">indent</span> <span class="o">+=</span> <span class="mi">3</span>
              <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">kindlines</span><span class="p">:</span>
                 <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;use </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">umod</span><span class="p">)</span> <span class="k">for</span> <span class="n">umod</span> <span class="ow">in</span> <span class="n">uses</span><span class="p">]):</span>
                    <span class="n">println</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
              <span class="k">for</span> <span class="n">umod</span> <span class="ow">in</span> <span class="n">uses</span><span class="p">:</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;use </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">umod</span><span class="p">)</span>                 
              <span class="n">println</span><span class="p">(</span><span class="s">&#39;implicit none&#39;</span><span class="p">)</span>
              <span class="n">println</span><span class="p">(</span><span class="s">&#39;type </span><span class="si">%s</span><span class="s">_ptr_type&#39;</span> <span class="o">%</span>  <span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
              <span class="n">println</span><span class="p">(</span><span class="s">&#39;type(</span><span class="si">%s</span><span class="s">), pointer :: p&#39;</span> <span class="o">%</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
              <span class="n">println</span><span class="p">(</span><span class="s">&#39;end type </span><span class="si">%s</span><span class="s">_ptr_type&#39;</span> <span class="o">%</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
              <span class="k">if</span> <span class="n">mytype</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;type&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">strip_type</span><span class="p">(</span><span class="n">mytype</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;type </span><span class="si">%s</span><span class="s">_ptr_type&#39;</span> <span class="o">%</span>  <span class="n">strip_type</span><span class="p">(</span><span class="n">mytype</span><span class="p">))</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;type(</span><span class="si">%s</span><span class="s">), pointer :: p&#39;</span> <span class="o">%</span> <span class="n">strip_type</span><span class="p">(</span><span class="n">mytype</span><span class="p">))</span>
                 <span class="n">println</span><span class="p">(</span><span class="s">&#39;end type </span><span class="si">%s</span><span class="s">_ptr_type&#39;</span> <span class="o">%</span> <span class="n">strip_type</span><span class="p">(</span><span class="n">mytype</span><span class="p">))</span>
              <span class="n">println</span><span class="p">(</span><span class="s">&#39;integer, intent(in)   :: this(</span><span class="si">%d</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">sizeof_fortran_t</span><span class="p">)</span>
              <span class="n">println</span><span class="p">(</span><span class="s">&#39;type(</span><span class="si">%s</span><span class="s">_ptr_type) :: this_ptr&#39;</span> <span class="o">%</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
              <span class="n">attributes</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">attributes</span><span class="p">[:]</span>

              <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;type&#39;</span><span class="p">):</span>
                  <span class="c"># Set by reference</span>
                  <span class="n">println</span><span class="p">(</span><span class="s">&#39;integer, intent(in) :: the</span><span class="si">%s</span><span class="s">(</span><span class="si">%d</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">sizeof_fortran_t</span><span class="p">))</span>
                  <span class="n">println</span><span class="p">(</span><span class="s">&#39;type(</span><span class="si">%s</span><span class="s">_ptr_type) :: the</span><span class="si">%s</span><span class="s">_ptr&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">typename</span><span class="p">,</span><span class="n">name</span><span class="p">))</span>
                  <span class="n">println</span><span class="p">()</span>
                  <span class="n">println</span><span class="p">(</span><span class="s">&#39;this_ptr = transfer(this, this_ptr)&#39;</span><span class="p">)</span>
                  <span class="n">println</span><span class="p">(</span><span class="s">&#39;the</span><span class="si">%s</span><span class="s">_ptr = transfer(the</span><span class="si">%s</span><span class="s">,the</span><span class="si">%s</span><span class="s">_ptr)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
                  <span class="n">println</span><span class="p">(</span><span class="s">&#39;this_ptr</span><span class="si">%%</span><span class="s">p</span><span class="si">%%%s</span><span class="s"> = the</span><span class="si">%s</span><span class="s">_ptr</span><span class="si">%%</span><span class="s">p&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
                  

              <span class="k">else</span><span class="p">:</span>
                  <span class="c"># Set by value</span>
                  <span class="k">if</span> <span class="n">attributes</span> <span class="o">!=</span> <span class="p">[]:</span>
                      <span class="n">println</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, intent(in) :: the</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mytype</span><span class="p">,</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">attributes</span><span class="p">),</span> <span class="n">name</span><span class="p">))</span>
                  <span class="k">else</span><span class="p">:</span>
                      <span class="n">println</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">, intent(in) :: the</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mytype</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
                  <span class="n">println</span><span class="p">()</span>
                  <span class="n">println</span><span class="p">(</span><span class="s">&#39;this_ptr = transfer(this, this_ptr)&#39;</span><span class="p">)</span>
                  <span class="n">println</span><span class="p">(</span><span class="s">&#39;this_ptr</span><span class="si">%%</span><span class="s">p</span><span class="si">%%%s</span><span class="s"> = the</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>

              <span class="n">indent</span> <span class="o">-=</span> <span class="mi">3</span>
              <span class="n">println</span><span class="p">(</span><span class="s">&#39;end subroutine </span><span class="si">%s%s</span><span class="s">__set__</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
              <span class="n">args_spec</span><span class="p">[</span><span class="n">el</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s">&#39;set&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s%s</span><span class="s">__set__</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
              <span class="n">println</span><span class="p">()</span>

   <span class="n">println</span><span class="p">()</span>

   <span class="k">return</span> <span class="n">spec</span>

</div>
<span class="k">def</span> <span class="nf">filter_source_file</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">is_wrapper</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
   <span class="n">start_sub</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;^(double precision\s+)?\s*(recursive\s+)?(subroutine|function)\s+(\w*)&#39;</span><span class="p">)</span>
   <span class="n">end_sub</span>   <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;^\s*end\s+(subroutine|function)\s*$&#39;</span><span class="p">)</span>

   <span class="n">in_interface</span> <span class="o">=</span> <span class="bp">False</span>
   <span class="n">seen_interfaces</span> <span class="o">=</span> <span class="p">{}</span>
   <span class="n">interface_lines</span> <span class="o">=</span> <span class="p">[]</span>

   <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">infile</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
      <span class="n">sline</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
      <span class="n">start_match</span> <span class="o">=</span> <span class="n">start_sub</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">sline</span><span class="p">)</span>
      <span class="n">end_match</span> <span class="o">=</span> <span class="n">end_sub</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">sline</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">start_match</span><span class="p">:</span>
         <span class="n">last_subroutine</span> <span class="o">=</span> <span class="n">start_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
         <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
      <span class="k">elif</span> <span class="n">end_match</span><span class="p">:</span>
         <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sline</span><span class="p">,</span> <span class="n">last_subroutine</span><span class="p">))</span>
      <span class="k">elif</span> <span class="n">is_wrapper</span> <span class="ow">and</span> <span class="n">sline</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;interface&#39;</span><span class="p">):</span>
         <span class="n">in_interface</span> <span class="o">=</span> <span class="bp">True</span>
         <span class="n">interface_lines</span> <span class="o">=</span> <span class="p">[]</span>
         <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
      <span class="k">elif</span> <span class="n">is_wrapper</span> <span class="ow">and</span> <span class="p">(</span><span class="n">sline</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;end interface&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">sline</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;endinterface&#39;</span><span class="p">)):</span>
         <span class="n">in_interface</span> <span class="o">=</span> <span class="bp">False</span>
         <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
         <span class="k">for</span> <span class="n">interface_line</span> <span class="ow">in</span> <span class="n">interface_lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">interface_line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;#&#39;</span><span class="p">):</span>
               <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">interface_line</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="n">intfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">interface_line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)]</span>
               <span class="k">for</span> <span class="n">intf</span> <span class="ow">in</span> <span class="n">intfs</span><span class="p">:</span>
                  <span class="k">if</span> <span class="n">intf</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen_interfaces</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                     <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;public :: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">intf</span><span class="p">)</span>
                  <span class="n">seen_interfaces</span><span class="p">[</span><span class="n">intf</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="k">elif</span> <span class="n">is_wrapper</span> <span class="ow">and</span> <span class="n">in_interface</span><span class="p">:</span>
         <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
         <span class="k">if</span> <span class="n">sline</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;#&#39;</span><span class="p">):</span>
            <span class="n">interface_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
         <span class="k">elif</span> <span class="n">sline</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;module procedure&#39;</span><span class="p">):</span>
            <span class="n">sline</span> <span class="o">=</span> <span class="n">sline</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s">&#39;module procedure&#39;</span><span class="p">):]</span>
            <span class="k">if</span> <span class="s">&#39;!&#39;</span> <span class="ow">in</span> <span class="n">sline</span><span class="p">:</span> <span class="n">sline</span> <span class="o">=</span> <span class="n">sline</span><span class="p">[:</span><span class="n">sline</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;!&#39;</span><span class="p">)]</span>
            <span class="n">interface_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sline</span><span class="p">)</span>
      <span class="k">elif</span> <span class="n">is_wrapper</span> <span class="ow">and</span> <span class="p">(</span><span class="n">sline</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;private::&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">sline</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;private ::&#39;</span><span class="p">)):</span>
         <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;!</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">line</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        
<span class="k">def</span> <span class="nf">find_public_symbols</span><span class="p">(</span><span class="nb">file</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;Return a list of publically exported symbols in the Fortran module with filename &#39;file&#39;.</span>
<span class="sd">      If the module defaults to public access, we return None.&quot;&quot;&quot;</span>
   <span class="n">data</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
   <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&amp;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
   <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span> <span class="p">]</span>

   <span class="k">if</span> <span class="ow">not</span> <span class="s">&#39;private&#39;</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
      <span class="k">print</span> <span class="s">&#39;module </span><span class="si">%s</span><span class="s"> defaults to public access&#39;</span> <span class="o">%</span> <span class="nb">file</span>
      <span class="k">return</span> <span class="bp">None</span>

   <span class="n">public_lines</span>  <span class="o">=</span> <span class="p">[</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;public&#39;</span><span class="p">)]</span>

   <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
   <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">public_lines</span><span class="p">:</span>
      <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;public&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
      <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;::&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
      <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
      <span class="n">res</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">field</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)])</span>
   <span class="k">return</span> <span class="n">res</span>


<span class="k">def</span> <span class="nf">cmp_nested_dict</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">skip_fields</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;doc&#39;</span><span class="p">]):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Compare two nested dictionaries a and b</span>

<span class="sd">   Return True if they are equivalent, up to differences in keys</span>
<span class="sd">   listed in skip_fields</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="k">for</span> <span class="n">ka</span><span class="p">,</span> <span class="n">kb</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
      <span class="k">if</span> <span class="n">ka</span> <span class="o">!=</span> <span class="n">kb</span><span class="p">:</span>
         <span class="k">return</span> <span class="bp">False</span>
      <span class="k">if</span> <span class="n">ka</span> <span class="ow">in</span> <span class="n">skip_fields</span><span class="p">:</span>
         <span class="k">continue</span>
      <span class="n">va</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">ka</span><span class="p">]</span>
      <span class="n">vb</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">kb</span><span class="p">]</span>
      <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">va</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="n">vb</span><span class="p">):</span>
         <span class="k">return</span> <span class="bp">False</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">va</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
         <span class="k">return</span> <span class="n">cmp_nested_dict</span><span class="p">(</span><span class="n">va</span><span class="p">,</span> <span class="n">vb</span><span class="p">,</span> <span class="n">skip_fields</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="k">return</span> <span class="n">va</span> <span class="o">==</span> <span class="n">vb</span>
         
   <span class="k">return</span> <span class="bp">True</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">quippy  documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2008-2015, James Kermode.
      Last updated on May 28, 2015.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.
    </div>
  </body>
</html>